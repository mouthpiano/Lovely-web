<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日月神電 - 多元評量闖關遊戲</title>
    <!-- 使用 Tailwind CSS 進行快速排版與美化 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 SweetAlert2 讓提示視窗更漂亮 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- 引入 FontAwesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f0f4f8;
            overflow-x: hidden;
        }
        /* 登入畫面背景設定 */
        #login-screen {
            background: url('image32.jpg') no-repeat center center;
            background-size: cover;
            position: relative;
        }
        /* 增加一個遮罩讓文字清楚 */
        #login-screen::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.4); /* 半透明黑底 */
            z-index: 0;
        }
        #login-content {
            position: relative;
            z-index: 1;
        }

        .game-screen {
            display: none; /* 預設隱藏所有頁面 */
            min-height: 100vh;
            padding: 20px;
        }
        .active-screen {
            /* 移除 display: block !important，改由 JS 控制 */
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        /* 簡單機械圖片網格 */
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .machine-item {
            position: relative;
            cursor: pointer;
        }
        .machine-item img {
            width: 100%;
            height: 100px;
            object-fit: contain; /* 確保圖片完整顯示 */
            border: 2px solid transparent;
            border-radius: 8px;
            background-color: white;
        }
        .machine-item.selected img {
            border-color: #3b82f6; /* 選中時藍色邊框 */
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        /* 選取勾勾 - 右上角 */
        .check-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
        }
        .machine-item.selected .check-icon {
            display: flex;
        }
        /* 放大鏡按鈕 - 右下角 */
        .zoom-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #555;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .zoom-btn:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
        }

        /* 圖片放大 Modal 樣式 */
        #image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }
        #image-modal img {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        #image-modal .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        #image-modal .close:hover {
            color: #bbb;
        }

        /* 詳解區域樣式 */
        .review-section {
            text-align: left;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .review-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #cbd5e1;
        }
        .correct-ans { color: #16a34a; font-weight: bold; }
        .wrong-ans { color: #dc2626; font-weight: bold; }
        .student-ans { color: #2563eb; }

        /* 署名樣式 - 登入頁專用 */
        .login-credit-top {
            position: absolute;
            top: 10px;
            right: 15px;
            color: rgba(255,255,255,0.8);
            text-align: right;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 10;
        }
        .login-credit-bottom {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 10;
        }

        /* 署名樣式 - 一般頁面 */
        .page-credit-top {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            margin-bottom: 5px;
            color: #94a3b8; /* slate-400 */
            font-size: 0.75rem;
            text-align: right;
            line-height: 1.2;
        }
        .page-credit-bottom {
            width: 100%;
            text-align: center;
            margin-top: 30px;
            margin-bottom: 10px;
            color: #cbd5e1; /* slate-300 */
            font-size: 0.75rem;
            line-height: 1.2;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- ================= 登入頁面 ================= -->
    <div id="login-screen" class="game-screen active-screen flex items-center justify-center">
        <!-- 登入頁面署名 -->
        <div class="login-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
        <div class="login-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

        <div id="login-content" class="bg-white/95 backdrop-blur-sm p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">日月神電<br><span class="text-xl text-gray-500">科學闖關評量</span></h1>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">班級</label>
                    <input type="text" id="input-class" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="例如：801">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">座號</label>
                    <input type="text" id="input-number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="例如：05">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">姓名</label>
                    <input type="text" id="input-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="請輸入姓名">
                </div>
                <button onclick="startGame()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">開始挑戰</button>
            </div>
            <p class="mt-4 text-xs text-center text-gray-400">請確認資料正確，送出後將無法修改。</p>
        </div>
    </div>

    <!-- ================= 主選單頁面 ================= -->
    <div id="menu-screen" class="game-screen">
        <div class="max-w-4xl mx-auto">
            <!-- 頁面頂端署名 -->
            <div class="page-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

            <header class="flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
                <div>
                    <span class="text-sm text-gray-500">挑戰者</span>
                    <h2 class="text-xl font-bold" id="display-user-info">--</h2>
                </div>
                <div class="text-right">
                    <span class="text-sm text-gray-500">目前進度</span>
                    <div class="font-bold text-indigo-600" id="progress-text">0 / 4 關卡</div>
                </div>
            </header>

            <!-- 預留圖片31位置：主選單背景/橫幅 -->
            <div class="mb-6 w-full h-48 bg-gray-300 rounded-xl overflow-hidden shadow-inner relative group">
                <img src="image31.jpg" onerror="this.src='https://placehold.co/800x300?text=Game+Menu+Image+(Img31)'" class="w-full h-full object-cover" alt="遊戲主畫面">
                <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                    <h2 class="text-4xl text-white font-bold drop-shadow-lg">請選擇關卡開始挑戰</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 第一關卡片 -->
                <div onclick="enterLevel(1)" class="card bg-white p-6 rounded-xl shadow cursor-pointer border-l-4 border-yellow-400 relative overflow-hidden">
                    <div id="badge-l1" class="absolute top-2 right-2 text-green-500 hidden"><i class="fas fa-check-circle fa-2x"></i></div>
                    <h3 class="text-xl font-bold mb-2">第一關：我是工具人</h3>
                    <p class="text-gray-600 text-sm">簡單機械大會考！找出斜面、槓桿與省力裝置。</p>
                </div>

                <!-- 第二關卡片 -->
                <div onclick="enterLevel(2)" class="card bg-white p-6 rounded-xl shadow cursor-pointer border-l-4 border-blue-400 relative overflow-hidden">
                    <div id="badge-l2" class="absolute top-2 right-2 text-green-500 hidden"><i class="fas fa-check-circle fa-2x"></i></div>
                    <h3 class="text-xl font-bold mb-2">第二關：電得你不要不要</h3>
                    <p class="text-gray-600 text-sm">使用 Phet 模擬器，挑戰電路分析！</p>
                </div>

                <!-- 第三關卡片 -->
                <div onclick="enterLevel(3)" class="card bg-white p-6 rounded-xl shadow cursor-pointer border-l-4 border-purple-400 relative overflow-hidden">
                    <div id="badge-l3" class="absolute top-2 right-2 text-green-500 hidden"><i class="fas fa-check-circle fa-2x"></i></div>
                    <h3 class="text-xl font-bold mb-2">第三關：再兩天，寒輔就結束嚕</h3>
                    <p class="text-gray-600 text-sm">天文觀測，2026年2月2日的星空與月相。</p>
                </div>

                <!-- 第四關卡片 -->
                <div onclick="enterLevel(4)" class="card bg-white p-6 rounded-xl shadow cursor-pointer border-l-4 border-teal-400 relative overflow-hidden">
                    <div id="badge-l4" class="absolute top-2 right-2 text-green-500 hidden"><i class="fas fa-check-circle fa-2x"></i></div>
                    <h3 class="text-xl font-bold mb-2">第四關：Happy Winter Vacation</h3>
                    <p class="text-gray-600 text-sm">潮汐預報，2026年1月21日的海邊活動。</p>
                </div>
            </div>

            <button id="btn-final-submit" onclick="submitAllScores()" disabled class="mt-8 w-full bg-gray-400 text-white py-4 rounded-xl font-bold text-xl transition shadow-lg">
                完成所有關卡後解鎖送出成績
            </button>
            
            <!-- 頁面底部署名 -->
            <div class="page-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
        </div>
    </div>

    <!-- ================= 第一關：簡單機械 ================= -->
    <div id="level1-screen" class="game-screen max-w-4xl mx-auto">
        <!-- 頁面頂端署名 -->
        <div class="page-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-600">第一關：我是工具人</h2>
                <button onclick="backToMenu()" class="text-gray-500 hover:text-gray-700">暫離關卡 <i class="fas fa-sign-out-alt"></i></button>
            </div>
            
            <p class="mb-4 bg-yellow-50 p-3 rounded text-sm border border-yellow-200">
                <i class="fas fa-info-circle"></i> 說明：下方共有24種簡單機械圖片，請依照題目要求點選圖片（可複選）。<br>
                <i class="fas fa-search-plus"></i> <span class="font-bold text-gray-600">小撇步：點選圖片右下角的放大鏡可以查看大圖喔！</span><br>
                <span class="text-red-500 font-bold">計分規則：選對 +2 分，選錯 -2 分，應選未選 -1 分。</span>
            </p>

            <!-- 圖片區 -->
            <div class="machine-grid mb-8" id="l1-image-container">
                <!-- JS 會自動生成 24 張圖 -->
            </div>

            <!-- 題目區 -->
            <div class="space-y-8">
                <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">第一題：【斜面】及其變形的簡單機械</h3>
                    <p class="text-sm text-gray-500 mb-2">提示：有 6 個。剪刀的刀面也是斜面。</p>
                    <button onclick="recordSelection(1)" class="bg-blue-100 text-blue-800 px-4 py-2 rounded hover:bg-blue-200 transition text-sm">
                        <i class="fas fa-save"></i> 鎖定這題的選擇
                    </button>
                    <span id="l1-q1-status" class="ml-2 text-sm font-bold text-gray-400">尚未選擇</span>
                </div>

                <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">第二題：【施力點在中間】的槓桿</h3>
                    <p class="text-sm text-gray-500 mb-2">提示：共有 3 個答案。</p>
                    <button onclick="recordSelection(2)" class="bg-blue-100 text-blue-800 px-4 py-2 rounded hover:bg-blue-200 transition text-sm">
                        <i class="fas fa-save"></i> 鎖定這題的選擇
                    </button>
                    <span id="l1-q2-status" class="ml-2 text-sm font-bold text-gray-400">尚未選擇</span>
                </div>

                <div class="pb-4">
                    <h3 class="font-bold text-lg mb-2">第三題：主要目的為【省力】的簡單機械</h3>
                    <p class="text-sm text-gray-500 mb-2">提示：共有 15 個。</p>
                    <button onclick="recordSelection(3)" class="bg-blue-100 text-blue-800 px-4 py-2 rounded hover:bg-blue-200 transition text-sm">
                        <i class="fas fa-save"></i> 鎖定這題的選擇
                    </button>
                    <span id="l1-q3-status" class="ml-2 text-sm font-bold text-gray-400">尚未選擇</span>
                </div>
            </div>

            <hr class="my-6">
            <button onclick="finishLevel(1)" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow">完成第一關</button>
        </div>
        <!-- 頁面底部署名 -->
        <div class="page-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
    </div>

    <!-- ================= 第二關：電學 ================= -->
    <div id="level2-screen" class="game-screen max-w-4xl mx-auto">
        <!-- 頁面頂端署名 -->
        <div class="page-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-600">第二關：電得你不要不要</h2>
                <button onclick="backToMenu()" class="text-gray-500 hover:text-gray-700">暫離關卡 <i class="fas fa-sign-out-alt"></i></button>
            </div>

            <div class="bg-blue-50 p-4 rounded mb-6 text-sm border border-blue-200">
                <p class="mb-2 font-bold"><i class="fas fa-external-link-alt"></i> 輔助工具：</p>
                <a href="https://phet.colorado.edu/sims/html/circuit-construction-kit-dc/latest/circuit-construction-kit-dc_zh_TW.html" target="_blank" class="text-blue-600 underline font-bold text-lg hover:text-blue-800">
                    點此開啟 PhET 電路模擬器
                </a>
                <p class="mt-2 text-gray-600">說明：所有題目上的每顆燈泡皆為相同規格的燈泡。</p>
            </div>

            <!-- 題目容器 -->
            <div class="space-y-6" id="l2-questions">
                
                <!-- Q1 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第一題：電路的總電壓</h3>
                    <img src="image25.jpg" onerror="this.src='https://placehold.co/300x200?text=Image+25'" class="max-w-full h-48 object-contain mb-2 border bg-white">
                    <input type="text" id="l2-q1" class="w-full border p-2 rounded" placeholder="請輸入答案並標示單位 (例如: 12V)">
                </div>

                <!-- Q2 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第二題：電路的總電流</h3>
                    <input type="text" id="l2-q2" class="w-full border p-2 rounded" placeholder="請輸入答案並標示單位">
                </div>

                <!-- Q3 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第三題：C燈泡的電壓</h3>
                    <img src="image26.jpg" onerror="this.src='https://placehold.co/300x200?text=Image+26'" class="max-w-full h-48 object-contain mb-2 border bg-white">
                    <input type="text" id="l2-q3" class="w-full border p-2 rounded" placeholder="請輸入答案並標示單位">
                </div>

                <!-- Q4 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第四題：燈泡的電流</h3>
                    <img src="image27.jpg" onerror="this.src='https://placehold.co/300x200?text=Image+27'" class="max-w-full h-48 object-contain mb-2 border bg-white">
                    <input type="text" id="l2-q4" class="w-full border p-2 rounded" placeholder="請輸入答案並標示單位">
                </div>

                <!-- Q5 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第五題：B燈泡的電阻</h3>
                    <img src="image28.jpg" onerror="this.src='https://placehold.co/300x200?text=Image+28'" class="max-w-full h-48 object-contain mb-2 border bg-white">
                    <input type="text" id="l2-q5" class="w-full border p-2 rounded" placeholder="請輸入答案並標示單位">
                </div>

                <!-- Q6~Q8 共用圖29 -->
                <div class="bg-white border-2 border-blue-100 p-4 rounded">
                    <p class="text-center font-bold text-blue-800 bg-blue-50 p-2 mb-2">以下三題請參考 圖29</p>
                    <div class="flex justify-center">
                        <img src="image29.jpg" onerror="this.src='https://placehold.co/300x200?text=Image+29'" class="max-w-full h-48 object-contain mb-4 border">
                    </div>

                    <div class="mb-4">
                        <h3 class="font-bold mb-2">第六題：任務一、二、三中三顆燈泡，哪顆最亮？</h3>
                        <select id="l2-q6" class="w-full border p-2 rounded">
                            <option value="">請選擇</option>
                            <option value="1">都一樣亮</option>
                            <option value="2">任務一</option>
                            <option value="3">任務二</option>
                            <option value="4">任務三</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">第七題：任務一、二、三中哪一組電池最快沒電？</h3>
                         <select id="l2-q7" class="w-full border p-2 rounded">
                            <option value="">請選擇</option>
                            <option value="1">都一樣</option>
                            <option value="2">任務一</option>
                            <option value="3">任務二</option>
                            <option value="4">任務三</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">第八題：任務一、二、三中哪顆燈泡電壓最小？</h3>
                         <select id="l2-q8" class="w-full border p-2 rounded">
                            <option value="">請選擇</option>
                            <option value="1">都一樣</option>
                            <option value="2">任務一</option>
                            <option value="3">任務二</option>
                            <option value="4">任務三</option>
                        </select>
                    </div>
                </div>

                <!-- Q9~Q11 共用圖30 -->
                <div class="bg-white border-2 border-blue-100 p-4 rounded">
                     <p class="text-center font-bold text-blue-800 bg-blue-50 p-2 mb-2">以下三題請參考 圖30</p>
                     <div class="flex justify-center">
                        <img src="image30.jpg" onerror="this.src='https://placehold.co/300x200?text=Image+30'" class="max-w-full h-48 object-contain mb-4 border">
                    </div>

                    <div class="mb-4">
                        <h3 class="font-bold mb-2">第九題：ABCD皆為相同燈泡，燈泡亮度大小比較為下列何者？</h3>
                        <select id="l2-q9" class="w-full border p-2 rounded">
                            <option value="">請選擇</option>
                            <option value="1">A>B>C>D</option>
                            <option value="2">A=B>C=D</option>
                            <option value="3">A>C>B>D</option>
                            <option value="4">C=D>A=B</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">第十題：A燈泡與C燈泡的電流比值為多少？</h3>
                        <!-- 改為 text 類型以便輸入分數 -->
                        <input type="text" id="l2-q10" class="w-full border p-2 rounded" placeholder="請輸入數字或分數">
                    </div>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">第十一題：B燈泡與D燈泡的電壓比值為多少？</h3>
                        <!-- 改為 text 類型以便輸入分數 -->
                        <input type="text" id="l2-q11" class="w-full border p-2 rounded" placeholder="請輸入數字或分數">
                    </div>
                </div>

            </div>
            
            <hr class="my-6">
            <button onclick="finishLevel(2)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow">完成第二關</button>
        </div>
        <!-- 頁面底部署名 -->
        <div class="page-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
    </div>

    <!-- ================= 第三關：天文 ================= -->
    <div id="level3-screen" class="game-screen max-w-4xl mx-auto">
        <!-- 頁面頂端署名 -->
        <div class="page-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-purple-600">第三關：再兩天，寒輔就結束嚕 !!</h2>
                <button onclick="backToMenu()" class="text-gray-500 hover:text-gray-700">暫離關卡 <i class="fas fa-sign-out-alt"></i></button>
            </div>
             <p class="text-center text-lg font-bold mb-4 bg-purple-100 p-2 rounded text-purple-800">目標日期：2026年2月2日</p>

             <div class="bg-purple-50 p-4 rounded mb-6 text-sm border border-purple-200">
                <p class="mb-2 font-bold"><i class="fas fa-external-link-alt"></i> 參考資料：</p>
                <a href="https://tw.xingbar.com/calendar/wannianli.html" target="_blank" class="text-purple-600 underline font-bold hover:text-purple-800">
                    點選開啟 萬年曆
                </a>
            </div>

            <div class="space-y-6">
                <!-- Q1 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第一題：假設當天台南整天晴朗無雲，太陽東升西落的方位為下列何者？</h3>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="l3-q1" value="1" class="mr-2"> 正東升起，正西落下</label>
                        <label class="flex items-center"><input type="radio" name="l3-q1" value="2" class="mr-2"> 東偏南升起，西偏南落下</label>
                        <label class="flex items-center"><input type="radio" name="l3-q1" value="3" class="mr-2"> 東偏北升起，西偏北落下</label>
                    </div>
                </div>

                <!-- Q2 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第二題：當天台南的晝夜長短比較為下列何者？</h3>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="l3-q2" value="1" class="mr-2"> 晝長夜短</label>
                        <label class="flex items-center"><input type="radio" name="l3-q2" value="2" class="mr-2"> 晝短夜長</label>
                        <label class="flex items-center"><input type="radio" name="l3-q2" value="3" class="mr-2"> 晝夜等長</label>
                        <label class="flex items-center"><input type="radio" name="l3-q2" value="4" class="mr-2"> 永晝</label>
                        <label class="flex items-center"><input type="radio" name="l3-q2" value="5" class="mr-2"> 永夜</label>
                    </div>
                </div>

                <!-- Q3 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第三題：假設當天台南整天晴朗無雲，下列何者是晚上最適合從事的休閒活動？</h3>
                     <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="l3-q3" value="1" class="mr-2"> 賞月</label>
                        <label class="flex items-center"><input type="radio" name="l3-q3" value="2" class="mr-2"> 數星星 (月光影響小)</label>
                        <label class="flex items-center"><input type="radio" name="l3-q3" value="3" class="mr-2"> 去海裡游泳</label>
                    </div>
                </div>

                <!-- Q4 Moon Phase -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-4">第四題：當天的月相最接近下列何者？</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- 選項1：初1 (新月) -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="1" class="mb-2">
                            <div class="w-12 h-12 rounded-full bg-black mb-1 border border-gray-400"></div>
                        </label>
                        <!-- 選項2：初4 (眉月) -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="2" class="mb-2">
                             <!-- SVG 眉月 -->
                            <svg class="w-12 h-12 mb-1" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="48" fill="black" />
                                <path d="M50 2 A 48 48 0 1 1 50 98 A 40 48 0 1 0 50 2" fill="white" transform="rotate(-15, 50, 50)"/>
                            </svg>
                        </label>
                        <!-- 選項3：上弦月 -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="3" class="mb-2">
                            <div class="w-12 h-12 rounded-full bg-black mb-1 border border-gray-400 relative overflow-hidden">
                                <div class="absolute right-0 top-0 w-6 h-12 bg-white"></div>
                            </div>
                        </label>
                        <!-- 選項4：農曆10日 (盈凸) -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="4" class="mb-2">
                            <svg class="w-12 h-12 mb-1" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="48" fill="white" />
                                <path d="M50 2 A 48 48 0 1 1 50 98 A 30 48 0 1 0 50 2" fill="black" transform="rotate(0, 50, 50)"/>
                            </svg>
                        </label>
                        <!-- 選項5：滿月 -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="5" class="mb-2">
                            <div class="w-12 h-12 rounded-full bg-yellow-100 mb-1 border border-gray-400"></div>
                        </label>
                        <!-- 選項6：農曆19日 (虧凸) -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="6" class="mb-2">
                            <svg class="w-12 h-12 mb-1" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="48" fill="white" />
                                <path d="M50 2 A 48 48 0 1 0 50 98 A 30 48 0 1 1 50 2" fill="black" transform="rotate(0, 50, 50)"/>
                            </svg>
                        </label>
                        <!-- 選項7：下弦月 -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="7" class="mb-2">
                             <div class="w-12 h-12 rounded-full bg-white mb-1 border border-gray-400 relative overflow-hidden">
                                <div class="absolute right-0 top-0 w-6 h-12 bg-black"></div>
                            </div>
                        </label>
                         <!-- 選項8：農曆27日 (殘月) -->
                        <label class="cursor-pointer border p-2 rounded hover:bg-gray-200 flex flex-col items-center">
                            <input type="radio" name="l3-q4" value="8" class="mb-2">
                            <svg class="w-12 h-12 mb-1" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="48" fill="black" />
                                <path d="M50 2 A 48 48 0 1 0 50 98 A 40 48 0 1 1 50 2" fill="white" transform="rotate(15, 50, 50)"/>
                            </svg>
                        </label>
                    </div>
                </div>
            </div>

            <hr class="my-6">
            <button onclick="finishLevel(3)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow">完成第三關</button>
        </div>
        <!-- 頁面底部署名 -->
        <div class="page-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
    </div>

    <!-- ================= 第四關：潮汐 ================= -->
    <div id="level4-screen" class="game-screen max-w-4xl mx-auto">
        <!-- 頁面頂端署名 -->
        <div class="page-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-teal-600">第四關：Happy Winter Vacation</h2>
                <button onclick="backToMenu()" class="text-gray-500 hover:text-gray-700">暫離關卡 <i class="fas fa-sign-out-alt"></i></button>
            </div>
            <p class="text-center text-lg font-bold mb-4 bg-teal-100 p-2 rounded text-teal-800">目標日期：2026年1月21日</p>

            <div class="bg-teal-50 p-4 rounded mb-6 text-sm border border-teal-200">
                <p class="mb-2 font-bold"><i class="fas fa-external-link-alt"></i> 參考資料：</p>
                <div class="flex gap-4">
                    <a href="https://tw.xingbar.com/calendar/wannianli.html" target="_blank" class="text-teal-600 underline font-bold hover:text-teal-800">1. 萬年曆</a>
                    <a href="https://www.cwa.gov.tw/V8/C/M/tide.html" target="_blank" class="text-teal-600 underline font-bold hover:text-teal-800">2. 中央氣象局潮汐</a>
                </div>
            </div>

             <div class="space-y-6">
                <!-- Q1 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第一題：根據中央氣象局的潮汐預報數據，【綠島蘭嶼海面】之台東縣綠島，今天潮汐週期為？</h3>
                    <p class="text-xs text-red-500 mb-1">格式：請寫 XX小時XX分 (例如 12小時08分)</p>
                    <input type="text" id="l4-q1" class="w-full border p-2 rounded" placeholder="請依照格式輸入">
                </div>

                <!-- Q2 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第二題：當天綠島遊客最適合進行「潮間帶導覽」的時間為下列何者？</h3>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="l4-q2" value="1" class="mr-2"> 早上 7:30 ~ 8:30</label>
                        <label class="flex items-center"><input type="radio" name="l4-q2" value="2" class="mr-2"> 中午 12:30 ~ 13:30</label>
                        <label class="flex items-center"><input type="radio" name="l4-q2" value="3" class="mr-2"> 晚上 7:00 ~ 8:00</label>
                        <label class="flex items-center"><input type="radio" name="l4-q2" value="4" class="mr-2"> 半夜 4:00 ~ 5:00</label>
                    </div>
                </div>

                <!-- Q3 -->
                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-bold mb-2">第三題：根據中央氣象局的潮汐預報數據，【安平高雄沿海】之台南市安平，今天安平港「大船入港」(滿潮) 最適合的時間為下列何者？</h3>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="radio" name="l4-q3" value="1" class="mr-2"> 清晨 4:30</label>
                        <label class="flex items-center"><input type="radio" name="l4-q3" value="2" class="mr-2"> 中午 11:30</label>
                        <label class="flex items-center"><input type="radio" name="l4-q3" value="3" class="mr-2"> 下午 3:30</label>
                        <label class="flex items-center"><input type="radio" name="l4-q3" value="4" class="mr-2"> 晚上 10:30</label>
                    </div>
                </div>
            </div>

            <hr class="my-6">
            <button onclick="finishLevel(4)" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow">完成第四關</button>
        </div>
        <!-- 頁面底部署名 -->
        <div class="page-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
    </div>

    <!-- ================= 成績結算畫面 ================= -->
    <div id="result-screen" class="game-screen max-w-3xl mx-auto text-center">
        <!-- 頁面頂端署名 -->
        <div class="page-credit-top">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>

        <div class="bg-white rounded-xl shadow-2xl p-10">
            <div class="mb-6 text-yellow-500">
                <i class="fas fa-trophy fa-4x"></i>
            </div>
            <h2 class="text-3xl font-bold mb-4">挑戰完成！</h2>
            <p class="text-gray-600 mb-8">恭喜你完成了日月神電的所有關卡！</p>
            
            <div class="grid grid-cols-2 gap-4 text-left mb-8">
                <div class="bg-gray-100 p-4 rounded">
                    <span class="block text-sm text-gray-500">第一關得分</span>
                    <span class="text-xl font-bold text-yellow-600" id="final-score-l1">--</span>
                </div>
                <div class="bg-gray-100 p-4 rounded">
                    <span class="block text-sm text-gray-500">第二關得分</span>
                    <span class="text-xl font-bold text-blue-600" id="final-score-l2">--</span>
                </div>
                <div class="bg-gray-100 p-4 rounded">
                    <span class="block text-sm text-gray-500">第三關得分</span>
                    <span class="text-xl font-bold text-purple-600" id="final-score-l3">--</span>
                </div>
                <div class="bg-gray-100 p-4 rounded">
                    <span class="block text-sm text-gray-500">第四關得分</span>
                    <span class="text-xl font-bold text-teal-600" id="final-score-l4">--</span>
                </div>
            </div>

            <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200">
                <span class="block text-gray-600 mb-2">總成績</span>
                <span class="text-5xl font-bold text-indigo-700" id="final-total-score">--</span>
            </div>

            <p class="mt-6 text-sm text-gray-400" id="upload-status">成績已自動上傳。</p>

            <!-- 詳解區域 -->
            <div id="review-container" class="review-section hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">作答情形與詳解</h3>
                <div id="review-content"></div>
            </div>

            <button onclick="location.reload()" class="mt-8 bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700">重新挑戰 (給別的同學玩)</button>
        </div>
        <!-- 頁面底部署名 -->
        <div class="page-credit-bottom">Designed by 黃鈺心<br>Gemini Canvas輔助生成</div>
    </div>
    
    <!-- Image Modal -->
    <div id="image-modal" onclick="closeImageModal()">
        <span class="close">&times;</span>
        <img id="modal-img">
    </div>

    <!-- Javascript 邏輯部分 -->
    <script>
        // 你的 Google Apps Script 網址填在這裡
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzsfdK0G0JsXYnutPFTEsE0bDggGVuU_JZzMzaY1W4640s8dDQ_5lX7J7JfPF8yFYDj_w/exec"; 

        // 遊戲狀態
        let userData = {
            class: "",
            number: "",
            name: ""
        };
        
        let progress = {
            level1: false,
            level2: false,
            level3: false,
            level4: false
        };

        let scores = {
            level1: 0,
            level2: 0,
            level3: 0,
            level4: 0
        };

        let level1Selections = {
            q1: [],
            q2: [],
            q3: []
        };
        
        // 用來儲存每一關的作答內容以便顯示詳解
        let userAnswers = {
            level2: {},
            level3: {},
            level4: {}
        };

        // DOM 載入後初始化第一關圖片
        document.addEventListener('DOMContentLoaded', () => {
            initLevel1Images();
        });

        function showScreen(screenId) {
            // 先隱藏所有畫面，強制設為 display: none
            document.querySelectorAll('.game-screen').forEach(el => {
                el.style.display = 'none'; // 增加 inline style 強制隱藏
                el.classList.remove('active-screen');
            });
            
            // 抓取目標畫面
            const target = document.getElementById(screenId);
            if(target) {
                // 如果是登入畫面，使用 flex 以便置中；其他畫面使用 block
                if (screenId === 'login-screen') {
                    target.style.display = 'flex';
                } else {
                    target.style.display = 'block';
                }
                
                // 為了讓 CSS animation 運作，延遲加入 class
                setTimeout(() => {
                    target.classList.add('active-screen');
                }, 10);
                // 強制捲動到最上方
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // 開始遊戲 (登入)
        function startGame() {
            const cls = document.getElementById('input-class').value.trim();
            const num = document.getElementById('input-number').value.trim();
            const name = document.getElementById('input-name').value.trim();

            if (!cls || !num || !name) {
                Swal.fire({ icon: 'warning', title: '資料不完整', text: '請輸入班級、座號與姓名！' });
                return;
            }

            userData = { class: cls, number: num, name: name };
            document.getElementById('display-user-info').innerText = `${cls}班 ${num}號 ${name}`;
            
            // 直接跳轉到主選單，showScreen 會負責把登入畫面隱藏
            showScreen('menu-screen');
        }

        function enterLevel(level) {
            showScreen(`level${level}-screen`);
        }

        function backToMenu() {
            showScreen('menu-screen');
            checkProgress();
        }

        // 更新主選單進度顯示
        function checkProgress() {
            let count = 0;
            if (progress.level1) { count++; document.getElementById('badge-l1').classList.remove('hidden'); }
            if (progress.level2) { count++; document.getElementById('badge-l2').classList.remove('hidden'); }
            if (progress.level3) { count++; document.getElementById('badge-l3').classList.remove('hidden'); }
            if (progress.level4) { count++; document.getElementById('badge-l4').classList.remove('hidden'); }

            document.getElementById('progress-text').innerText = `${count} / 4 關卡`;

            const btn = document.getElementById('btn-final-submit');
            if (count === 4) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-600', 'hover:from-indigo-600', 'hover:to-purple-700', 'transform', 'hover:scale-105');
                btn.innerText = "查看最終成績並上傳";
            }
        }

        // ================= LEVEL 1 LOGIC =================
        function initLevel1Images() {
            const container = document.getElementById('l1-image-container');
            for (let i = 1; i <= 24; i++) {
                const div = document.createElement('div');
                div.className = 'machine-item';
                div.dataset.id = i;
                // Add zoom button with stopPropagation to avoid triggering selection
                div.innerHTML = `
                    <img src="image${i}.jpg" onerror="this.src='https://placehold.co/100x100?text=Img${i}'" alt="圖片${i}">
                    <div class="check-icon"><i class="fas fa-check"></i></div>
                    <div class="zoom-btn" onclick="event.stopPropagation(); showImageModal('image${i}.jpg', this)"><i class="fas fa-search-plus"></i></div>
                `;
                div.onclick = function() {
                    this.classList.toggle('selected');
                };
                container.appendChild(div);
            }
        }
        
        // Image Modal Functions
        function showImageModal(src, btn) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            
            // Try to use the actual source of the img element if it exists (handles placeholders)
            let realSrc = src;
            if(btn) {
                const imgEl = btn.parentElement.querySelector('img');
                if(imgEl) realSrc = imgEl.src;
            }
            
            modal.style.display = "flex";
            modalImg.src = realSrc;
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = "none";
        }

        // 鎖定選擇 (暫存，不計分，僅供紀錄)
        function recordSelection(qNum) {
            const selectedEls = document.querySelectorAll('.machine-item.selected');
            const selectedIds = Array.from(selectedEls).map(el => parseInt(el.dataset.id));
            
            if (selectedIds.length === 0) {
                Swal.fire({ icon: 'info', title: '未選擇', text: '請至少點選一張圖片' });
                return;
            }

            if (qNum === 1) level1Selections.q1 = selectedIds;
            if (qNum === 2) level1Selections.q2 = selectedIds;
            if (qNum === 3) level1Selections.q3 = selectedIds;

            document.getElementById(`l1-q${qNum}-status`).innerText = `已選擇 ${selectedIds.length} 張圖片`;
            document.getElementById(`l1-q${qNum}-status`).classList.remove('text-gray-400');
            document.getElementById(`l1-q${qNum}-status`).classList.add('text-blue-600');

            // 清除畫面上的選取狀態，準備給下一題選
            document.querySelectorAll('.machine-item').forEach(el => el.classList.remove('selected'));
            Swal.fire({ icon: 'success', title: '已暫存', text: `第 ${qNum} 題選擇已紀錄，請繼續下一題`, timer: 1500, showConfirmButton: false });
        }

        // L1 新計分邏輯: 選對+2, 選錯-2, 未選-1
        function calculateL1Score(userSelection, correctSelection) {
            let score = 0;
            // 比對每個正確答案
            correctSelection.forEach(ans => {
                if (userSelection.includes(ans)) {
                    score += 2; // 選對
                } else {
                    score -= 1; // 應選未選
                }
            });

            // 比對用戶選的，如果有選錯的
            userSelection.forEach(sel => {
                if (!correctSelection.includes(sel)) {
                    score -= 2; // 選錯
                }
            });
            return score;
        }

        function finishLevel(level) {
            if (level === 1) {
                // 檢查是否都回答了
                if(level1Selections.q1.length === 0 || level1Selections.q2.length === 0 || level1Selections.q3.length === 0) {
                     Swal.fire({ icon: 'warning', title: '尚未完成', text: '請確保三題都已按下「鎖定這題的選擇」' });
                     return;
                }

                let score = 0;
                // Q1
                score += calculateL1Score(level1Selections.q1, [1,4,19,20,21,22]);
                // Q2
                score += calculateL1Score(level1Selections.q2, [9,10,12]);
                // Q3
                score += calculateL1Score(level1Selections.q3, [1,2,3,6,7,8,11,13,14,19,20,21,22,23,24]);

                scores.level1 = score;
                progress.level1 = true;
            } 
            else if (level === 2) {
                // L2 計分
                let score = 0;
                
                // 讀取作答
                const getVal = (id) => document.getElementById(id).value.trim();
                const checkStr = (val, ansArr) => ansArr.some(a => val.toLowerCase().replace(/\s/g, '') === a.toLowerCase().replace(/\s/g, ''));
                
                // 儲存作答以供回顧
                userAnswers.level2 = {
                    q1: getVal('l2-q1'), q2: getVal('l2-q2'), q3: getVal('l2-q3'), q4: getVal('l2-q4'), q5: getVal('l2-q5'),
                    q6: getVal('l2-q6'), q7: getVal('l2-q7'), q8: getVal('l2-q8'), q9: getVal('l2-q9'), q10: getVal('l2-q10'), q11: getVal('l2-q11')
                };

                // Q1: 9V, 9.0V, 9.00V
                if(checkStr(userAnswers.level2.q1, ['9v', '9伏特', '9.0v', '9.00v'])) score += 2;
                
                // Q2: 0.9A, 0.90A
                if(checkStr(userAnswers.level2.q2, ['0.9a', '0.9安培', '0.90a', '0.90安培'])) score += 2;
                
                // Q3: 9V
                if(checkStr(userAnswers.level2.q3, ['9v', '9伏特', '9.0v', '9.00v'])) score += 2;
                
                // Q4: 0.9A, 0.90A
                if(checkStr(userAnswers.level2.q4, ['0.9a', '0.9安培', '0.90a', '0.90安培'])) score += 2;
                
                // Q5: 10歐姆, 10.0, 10.00
                if(checkStr(userAnswers.level2.q5, ['10歐姆', '10ω', '10ohm', '10.0歐姆', '10.00歐姆', '10.0ω'])) score += 2;
                
                if(userAnswers.level2.q6 == '4') score += 3; 
                if(userAnswers.level2.q7 == '4') score += 3;
                if(userAnswers.level2.q8 == '3') score += 3;
                if(userAnswers.level2.q9 == '2') score += 2;
                
                // Q10, Q11: 答案是 2，因為是文字框，我們接受 "2"
                if(checkStr(userAnswers.level2.q10, ['2'])) score += 2; 
                if(checkStr(userAnswers.level2.q11, ['2'])) score += 2;

                scores.level2 = score;
                progress.level2 = true;
            }
            else if (level === 3) {
                // L3 計分
                let score = 0;
                
                const getRadio = (name) => {
                    const el = document.querySelector(`input[name="${name}"]:checked`);
                    return el ? el.value : "未作答";
                };

                userAnswers.level3 = {
                    q1: getRadio('l3-q1'), q2: getRadio('l3-q2'), q3: getRadio('l3-q3'), q4: getRadio('l3-q4')
                };

                if(userAnswers.level3.q1 === '2') score += 6;
                if(userAnswers.level3.q2 === '2') score += 6;
                if(userAnswers.level3.q3 === '1') score += 6;
                if(userAnswers.level3.q4 === '5') score += 7;

                scores.level3 = score;
                progress.level3 = true;
            }
            else if (level === 4) {
                // L4 計分
                let score = 0;
                const getRadio = (name) => {
                    const el = document.querySelector(`input[name="${name}"]:checked`);
                    return el ? el.value : "未作答";
                };

                userAnswers.level4 = {
                    q1: document.getElementById('l4-q1').value.trim(),
                    q2: getRadio('l4-q2'),
                    q3: getRadio('l4-q3')
                };

                if(userAnswers.level4.q1 === "11小時32分" || userAnswers.level4.q1 === "11小時48分") score += 9;
                if(userAnswers.level4.q2 === '2') score += 8;
                if(userAnswers.level4.q3 === '2') score += 8;

                scores.level4 = score;
                progress.level4 = true;
            }

            Swal.fire({
                icon: 'success',
                title: '關卡完成！',
                text: '已保存此關卡進度，請繼續挑戰其他關卡。',
                confirmButtonText: '回到主選單'
            }).then(() => {
                backToMenu();
            });
        }

        // 最終提交
        function submitAllScores() {
            const totalScore = scores.level1 + scores.level2 + scores.level3 + scores.level4;
            
            // 顯示成績畫面
            document.getElementById('final-score-l1').innerText = scores.level1;
            document.getElementById('final-score-l2').innerText = scores.level2;
            document.getElementById('final-score-l3').innerText = scores.level3;
            document.getElementById('final-score-l4').innerText = scores.level4;
            document.getElementById('final-total-score').innerText = totalScore;
            
            showScreen('result-screen');
            
            // 產生詳解
            renderReview();
            document.getElementById('review-container').classList.remove('hidden');

            // 準備上傳資料
            const payload = {
                studentClass: userData.class,
                studentNumber: userData.number,
                studentName: userData.name,
                totalScore: totalScore,
                scores: scores
            };

            // 上傳到 Google Sheets
            if(googleScriptUrl.includes("GOOGLE_APPS_SCRIPT")) {
                document.getElementById('upload-status').innerText = "⚠️ 尚未設定 Google Script 網址，成績無法上傳，請通知老師。";
            } else {
                document.getElementById('upload-status').innerText = "正在上傳成績...";
                
                fetch(googleScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // 重要：避免 CORS 錯誤，雖然拿不到回應內容，但資料會送出
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                }).then(() => {
                    document.getElementById('upload-status').innerText = "✅ 成績上傳成功！";
                    Swal.fire('太棒了！', '成績已成功傳送給老師，下方有詳解可供參考。', 'success');
                }).catch(err => {
                    console.error(err);
                    document.getElementById('upload-status').innerText = "❌ 上傳失敗，請截圖此畫面給老師。";
                });
            }
        }

        // 產生詳解 HTML
        function renderReview() {
            const container = document.getElementById('review-content');
            let html = '';

            // Helper
            const fmt = (q, user, ans, isCorrect) => `
                <div class="review-item">
                    <p class="font-bold">${q}</p>
                    <p>你的答案：<span class="${isCorrect ? 'correct-ans' : 'wrong-ans'}">${user || '未作答'}</span></p>
                    ${!isCorrect ? `<p>正確答案：<span class="correct-ans">${ans}</span></p>` : ''}
                </div>`;
            
            // L1
            html += `<h4 class="font-bold text-lg mt-4 text-yellow-600">第一關：簡單機械</h4>`;
            html += `<p class="text-sm text-gray-500 mb-2">正確圖片編號對照：</p>`;
            
            const l1Q1Ans = [1,4,19,20,21,22].join(", ");
            const l1Q2Ans = [9,10,12].join(", ");
            const l1Q3Ans = [1,2,3,6,7,8,11,13,14,19,20,21,22,23,24].join(", ");

            html += `<div class="bg-white p-2 rounded border mb-2"><p>Q1 斜面: ${l1Q1Ans}</p><p class="text-xs text-blue-500">你選了: ${level1Selections.q1.join(", ") || "無"}</p></div>`;
            html += `<div class="bg-white p-2 rounded border mb-2"><p>Q2 中間施力: ${l1Q2Ans}</p><p class="text-xs text-blue-500">你選了: ${level1Selections.q2.join(", ") || "無"}</p></div>`;
            html += `<div class="bg-white p-2 rounded border mb-2"><p>Q3 省力: ${l1Q3Ans}</p><p class="text-xs text-blue-500">你選了: ${level1Selections.q3.join(", ") || "無"}</p></div>`;

            // L2
            html += `<h4 class="font-bold text-lg mt-4 text-blue-600">第二關：電路</h4>`;
            const checkL2 = (val, ans) => ans.includes(val.toLowerCase().replace(/\s/g, ''));
            const l2 = userAnswers.level2;
            
            html += fmt("Q1 總電壓", l2.q1, "9V", checkL2(l2.q1, ['9v','9伏特','9.0v','9.00v']));
            html += fmt("Q2 總電流", l2.q2, "0.9A", checkL2(l2.q2, ['0.9a','0.9安培','0.90a']));
            html += fmt("Q3 C燈泡電壓", l2.q3, "9V", checkL2(l2.q3, ['9v','9伏特','9.0v','9.00v']));
            html += fmt("Q4 電流", l2.q4, "0.9A", checkL2(l2.q4, ['0.9a','0.9安培','0.90a']));
            html += fmt("Q5 電阻", l2.q5, "10歐姆", checkL2(l2.q5, ['10歐姆','10ω', '10.0歐姆']));
            
            const optMap = { '1': '選項1', '2': '選項2', '3': '選項3', '4': '選項4' };
            html += fmt("Q6 哪顆最亮", optMap[l2.q6], "任務三 (4)", l2.q6 == '4');
            html += fmt("Q7 誰最快沒電", optMap[l2.q7], "任務三 (4)", l2.q7 == '4');
            html += fmt("Q8 誰電壓最小", optMap[l2.q8], "任務二 (3)", l2.q8 == '3');
            html += fmt("Q9 亮度比較", optMap[l2.q9], "A=B>C=D (2)", l2.q9 == '2');
            html += fmt("Q10 電流比值", l2.q10, "2", l2.q10 == '2');
            html += fmt("Q11 電壓比值", l2.q11, "2", l2.q11 == '2');

            // L3
            html += `<h4 class="font-bold text-lg mt-4 text-purple-600">第三關：天文</h4>`;
            const l3 = userAnswers.level3;
            html += fmt("Q1 太陽方位", optMap[l3.q1], "東偏南升起... (2)", l3.q1 == '2');
            html += fmt("Q2 晝夜長短", optMap[l3.q2], "晝短夜長 (2)", l3.q2 == '2');
            html += fmt("Q3 晚上休閒", optMap[l3.q3], "賞月 (1)", l3.q3 == '1');
            html += fmt("Q4 月相", `選項${l3.q4}`, "滿月 (5)", l3.q4 == '5');

            // L4
            html += `<h4 class="font-bold text-lg mt-4 text-teal-600">第四關：潮汐</h4>`;
            const l4 = userAnswers.level4;
            html += fmt("Q1 潮汐週期", l4.q1, "11小時32分 或 11小時48分", (l4.q1=="11小時32分"||l4.q1=="11小時48分"));
            html += fmt("Q2 潮間帶導覽", optMap[l4.q2], "中午 12:30... (2)", l4.q2 == '2');
            html += fmt("Q3 大船入港", optMap[l4.q3], "中午 11:30 (2)", l4.q3 == '2');

            container.innerHTML = html;
        }

    </script>
</body>
</html>