<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>縮小燈大冒險：個人練習版</title>
    <!-- 引入 Tailwind CSS (用於樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-amber-50 no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 圖示組件 (SVG Icons) ---
        const Play = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const MousePointerClick = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 9 5 12 1.8-5.2L21 14 9 9z"/><path d="M12 12v6"/><path d="m13 13 4 4"/></svg>
        );
        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const ChevronRight = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>
        );
        const BarChart = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        );
        const Search = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        );
        const XCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        );
        const BookOpen = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        );
        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
        );

        // --- 資料結構與題庫 (與正式版完全相同) ---

        const ATOM_TYPES = {
            H: { color: 'bg-gray-100 border-gray-400 text-gray-500', label: '氫' },
            O: { color: 'bg-red-500 border-red-700 text-white', label: '氧' },
            C: { color: 'bg-gray-900 border-gray-700 text-white', label: '碳' },
        };

        const MODEL_OPTIONS = [
            { id: 'opt_2H', type: '2H', description: '兩顆分開的氫原子' },
            { id: 'opt_2H2', type: '2H₂', description: '兩個氫分子' },
            { id: 'opt_CO2', type: 'CO₂', description: '二氧化碳分子' },
            { id: 'opt_H2O', type: 'H₂O', description: '水分子' },
            { id: 'opt_O', type: 'O', description: '氧原子' },
            { id: 'opt_O2', type: 'O₂', description: '氧分子' },
            { id: 'opt_2H2O', type: '2H₂O', description: '兩個水分子' },
            { id: 'opt_Mix', type: 'H₂+CO₂', description: '氫氣與二氧化碳混合' }
        ];

        const QUESTIONS = [
            {
                id: 'q1',
                symbol: '2H',
                correctModelId: 'opt_2H',
                correct: { count: 2, name: '氫原子', category: '元素', purity: '純物質', composition: { totalAtoms: 2, atomTypes: 1, moleculeCount: 0, moleculeTypes: 0 } }
            },
            {
                id: 'q2',
                symbol: '2H₂',
                correctModelId: 'opt_2H2',
                correct: { count: 2, name: '氫分子', category: '元素', purity: '純物質', composition: { totalAtoms: 4, atomTypes: 1, moleculeCount: 2, moleculeTypes: 1 } }
            },
            {
                id: 'q3',
                symbol: 'CO₂',
                correctModelId: 'opt_CO2',
                correct: { count: 1, name: '二氧化碳分子', category: '化合物', purity: '純物質', composition: { totalAtoms: 3, atomTypes: 2, moleculeCount: 1, moleculeTypes: 1 } }
            },
            {
                id: 'q4',
                symbol: 'H₂O',
                correctModelId: 'opt_H2O',
                correct: { count: 1, name: '水分子', category: '化合物', purity: '純物質', composition: { totalAtoms: 3, atomTypes: 2, moleculeCount: 1, moleculeTypes: 1 } }
            },
            {
                id: 'q5',
                symbol: 'O',
                correctModelId: 'opt_O',
                correct: { count: 1, name: '氧原子', category: '元素', purity: '純物質', composition: { totalAtoms: 1, atomTypes: 1, moleculeCount: 0, moleculeTypes: 0 } }
            },
            {
                id: 'q6',
                symbol: 'O₂',
                correctModelId: 'opt_O2',
                correct: { count: 1, name: '氧分子', category: '元素', purity: '純物質', composition: { totalAtoms: 2, atomTypes: 1, moleculeCount: 1, moleculeTypes: 1 } }
            },
            {
                id: 'q7',
                symbol: '2H₂O',
                correctModelId: 'opt_2H2O',
                correct: { count: 2, name: '水分子', category: '化合物', purity: '純物質', composition: { totalAtoms: 6, atomTypes: 2, moleculeCount: 2, moleculeTypes: 1 } }
            },
            {
                id: 'q8',
                symbol: 'H₂ + CO₂',
                correctModelId: 'opt_Mix',
                correct: { count: 2, name: '混合物(有幾個物質)', category: '不適用', purity: '混合物', composition: { totalAtoms: 5, atomTypes: 3, moleculeCount: 2, moleculeTypes: 2 } }
            }
        ];

        // --- 組件 ---

        const AtomCircle = ({ type, size }) => {
            const styles = ATOM_TYPES[type];
            let finalSize = size;
            if (!finalSize) {
                finalSize = type === 'H' ? 'sm' : 'lg';
            }
            const sizeClass = finalSize === 'lg' ? 'w-10 h-10' : 'w-7 h-7';
            const textSize = finalSize === 'lg' ? 'text-[10px]' : 'text-[8px]';
            return (
                <div className={`${sizeClass} ${styles.color} rounded-full border-2 flex items-center justify-center shadow-md z-10 ${textSize} font-bold shrink-0`}></div>
            );
        };

        const ModelRenderer = ({ type, scale = 1 }) => {
            const scaleClass = scale === 0.5 ? 'transform scale-50 origin-center' : '';
            const renderContent = () => {
                if (type === '2H') return <div className="flex gap-4 items-center justify-center"><AtomCircle type="H" /><AtomCircle type="H" /></div>;
                if (type === '2H₂') return <div className="flex gap-4 items-center justify-center"><div className="flex -space-x-2"><AtomCircle type="H" /><AtomCircle type="H" /></div><div className="flex -space-x-2"><AtomCircle type="H" /><AtomCircle type="H" /></div></div>;
                if (type === 'CO₂') return <div className="flex items-center -space-x-2"><AtomCircle type="O" /><AtomCircle type="C" /><AtomCircle type="O" /></div>;
                if (type === 'H₂O') return <div className="relative w-12 h-12 flex justify-center items-center"><div className="absolute top-0"><AtomCircle type="O"/></div><div className="absolute bottom-0 left-0 transform -translate-x-1"><AtomCircle type="H"/></div><div className="absolute bottom-0 right-0 transform translate-x-1"><AtomCircle type="H"/></div></div>;
                if (type === 'O') return <div className="flex justify-center"><AtomCircle type="O" /></div>;
                if (type === 'O₂') return <div className="flex justify-center -space-x-2"><AtomCircle type="O" /><AtomCircle type="O" /></div>;
                if (type === '2H₂O') return <div className="flex gap-2 justify-center"><div className="relative w-12 h-12 flex justify-center items-center"><div className="absolute top-0"><AtomCircle type="O"/></div><div className="absolute bottom-0 left-0 transform -translate-x-1"><AtomCircle type="H"/></div><div className="absolute bottom-0 right-0 transform translate-x-1"><AtomCircle type="H"/></div></div><div className="relative w-12 h-12 flex justify-center items-center"><div className="absolute top-0"><AtomCircle type="O"/></div><div className="absolute bottom-0 left-0 transform -translate-x-1"><AtomCircle type="H"/></div><div className="absolute bottom-0 right-0 transform translate-x-1"><AtomCircle type="H"/></div></div></div>;
                if (type === 'H₂+CO₂') return <div className="flex gap-3 items-center justify-center"><div className="flex -space-x-2"><AtomCircle type="H" /><AtomCircle type="H" /></div><div className="flex items-center -space-x-2"><AtomCircle type="O" /><AtomCircle type="C" /><AtomCircle type="O" /></div></div>;
                return null;
            };
            return <div className={scaleClass}>{renderContent()}</div>;
        };

        const ReviewRow = ({ label, user, correct }) => {
            const isCorrect = String(user).trim() === String(correct).trim();
            return (
                <tr>
                    <td className="py-2 text-gray-600 font-medium">{label}</td>
                    <td className={`py-2 font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>{user}</td>
                    <td className="py-2 text-gray-500">{correct}</td>
                </tr>
            );
        };

        // --- 主應用程式 ---
        function App() {
            const [step, setStep] = useState('login'); 
            const [studentName, setStudentName] = useState(''); // 簡化：只存名字
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [answers, setAnswers] = useState({}); 
            const [gameQuestions, setGameQuestions] = useState([]); // 新增：用於儲存當次隨機排序的題目

            const [currentInput, setCurrentInput] = useState({
                selectedModelId: '',
                count: '',
                name: '',
                category: '',
                purity: '',
                totalAtoms: '',
                atomTypes: '',
                moleculeCount: '',
                moleculeTypes: ''
            });

            useEffect(() => {
                setCurrentInput({
                    selectedModelId: '',
                    count: '',
                    name: '',
                    category: '',
                    purity: '',
                    totalAtoms: '',
                    atomTypes: '',
                    moleculeCount: '',
                    moleculeTypes: ''
                });
            }, [currentQIndex]);

            // 洗牌函式 (Fisher-Yates shuffle)
            const shuffleQuestions = (array) => {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            };

            const handleStart = () => {
                if (studentName.trim()) {
                    // 開始前先洗牌
                    const randomized = shuffleQuestions(QUESTIONS);
                    setGameQuestions(randomized);
                    setStep('game');
                } else {
                    alert('請輸入你的名字或暱稱');
                }
            };

            const handleNext = () => {
                const q = gameQuestions[currentQIndex]; // 使用打亂後的題目
                let correctPoints = 0;
                
                if (currentInput.selectedModelId === q.correctModelId) correctPoints += 5;
                if (parseInt(currentInput.count) === q.correct.count) correctPoints += 1;
                if (currentInput.name === q.correct.name) correctPoints += 1;
                if (currentInput.category === q.correct.category) correctPoints += 1;
                if (currentInput.purity === q.correct.purity) correctPoints += 1;
                if (parseInt(currentInput.totalAtoms) === q.correct.composition.totalAtoms) correctPoints += 1;
                if (parseInt(currentInput.atomTypes) === q.correct.composition.atomTypes) correctPoints += 1;
                if (parseInt(currentInput.moleculeCount) === q.correct.composition.moleculeCount) correctPoints += 1;
                if (parseInt(currentInput.moleculeTypes) === q.correct.composition.moleculeTypes) correctPoints += 1;

                setAnswers(prev => ({
                    ...prev,
                    [q.id]: {
                        symbol: q.symbol,
                        user: currentInput,
                        correctModel: q.correctModelId,
                        correctData: q.correct,
                        points: correctPoints,
                        maxPoints: 13
                    }
                }));

                if (currentQIndex < gameQuestions.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                } else {
                    setTimeout(() => setStep('result'), 500);
                }
            };

            const totalUserPoints = Object.values(answers).reduce((acc, curr) => acc + curr.points, 0);
            const finalScore = totalUserPoints; 

            // --- 畫面渲染 ---

            if (step === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-yellow-100 to-orange-200 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-t-4 border-orange-400">
                            <h1 className="text-3xl font-bold text-center text-orange-800 mb-2">縮小燈大冒險</h1>
                            <p className="text-center text-gray-500 mb-6 font-bold bg-orange-100 py-1 rounded-full text-sm">個人練習專用版</p>
                            
                            <div className="space-y-6">
                                <div className="text-center p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                                    <BookOpen className="inline-block mb-2 text-orange-500" size={32} />
                                    <p>歡迎來到自我挑戰區！</p>
                                    <p>這裡不會紀錄成績，請放鬆心情，</p>
                                    <p>盡情測試自己對原子分子的了解吧！</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">你的暱稱</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                        placeholder="輸入名字開始練習"
                                        value={studentName}
                                        onChange={e => setStudentName(e.target.value)}
                                        onKeyPress={e => e.key === 'Enter' && handleStart()}
                                    />
                                </div>
                                <button
                                    onClick={handleStart}
                                    className="w-full bg-orange-500 text-white py-3 rounded-lg font-bold text-lg hover:bg-orange-600 transition flex items-center justify-center gap-2 shadow-lg"
                                >
                                    開始練習 <Play size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'game') {
                const q = gameQuestions[currentQIndex]; // 確保渲染當前打亂後的題目
                return (
                    <div className="min-h-screen bg-orange-50 p-4 pb-20">
                        <div className="max-w-4xl mx-auto">
                            {/* Header Info */}
                            <div className="flex justify-between items-center mb-6">
                                <span className="font-bold text-gray-600">
                                    練習題 {currentQIndex + 1} / {gameQuestions.length}
                                </span>
                                <span className="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm font-medium">
                                    挑戰者：{studentName}
                                </span>
                            </div>

                            {/* 題目區 */}
                            <div className="w-full bg-slate-700 text-white rounded-xl p-6 mb-6 shadow-lg text-center">
                                <h2 className="text-3xl font-bold tracking-wider">題目：{q.symbol}</h2>
                                <p className="text-slate-300 mt-2 text-sm">請依照題目化學式，選出正確的模型圖並完成分析</p>
                            </div>

                            {/* 模型選擇區 */}
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-l-4 border-slate-500">
                                <div className="flex flex-wrap items-center justify-between mb-4 gap-2">
                                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                        <MousePointerClick size={20} className="text-slate-600"/> 
                                        選擇正確的原子模型
                                    </h3>
                                    
                                    <div className="flex gap-3 text-sm font-normal bg-gray-50 px-3 py-1 rounded-lg border border-gray-100">
                                        <div className="flex items-center gap-1">
                                            <div className="w-4 h-4 rounded-full bg-gray-100 border border-gray-400"></div>
                                            <span className="text-gray-600">H</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <div className="w-4 h-4 rounded-full bg-gray-900 border border-gray-700"></div>
                                            <span className="text-gray-600">C</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <div className="w-4 h-4 rounded-full bg-red-500 border border-red-700"></div>
                                            <span className="text-gray-600">O</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {MODEL_OPTIONS.map((option) => (
                                        <button
                                            key={option.id}
                                            onClick={() => setCurrentInput({ ...currentInput, selectedModelId: option.id })}
                                            className={`
                                                relative p-3 rounded-xl border-2 transition-all duration-200 flex flex-col items-center gap-2 h-24 justify-center
                                                ${currentInput.selectedModelId === option.id 
                                                ? 'border-slate-500 bg-slate-50 shadow-md scale-105' 
                                                : 'border-gray-200 hover:border-slate-200 hover:bg-slate-50'}
                                            `}
                                        >
                                            <div className="flex items-center justify-center w-full">
                                                <ModelRenderer type={option.type} />
                                            </div>
                                            {currentInput.selectedModelId === option.id && (
                                                <div className="absolute top-1 right-1 text-slate-600">
                                                    <CheckCircle size={14} />
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>
                                <div className="text-center mt-4 h-6">
                                    {currentInput.selectedModelId ? (
                                        <span className="text-slate-600 font-medium text-sm">
                                            已選擇模型
                                        </span>
                                    ) : (
                                        <span className="text-gray-400 text-sm">請點擊上方其中一個選項</span>
                                    )}
                                </div>
                            </div>

                            {/* Form Area */}
                            <div className="bg-white rounded-xl shadow-lg p-6 space-y-6">
                                {/* 1. 名稱與數量 */}
                                <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <h3 className="font-bold text-yellow-800 mb-3 flex items-center gap-2">
                                        ➊ 名稱識別
                                    </h3>
                                    <div className="flex flex-wrap items-center gap-2 text-lg">
                                        <span>圖中有</span>
                                        <input
                                            type="number"
                                            className="w-16 p-2 border-b-2 border-slate-300 bg-transparent text-center focus:border-slate-600 outline-none font-bold"
                                            value={currentInput.count}
                                            onChange={e => setCurrentInput({ ...currentInput, count: e.target.value })}
                                        />
                                        <span>個</span>
                                        <select
                                            className="p-2 border rounded bg-white min-w-[10rem]"
                                            value={currentInput.name}
                                            onChange={e => setCurrentInput({ ...currentInput, name: e.target.value })}
                                        >
                                            <option value="">請選擇</option>
                                            <option value="氫原子">氫原子</option>
                                            <option value="氫分子">氫分子</option>
                                            <option value="氧原子">氧原子</option>
                                            <option value="氧分子">氧分子</option>
                                            <option value="水分子">水分子</option>
                                            <option value="二氧化碳分子">二氧化碳分子</option>
                                            <option value="混合物(有幾個物質)">混合物(有幾個物質)</option>
                                        </select>
                                    </div>
                                </div>

                                {/* 2. 分類 */}
                                <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                                    <h3 className="font-bold text-green-800 mb-3">➋ 物質分類</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">化學分類</label>
                                            <div className="flex gap-1">
                                                {['元素', '化合物', '不適用'].map(opt => (
                                                    <button
                                                        key={opt}
                                                        onClick={() => setCurrentInput({ ...currentInput, category: opt })}
                                                        className={`flex-1 py-2 text-sm rounded border transition-colors ${
                                                            currentInput.category === opt 
                                                            ? 'bg-green-600 text-white border-green-600' 
                                                            : 'bg-white text-gray-600 border-gray-300 hover:bg-green-50'
                                                        }`}
                                                    >
                                                        {opt}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">純度分類</label>
                                            <div className="flex gap-2">
                                                {['純物質', '混合物'].map(opt => (
                                                    <button
                                                        key={opt}
                                                        onClick={() => setCurrentInput({ ...currentInput, purity: opt })}
                                                        className={`flex-1 py-2 rounded border transition-colors ${
                                                            currentInput.purity === opt 
                                                            ? 'bg-green-600 text-white border-green-600' 
                                                            : 'bg-white text-gray-600 border-gray-300 hover:bg-green-50'
                                                        }`}
                                                    >
                                                        {opt}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 3. 組成統計 */}
                                <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                                    <h3 className="font-bold text-purple-800 mb-3">➌ 組成分析</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center border-b border-purple-100 pb-2">
                                            <span className="text-gray-700">總共有幾個原子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none"
                                                value={currentInput.totalAtoms}
                                                onChange={e => setCurrentInput({ ...currentInput, totalAtoms: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex justify-between items-center border-b border-purple-100 pb-2">
                                            <span className="text-gray-700">有幾「種」原子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none"
                                                value={currentInput.atomTypes}
                                                onChange={e => setCurrentInput({ ...currentInput, atomTypes: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex justify-between items-center border-b border-purple-100 pb-2 bg-purple-100/50 px-2 rounded">
                                            <span className="text-purple-900 font-bold">有幾個分子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none font-bold"
                                                value={currentInput.moleculeCount}
                                                onChange={e => setCurrentInput({ ...currentInput, moleculeCount: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex justify-between items-center px-2">
                                            <span className="text-gray-700">有幾「種」分子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none"
                                                value={currentInput.moleculeTypes}
                                                onChange={e => setCurrentInput({ ...currentInput, moleculeTypes: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button
                                onClick={handleNext}
                                className="w-full mt-6 bg-slate-700 text-white py-4 rounded-xl font-bold text-xl shadow-lg hover:bg-slate-800 flex items-center justify-center gap-2"
                            >
                                {currentQIndex === gameQuestions.length - 1 ? '完成練習，看結果' : '下一題'} <ChevronRight />
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'result') {
                return (
                    <div className="min-h-screen bg-gray-100 p-4">
                        <div className="max-w-3xl mx-auto space-y-6">
                            
                            {/* Result Header */}
                            <div className="bg-white rounded-2xl shadow-xl p-8 text-center border-t-8 border-orange-400">
                                <div className="inline-flex items-center justify-center w-20 h-20 bg-orange-100 rounded-full mb-4">
                                    <BarChart size={40} className="text-orange-600" />
                                </div>
                                <h2 className="text-3xl font-bold text-gray-800">練習完成！</h2>
                                <p className="text-gray-500 mt-2">做得好，{studentName}！</p>
                                <div className="mt-6 text-6xl font-extrabold text-orange-600">{finalScore} <span className="text-2xl text-gray-500">分</span></div>
                                <p className="text-sm text-gray-400 mt-2">滿分 104 分</p>
                            </div>

                            {/* Review Section */}
                            <div className="bg-white rounded-2xl shadow-lg p-6">
                                <h3 className="font-bold text-gray-700 border-b pb-2 mb-4 flex items-center gap-2">
                                    <Search size={20}/> 作答檢討報告
                                </h3>
                                
                                <div className="space-y-8">
                                    {Object.values(answers).map((ans, idx) => {
                                        const isModelCorrect = ans.user.selectedModelId === ans.correctModel;
                                        return (
                                            <div key={idx} className="border border-gray-200 rounded-xl overflow-hidden">
                                                <div className="bg-gray-50 px-4 py-3 flex justify-between items-center border-b">
                                                    <span className="font-bold text-lg text-gray-700">題目：{ans.symbol}</span>
                                                    <span className={`px-2 py-1 rounded text-sm font-bold ${ans.points === ans.maxPoints ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                        得分：{ans.points} / {ans.maxPoints}
                                                    </span>
                                                </div>
                                                
                                                <div className="p-4 grid md:grid-cols-2 gap-6">
                                                    {/* Left: Model Comparison */}
                                                    <div>
                                                        <h4 className="text-sm font-bold text-gray-500 mb-2">模型選擇</h4>
                                                        <div className="flex gap-4 items-start">
                                                            <div className="flex flex-col items-center">
                                                                <span className="text-xs text-gray-500 mb-1">你的選擇</span>
                                                                <div className={`p-2 border-2 rounded-lg ${isModelCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}`}>
                                                                    {ans.user.selectedModelId ? (
                                                                        <ModelRenderer type={MODEL_OPTIONS.find(o => o.id === ans.user.selectedModelId)?.type} scale={0.5} />
                                                                    ) : <XCircle className="text-red-400" />}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-col items-center">
                                                                <span className="text-xs text-gray-500 mb-1">正確答案</span>
                                                                <div className="p-2 border-2 border-green-500 bg-green-50 rounded-lg">
                                                                    <ModelRenderer type={MODEL_OPTIONS.find(o => o.id === ans.correctModel)?.type} scale={0.5} />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Right: Data Comparison Table */}
                                                    <div>
                                                        <h4 className="text-sm font-bold text-gray-500 mb-2">作答詳細比對</h4>
                                                        <table className="w-full text-sm">
                                                            <thead>
                                                                <tr className="text-left text-gray-400 text-xs">
                                                                    <th className="pb-1">項目</th>
                                                                    <th className="pb-1">你的答案</th>
                                                                    <th className="pb-1">正確答案</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y">
                                                                <ReviewRow label="數量/名稱" user={`${ans.user.count}個 ${ans.user.name}`} correct={`${ans.correctData.count}個 ${ans.correctData.name}`} />
                                                                <ReviewRow label="分類" user={`${ans.user.category} / ${ans.user.purity}`} correct={`${ans.correctData.category} / ${ans.correctData.purity}`} />
                                                                <ReviewRow label="原子總數" user={ans.user.totalAtoms} correct={ans.correctData.composition.totalAtoms} />
                                                                <ReviewRow label="原子種類" user={ans.user.atomTypes} correct={ans.correctData.composition.atomTypes} />
                                                                <ReviewRow label="分子個數" user={ans.user.moleculeCount} correct={ans.correctData.composition.moleculeCount} />
                                                                <ReviewRow label="分子種類" user={ans.user.moleculeTypes} correct={ans.correctData.composition.moleculeTypes} />
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="text-center pt-8 pb-10">
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="px-8 py-3 bg-orange-500 text-white rounded-lg font-bold shadow-md hover:bg-orange-600 transition flex items-center justify-center gap-2 mx-auto"
                                >
                                <RefreshCw size={20} /> 重新挑戰
                                </button>
                            </div>

                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>