<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒç´ å¤§æœæŸ¥ï¼šå°çµ„ç©åˆ†è³½ (é›²ç«¯è¨ˆåˆ†ç‰ˆ)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: #f0f9ff;
        }
        .pop-in {
            animation: popIn 0.3s ease-out forwards;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .tag-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.5rem;
        }
        /* è™•ç†ä¸Šå‚³æ™‚çš„è®€å–å‹•ç•« */
        .spinner {
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            border-top: 4px solid #2563eb;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        //  è€å¸«è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwspGXlDAN8BeM3ivwpQ0oKiEZ8X2xqpMO0MMkWz42yBdKF8275oqlbWym2TE8PwannOw/exec"; 
        // ä¾‹å¦‚: "https://script.google.com/macros/s/AKfycbx.../exec"
        // è‹¥ç•™ç©ºï¼Œå‰‡åªæœƒé¡¯ç¤ºåˆ†æ•¸ï¼Œä¸æœƒåŸ·è¡Œè‡ªå‹•ä¸Šå‚³ã€‚

        // ----------------------
        // è³‡æ–™åº« (å°ˆæ¥­ä¿®æ­£ç‰ˆ - å«åˆé‡‘æˆåˆ†ç¬¦è™Ÿ)
        // ----------------------
        
        const TAGS = {
            // --- ç¬¦è™Ÿå€ (å­¸ç”Ÿéœ€å°æ‡‰é¸æ“‡) ---
            SYM_AU: { id: 'Au', text: 'Au', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_AG: { id: 'Ag', text: 'Ag', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_CU: { id: 'Cu', text: 'Cu', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_FE: { id: 'Fe', text: 'Fe', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_AL: { id: 'Al', text: 'Al', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_HG: { id: 'Hg', text: 'Hg', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_SI: { id: 'Si', text: 'Si', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_C:  { id: 'C',  text: 'C',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_NA: { id: 'Na', text: 'Na', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_K:  { id: 'K',  text: 'K',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_MG: { id: 'Mg', text: 'Mg', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_CA: { id: 'Ca', text: 'Ca', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_HE: { id: 'He', text: 'He', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_NE: { id: 'Ne', text: 'Ne', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_H:  { id: 'H',  text: 'H',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_O:  { id: 'O',  text: 'O',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_CL: { id: 'Cl', text: 'Cl', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_BR: { id: 'Br', text: 'Br', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_I:  { id: 'I',  text: 'I',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_S:  { id: 'S',  text: 'S',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_P:  { id: 'P',  text: 'P',  category: 'å…ƒç´ ç¬¦è™Ÿ' },
            
            // æ–°å¢åˆé‡‘ç”¨ç¬¦è™Ÿ
            SYM_CR: { id: 'Cr', text: 'Cr', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_NI: { id: 'Ni', text: 'Ni', category: 'å…ƒç´ ç¬¦è™Ÿ' },
            SYM_ZN: { id: 'Zn', text: 'Zn', category: 'å…ƒç´ ç¬¦è™Ÿ' },

            // --- ç‹€æ…‹ (å¸¸æº«å¸¸å£“) ---
            SOLID: { id: 'solid', text: 'å›ºæ…‹', category: 'ç‹€æ…‹' },
            LIQUID: { id: 'liquid', text: 'æ¶²æ…‹', category: 'ç‹€æ…‹' },
            GAS: { id: 'gas', text: 'æ°£æ…‹', category: 'ç‹€æ…‹' },
            
            // --- åˆ†é¡ ---
            METAL: { id: 'metal', text: 'é‡‘å±¬å…ƒç´ ', category: 'åˆ†é¡' },
            NON_METAL: { id: 'non_metal', text: 'éé‡‘å±¬å…ƒç´ ', category: 'åˆ†é¡' },
            ALLOY: { id: 'alloy', text: 'åˆé‡‘(æ··åˆç‰©)', category: 'åˆ†é¡' },
            ALKALI_METAL: { id: 'alkali_m', text: 'é¹¼é‡‘å±¬ (ç¬¬1æ—)', category: 'åˆ†é¡' },
            ALKALI_EARTH: { id: 'alkali_e', text: 'é¹¼åœŸé‡‘å±¬ (ç¬¬2æ—)', category: 'åˆ†é¡' },
            NOBLE_GAS: { id: 'noble', text: 'éˆæ°£ (ç¬¬18æ—)', category: 'åˆ†é¡' },

            // --- é¡è‰²/å¤–è§€ ---
            SILVER_COLOR: { id: 'silver', text: 'éŠ€ç°è‰²/éŠ€ç™½è‰²', category: 'å¤–è§€' },
            GOLD_COLOR: { id: 'gold_c', text: 'é‡‘é»ƒè‰²/é»ƒè‰²', category: 'å¤–è§€' },
            RED_COLOR: { id: 'red_c', text: 'ç´…è¤è‰²/ç´…è‰²', category: 'å¤–è§€' },
            BLACK_COLOR: { id: 'black_c', text: 'é»‘è‰²/æ·±ç°è‰²', category: 'å¤–è§€' },
            TRANSPARENT: { id: 'trans', text: 'é€æ˜ç„¡è‰²', category: 'å¤–è§€' },
            YELLOW_GREEN: { id: 'y_green', text: 'é»ƒç¶ è‰²', category: 'å¤–è§€' },
            LUSTER: { id: 'luster', text: 'å…·é‡‘å±¬å…‰æ¾¤', category: 'å¤–è§€' },
            NO_LUSTER: { id: 'no_luster', text: 'ç„¡é‡‘å±¬å…‰æ¾¤', category: 'å¤–è§€' },

            // --- ç‰©ç†æ€§è³ª (å¸¸æº«) ---
            CONDUCTOR: { id: 'conductor', text: 'å¯å°é›»', category: 'æ€§è³ª <å¸¸æº«>' },
            BEST_CONDUCTOR: { id: 'cond_1', text: 'å°é›»æ€§æœ€ä½³', category: 'æ€§è³ª <å¸¸æº«>' },
            SECOND_CONDUCTOR: { id: 'cond_2', text: 'å°é›»æ€§ç¬¬2å', category: 'æ€§è³ª <å¸¸æº«>' },
            INSULATOR: { id: 'insulator', text: 'é›»/ç†±ä¸è‰¯å°é«”', category: 'æ€§è³ª <å¸¸æº«>' },
            SEMICONDUCTOR: { id: 'semi', text: 'åŠå°é«”', category: 'æ€§è³ª <å¸¸æº«>' },
            
            DUCTILE: { id: 'ductile', text: 'å…·å»¶æ€§/å±•æ€§', category: 'æ€§è³ª <å¸¸æº«>' },
            BEST_DUCTILITY: { id: 'duct_1', text: 'å»¶å±•æ€§æœ€ä½³', category: 'æ€§è³ª <å¸¸æº«>' },
            BRITTLE: { id: 'brittle', text: 'æ˜“ç¢/ä¸å…·å»¶å±•æ€§', category: 'æ€§è³ª <å¸¸æº«>' },
            SOFT: { id: 'soft', text: 'è³ªåœ°è»Ÿ(å¯ç”¨åˆ€åˆ‡)', category: 'æ€§è³ª <å¸¸æº«>' },
            HARDEST: { id: 'hardest', text: 'è‡ªç„¶ç•Œæœ€ç¡¬ç‰©è³ª', category: 'æ€§è³ª <å¸¸æº«>' },
            LOW_HARDNESS: { id: 'low_hard', text: 'ç¡¬åº¦å°/æ»‘è†©', category: 'æ€§è³ª <å¸¸æº«>' },
            
            MAGNETIC: { id: 'magnetic', text: 'å…·ç£æ€§/æ˜“ç”Ÿé½', category: 'æ€§è³ª <å¸¸æº«>' },
            LIGHT_DENSITY: { id: 'light', text: 'å¯†åº¦å°/è¼•', category: 'æ€§è³ª <å¸¸æº«>' },
            POROUS: { id: 'porous', text: 'å¤šå­”éš™/å¸é™„æ€§ä½³', category: 'æ€§è³ª <å¸¸æº«>' },

            // --- åŒ–å­¸æ€§è³ªèˆ‡å…¶ä»– ---
            WATER_REACT_BASE: { id: 'w_base', text: 'é‡æ°´åæ‡‰å‘ˆé¹¼æ€§', category: 'åŒ–å­¸/å…¶ä»–' },
            PHENOL_RED: { id: 'p_red', text: 'åæ‡‰å¾Œé…šé…å‘ˆç´…è‰²', category: 'åŒ–å­¸/å…¶ä»–' },
            RUST_PROTECT: { id: 'protect', text: 'æ°§åŒ–å±¤ç·»å¯†/é˜²é½', category: 'åŒ–å­¸/å…¶ä»–' },
            CRUST_1: { id: 'crust_1', text: 'åœ°æ®¼å«é‡ç¬¬1å', category: 'åŒ–å­¸/å…¶ä»–' },
            CRUST_2: { id: 'crust_2', text: 'åœ°æ®¼å«é‡ç¬¬2å', category: 'åŒ–å­¸/å…¶ä»–' },
            
            // --- ç”¨é€”/æˆåˆ† ---
            WIRES: { id: 'wires', text: 'å°ç·šææ–™', category: 'ç”¨é€”/æˆåˆ†' },
            JEWELRY: { id: 'jewelry', text: 'é£¾å“/è²¨å¹£', category: 'ç”¨é€”/æˆåˆ†' },
            CHIPS: { id: 'chips', text: 'æ™¶ç‰‡åŸæ–™', category: 'ç”¨é€”/æˆåˆ†' },
            STEEL_RAW: { id: 'steel_raw', text: 'ç…‰é‹¼åŸæ–™', category: 'ç”¨é€”/æˆåˆ†' },
            THERMOMETER: { id: 'thermo', text: 'æº«åº¦è¨ˆ/æ°£å£“è¨ˆ', category: 'ç”¨é€”/æˆåˆ†' },
            BALLOON: { id: 'balloon', text: 'å¡«å……æ°£çƒ/é£›èˆ¹', category: 'ç”¨é€”/æˆåˆ†' },
            NEON: { id: 'neon', text: 'éœ“è™¹ç‡ˆ', category: 'ç”¨é€”/æˆåˆ†' },
            PENCIL: { id: 'pencil', text: 'ç­†èŠ¯/é›»æ± é›»æ¥µ', category: 'ç”¨é€”/æˆåˆ†' },
            CUTTING: { id: 'cutting', text: 'åˆ‡å‰²ç»ç’ƒ', category: 'ç”¨é€”/æˆåˆ†' },
            
            ALLOY_FE_CR_NI: { id: 'a_fe_cr_ni', text: 'éµ+é‰»+é³ åˆé‡‘', category: 'ç”¨é€”/æˆåˆ†' },
            ALLOY_CU_ZN: { id: 'a_cu_zn', text: 'éŠ…+é‹… åˆé‡‘', category: 'ç”¨é€”/æˆåˆ†' },
            ALLOY_AU_AG: { id: 'a_au_ag', text: 'é‡‘+éŠ€+éŠ… åˆé‡‘', category: 'ç”¨é€”/æˆåˆ†' },
        };

        // é¡Œç›®è³‡æ–™åº«
        const ELEMENTS_DB = [
            {
                name: "é‡‘",
                tags: [TAGS.SYM_AU, TAGS.SOLID, TAGS.METAL, TAGS.GOLD_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE, TAGS.BEST_DUCTILITY, TAGS.JEWELRY, TAGS.WIRES, TAGS.ALLOY_AU_AG]
            },
            {
                name: "éŠ€",
                tags: [TAGS.SYM_AG, TAGS.SOLID, TAGS.METAL, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.BEST_CONDUCTOR, TAGS.DUCTILE, TAGS.JEWELRY, TAGS.WIRES, TAGS.ALLOY_AU_AG]
            },
            {
                name: "éŠ…",
                tags: [TAGS.SYM_CU, TAGS.SOLID, TAGS.METAL, TAGS.RED_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.SECOND_CONDUCTOR, TAGS.DUCTILE, TAGS.WIRES, TAGS.JEWELRY, TAGS.ALLOY_CU_ZN, TAGS.ALLOY_AU_AG]
            },
            {
                name: "éµ",
                tags: [TAGS.SYM_FE, TAGS.SOLID, TAGS.METAL, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE, TAGS.MAGNETIC, TAGS.STEEL_RAW, TAGS.ALLOY_FE_CR_NI]
            },
            {
                name: "é‹",
                tags: [TAGS.SYM_AL, TAGS.SOLID, TAGS.METAL, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE, TAGS.LIGHT_DENSITY, TAGS.RUST_PROTECT, TAGS.WIRES, TAGS.JEWELRY]
            },
            {
                name: "æ± (æ°´éŠ€)",
                tags: [TAGS.SYM_HG, TAGS.LIQUID, TAGS.METAL, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.THERMOMETER]
            },
            {
                name: "çŸ½",
                tags: [TAGS.SYM_SI, TAGS.SOLID, TAGS.NON_METAL, TAGS.BLACK_COLOR, TAGS.SEMICONDUCTOR, TAGS.BRITTLE, TAGS.CHIPS, TAGS.CRUST_2]
            },
            {
                name: "æ´»æ€§ç¢³",
                tags: [TAGS.SYM_C, TAGS.SOLID, TAGS.NON_METAL, TAGS.BLACK_COLOR, TAGS.NO_LUSTER, TAGS.POROUS, TAGS.INSULATOR, TAGS.BRITTLE]
            },
            {
                name: "é‘½çŸ³",
                tags: [TAGS.SYM_C, TAGS.SOLID, TAGS.NON_METAL, TAGS.TRANSPARENT, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.HARDEST, TAGS.JEWELRY, TAGS.CUTTING]
            },
            {
                name: "çŸ³å¢¨",
                tags: [TAGS.SYM_C, TAGS.SOLID, TAGS.NON_METAL, TAGS.BLACK_COLOR, TAGS.CONDUCTOR, TAGS.NO_LUSTER, TAGS.LOW_HARDNESS, TAGS.PENCIL]
            },
            {
                name: "æœ¨ç‚­",
                tags: [TAGS.SYM_C, TAGS.SOLID, TAGS.NON_METAL, TAGS.BLACK_COLOR, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.BRITTLE, TAGS.STEEL_RAW, TAGS.POROUS]
            },
            {
                name: "æº´",
                tags: [TAGS.SYM_BR, TAGS.LIQUID, TAGS.NON_METAL, TAGS.RED_COLOR, TAGS.NO_LUSTER, TAGS.INSULATOR]
            },
            {
                name: "æ°¯",
                tags: [TAGS.SYM_CL, TAGS.GAS, TAGS.NON_METAL, TAGS.YELLOW_GREEN, TAGS.NO_LUSTER, TAGS.INSULATOR]
            },
            {
                name: "ç¢˜",
                tags: [TAGS.SYM_I, TAGS.SOLID, TAGS.NON_METAL, TAGS.BLACK_COLOR, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.BRITTLE, TAGS.LOW_HARDNESS]
            },
            {
                name: "ç¡«",
                tags: [TAGS.SYM_S, TAGS.SOLID, TAGS.NON_METAL, TAGS.GOLD_COLOR, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.BRITTLE, TAGS.LOW_HARDNESS]
            },
            {
                name: "ç´…ç£·",
                tags: [TAGS.SYM_P, TAGS.SOLID, TAGS.NON_METAL, TAGS.RED_COLOR, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.BRITTLE, TAGS.LOW_HARDNESS]
            },
            {
                name: "æ°«",
                tags: [TAGS.SYM_H, TAGS.GAS, TAGS.NON_METAL, TAGS.TRANSPARENT, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.LIGHT_DENSITY]
            },
            {
                name: "æ°§",
                tags: [TAGS.SYM_O, TAGS.GAS, TAGS.NON_METAL, TAGS.TRANSPARENT, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.CRUST_1]
            },
            {
                name: "æ°¦",
                tags: [TAGS.SYM_HE, TAGS.GAS, TAGS.NON_METAL, TAGS.NOBLE_GAS, TAGS.TRANSPARENT, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.LIGHT_DENSITY, TAGS.BALLOON]
            },
            {
                name: "æ°–",
                tags: [TAGS.SYM_NE, TAGS.GAS, TAGS.NON_METAL, TAGS.NOBLE_GAS, TAGS.TRANSPARENT, TAGS.NO_LUSTER, TAGS.INSULATOR, TAGS.NEON]
            },
            {
                name: "éˆ‰",
                tags: [TAGS.SYM_NA, TAGS.SOLID, TAGS.METAL, TAGS.ALKALI_METAL, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.SOFT, TAGS.LIGHT_DENSITY, TAGS.WATER_REACT_BASE, TAGS.PHENOL_RED, TAGS.DUCTILE]
            },
            {
                name: "é‰€",
                tags: [TAGS.SYM_K, TAGS.SOLID, TAGS.METAL, TAGS.ALKALI_METAL, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.SOFT, TAGS.LIGHT_DENSITY, TAGS.WATER_REACT_BASE, TAGS.PHENOL_RED, TAGS.DUCTILE]
            },
            {
                name: "é‚",
                tags: [TAGS.SYM_MG, TAGS.SOLID, TAGS.METAL, TAGS.ALKALI_EARTH, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE]
            },
            {
                name: "éˆ£",
                tags: [TAGS.SYM_CA, TAGS.SOLID, TAGS.METAL, TAGS.ALKALI_EARTH, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE]
            },
            {
                name: "ä¸é½é‹¼",
                tags: [TAGS.SYM_FE, TAGS.SYM_CR, TAGS.SYM_NI, TAGS.SOLID, TAGS.ALLOY, TAGS.SILVER_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE, TAGS.ALLOY_FE_CR_NI, TAGS.RUST_PROTECT]
            },
            {
                name: "é»ƒéŠ…",
                tags: [TAGS.SYM_CU, TAGS.SYM_ZN, TAGS.SOLID, TAGS.ALLOY, TAGS.GOLD_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE, TAGS.ALLOY_CU_ZN, TAGS.JEWELRY]
            },
            {
                name: "Ké‡‘",
                tags: [TAGS.SYM_AU, TAGS.SYM_AG, TAGS.SYM_CU, TAGS.SOLID, TAGS.ALLOY, TAGS.GOLD_COLOR, TAGS.LUSTER, TAGS.CONDUCTOR, TAGS.DUCTILE, TAGS.ALLOY_AU_AG, TAGS.JEWELRY]
            }
        ];

        // ----------------------
        // æ‡‰ç”¨ç¨‹å¼å…ƒä»¶
        // ----------------------

        function App() {
            const [page, setPage] = useState('home');
            const [teamInfo, setTeamInfo] = useState({ class: '', group: '', members: '' });
            const [score, setScore] = useState(0);
            const [history, setHistory] = useState([]);

            const handleStartGame = (info) => {
                setTeamInfo(info);
                setScore(0);
                setHistory([]);
                setPage('game');
            };

            const handleGameEnd = (finalScore, gameHistory) => {
                setScore(finalScore);
                setHistory(gameHistory);
                setPage('result');
            };

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50">
                        <div className="container mx-auto flex justify-between items-center relative">
                            <h1 className="text-2xl font-bold tracking-wider">âš—ï¸ å…ƒç´ å¤§æœæŸ¥ <span className="text-sm font-normal bg-blue-600 px-2 py-1 rounded ml-2">å°ˆæ¥­ç«¶è³½ç‰ˆ</span></h1>
                            
                            <div className="flex flex-col items-end">
                                <div className="text-[10px] text-slate-400 mb-1 font-light tracking-wide text-right leading-tight">
                                    Designed by é»ƒéˆºå¿ƒ<br/>Gemini Canvasè¼”åŠ©ç”Ÿæˆ
                                </div>
                                {page !== 'home' && (
                                    <div className="text-sm bg-slate-700 px-3 py-1 rounded border border-slate-500">
                                        {teamInfo.class}ç­ ç¬¬{teamInfo.group}çµ„
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto p-4">
                        {page === 'home' && <HomePage onStart={handleStartGame} />}
                        {page === 'game' && <GamePage onEnd={handleGameEnd} />}
                        {page === 'result' && <ResultPage score={score} history={history} teamInfo={teamInfo} onRestart={() => setPage('home')} />}
                    </main>
                </div>
            );
        }

        function HomePage({ onStart }) {
            const [info, setInfo] = useState({ class: '', group: '', members: '' });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!info.class || !info.group) {
                    alert('è«‹å¡«å¯«å®Œæ•´ç­ç´šèˆ‡çµ„åˆ¥è³‡è¨Šï¼');
                    return;
                }
                onStart(info);
            };

            return (
                <div className="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 mt-10 pop-in border-t-4 border-blue-600">
                    <h2 className="text-2xl font-bold text-center mb-6 text-gray-800">ğŸ§ª å°çµ„ç«¶è³½ç™»å…¥</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-gray-700 font-bold mb-2">ç­ç´š</label>
                            <input type="text" placeholder="ä¾‹å¦‚ï¼š801" className="w-full border p-3 rounded-lg focus:outline-none focus:border-blue-500" value={info.class} onChange={e => setInfo({...info, class: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-bold mb-2">çµ„åˆ¥</label>
                            <input type="number" placeholder="ä¾‹å¦‚ï¼š3" className="w-full border p-3 rounded-lg focus:outline-none focus:border-blue-500" value={info.group} onChange={e => setInfo({...info, group: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-bold mb-2">çµ„å“¡åº§è™Ÿ</label>
                            <input type="text" placeholder="ä¾‹å¦‚ï¼š05, 12, 23" className="w-full border p-3 rounded-lg focus:outline-none focus:border-blue-500" value={info.members} onChange={e => setInfo({...info, members: e.target.value})} />
                        </div>
                        <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg shadow mt-4 transition transform active:scale-95">é–‹å§‹æŒ‘æˆ° (10é¡Œ)</button>
                    </form>
                    <div className="mt-6 p-4 bg-yellow-50 rounded-lg text-sm text-yellow-800">
                        <p className="font-bold mb-1">è¨ˆåˆ†è¦å‰‡ï¼š</p>
                        <ul className="list-disc pl-5">
                            <li>å®Œå…¨æ­£ç¢ºé¸å‡ºç‰¹æ€§ï¼š<span className="font-bold text-green-600">+2 åˆ†</span></li>
                            <li>è©²é¸è€Œæœªé¸ï¼š<span className="font-bold text-red-500">-1 åˆ†</span></li>
                            <li>é¸éŒ¯ç‰¹æ€§ï¼š<span className="font-bold text-red-600">-2 åˆ†</span></li>
                        </ul>
                    </div>
                </div>
            );
        }

        function GamePage({ onEnd }) {
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [selectedTags, setSelectedTags] = useState(new Set());
            const [showRoundResult, setShowRoundResult] = useState(false);
            const [roundScore, setRoundScore] = useState({ score: 0, details: {} });
            const [totalScore, setTotalScore] = useState(0);
            const [gameHistory, setGameHistory] = useState([]);

            // éŠæˆ²åˆå§‹åŒ–ï¼šéš¨æ©Ÿå– 10 é¡Œ
            useEffect(() => {
                const shuffled = [...ELEMENTS_DB].sort(() => 0.5 - Math.random());
                setQuestions(shuffled.slice(0, 10));
            }, []);

            const currentElement = questions[currentQIndex];

            const toggleTag = (tagId) => {
                if (showRoundResult) return;
                const newSet = new Set(selectedTags);
                newSet.has(tagId) ? newSet.delete(tagId) : newSet.add(tagId);
                setSelectedTags(newSet);
            };

            const handleSubmit = () => {
                const correctTagIds = new Set(currentElement.tags.map(t => t.id));
                const userTagIds = selectedTags;

                let roundPoints = 0;
                let details = { correct: [], missed: [], wrong: [] };

                userTagIds.forEach(id => {
                    if (correctTagIds.has(id)) {
                        roundPoints += 2;
                        details.correct.push(id);
                    } else {
                        roundPoints -= 2;
                        details.wrong.push(id);
                    }
                });

                correctTagIds.forEach(id => {
                    if (!userTagIds.has(id)) {
                        roundPoints -= 1;
                        details.missed.push(id);
                    }
                });

                setRoundScore({ score: roundPoints, details });
                setTotalScore(prev => prev + roundPoints);
                setGameHistory(prev => [...prev, { element: currentElement.name, score: roundPoints }]);
                setShowRoundResult(true);
            };

            const handleNext = () => {
                if (currentQIndex < questions.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                    setSelectedTags(new Set());
                    setShowRoundResult(false);
                } else {
                    onEnd(totalScore, gameHistory);
                }
            };

            if (!currentElement) return <div className="text-center mt-20">æº–å‚™é¡Œåº«ä¸­...</div>;

            // åˆ†é¡é¡¯ç¤ºé¸é …
            const categories = {};
            const categoryOrder = ['å…ƒç´ ç¬¦è™Ÿ', 'ç‹€æ…‹', 'åˆ†é¡', 'å¤–è§€', 'æ€§è³ª <å¸¸æº«>', 'åŒ–å­¸/å…¶ä»–', 'ç”¨é€”/æˆåˆ†'];
            
            Object.values(TAGS).forEach(tag => {
                if (!categories[tag.category]) categories[tag.category] = [];
                categories[tag.category].push(tag);
            });

            return (
                <div className="flex flex-col lg:flex-row gap-6">
                    {/* å·¦å´ï¼šé¡Œç›®å¡ */}
                    <div className="w-full lg:w-1/4">
                        <div className="bg-white rounded-xl shadow-lg p-6 sticky top-24 border-t-8 border-blue-500">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-xs font-bold bg-gray-200 px-2 py-1 rounded text-gray-600">ç¬¬ {currentQIndex + 1} / {questions.length} é¡Œ</span>
                                <span className="text-xl font-bold text-blue-600">å¾—åˆ†: {totalScore}</span>
                            </div>
                            
                            <div className="text-center py-10 bg-slate-50 rounded-lg mb-4 border border-slate-200">
                                <h3 className="text-4xl font-black text-gray-800">{currentElement.name}</h3>
                                <p className="text-gray-500 mt-2 text-sm">è«‹é¸æ“‡å³å´æ‰€æœ‰ç¬¦åˆçš„æè¿°</p>
                            </div>

                            {!showRoundResult ? (
                                <button onClick={handleSubmit} className="w-full bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold py-3 rounded-lg shadow-md transition transform active:scale-95">
                                    ç¢ºèªé€å‡º
                                </button>
                            ) : (
                                <div className="animate-fade-in">
                                    <div className={`text-center py-2 text-xl font-bold rounded mb-4 ${roundScore.score >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        æœ¬é¡Œï¼š{roundScore.score > 0 ? '+' : ''}{roundScore.score} åˆ†
                                    </div>
                                    <button onClick={handleNext} className="w-full bg-gray-800 hover:bg-gray-900 text-white text-lg font-bold py-3 rounded-lg shadow transition">
                                        {currentQIndex < questions.length - 1 ? 'ä¸‹ä¸€é¡Œ' : 'çœ‹çµç®—'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* å³å´ï¼šé¸é …å€ */}
                    <div className="w-full lg:w-3/4">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <div className="space-y-6">
                                {categoryOrder.map(catName => {
                                    if (!categories[catName]) return null;
                                    return (
                                        <div key={catName} className="border-b border-gray-100 pb-4 last:border-0">
                                            <h4 className="font-bold text-slate-700 mb-3 flex items-center">
                                                <span className="w-2 h-6 bg-blue-500 mr-2 rounded-full"></span>
                                                {catName}
                                            </h4>
                                            <div className="tag-grid">
                                                {categories[catName].map(tag => {
                                                    const isSelected = selectedTags.has(tag.id);
                                                    let btnClass = "border text-sm p-2 rounded transition text-left relative ";
                                                    
                                                    // Declare variables inside JSX scope map function
                                                    let isCorrect = false;
                                                    let isMissed = false;
                                                    let isWrong = false;

                                                    if (showRoundResult) {
                                                        isCorrect = roundScore.details.correct.includes(tag.id);
                                                        isMissed = roundScore.details.missed.includes(tag.id);
                                                        isWrong = roundScore.details.wrong.includes(tag.id);

                                                        if (isCorrect) btnClass += "bg-green-600 text-white border-green-700 opacity-100";
                                                        else if (isMissed) btnClass += "bg-white text-red-600 border-2 border-red-400 border-dashed font-bold";
                                                        else if (isWrong) btnClass += "bg-red-600 text-white border-red-700 opacity-100";
                                                        else btnClass += "bg-gray-50 text-gray-400 opacity-40";
                                                    } else {
                                                        if (isSelected) btnClass += "bg-blue-600 text-white border-blue-700 shadow-md transform scale-105 z-10";
                                                        else btnClass += "bg-white text-gray-700 hover:bg-blue-50 hover:border-blue-300";
                                                    }

                                                    return (
                                                        <button
                                                            key={tag.id}
                                                            onClick={() => toggleTag(tag.id)}
                                                            disabled={showRoundResult}
                                                            className={btnClass}
                                                        >
                                                            {tag.text}
                                                            {showRoundResult && isCorrect && <span className="absolute top-0 right-1 text-xs text-white opacity-80">+2</span>}
                                                            {showRoundResult && isMissed && <span className="absolute top-0 right-1 text-xs text-red-500">-1</span>}
                                                            {showRoundResult && isWrong && <span className="absolute top-0 right-1 text-xs text-white opacity-80">-2</span>}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ResultPage({ score, history, teamInfo, onRestart }) {
            const [uploadStatus, setUploadStatus] = useState('idle'); // idle, uploading, success, error

            // è‡ªå‹•ä¸Šå‚³å‡½å¼
            const handleUpload = async () => {
                if (!GOOGLE_SCRIPT_URL) {
                    console.log("æœªè¨­å®š Google Script URLï¼Œè·³éè‡ªå‹•ä¸Šå‚³");
                    return;
                }

                setUploadStatus('uploading');
                try {
                    // ä½¿ç”¨ fetch å‚³é€è³‡æ–™ (mode: 'no-cors' æ˜¯é—œéµï¼Œå› ç‚º GAS é€šå¸¸æ²’æœ‰ CORS header)
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class: teamInfo.class,
                            group: teamInfo.group,
                            members: teamInfo.members,
                            score: score
                        })
                    });

                    // ç”±æ–¼ no-cors æ¨¡å¼ä¸‹ç„¡æ³•ç¢ºèª response ç‹€æ…‹ï¼Œå‡è¨­ç™¼é€æˆåŠŸå³è¦–ç‚ºæˆåŠŸ
                    // ç¨å¾®å»¶é²ä¸€ä¸‹è®“ä½¿ç”¨è€…çœ‹åˆ° loading
                    setTimeout(() => {
                        setUploadStatus('success');
                        // ç§»é™¤ Alertï¼Œæ”¹ç”¨é é¢ä¸Šçš„ç‹€æ…‹é¡¯ç¤º
                    }, 500);

                } catch (error) {
                    console.error("Upload error:", error);
                    setUploadStatus('error');
                }
            };

            // çµ„ä»¶æ›è¼‰æ™‚è‡ªå‹•è§¸ç™¼ä¸Šå‚³
            useEffect(() => {
                if (uploadStatus === 'idle') {
                    handleUpload();
                }
            }, []);

            return (
                <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-2xl p-8 mt-6 text-center pop-in">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">{teamInfo.class}ç­ ç¬¬{teamInfo.group}çµ„</h2>
                    <p className="text-gray-500 mb-8">æˆå“¡ï¼š{teamInfo.members}</p>

                    <div className="mb-8 p-6 bg-slate-50 rounded-xl inline-block min-w-[300px]">
                        <p className="text-gray-600">æœ¬æ¬¡ç«¶è³½ç¸½åˆ†</p>
                        <p className={`text-7xl font-black my-2 ${score >= 60 ? 'text-blue-600' : (score >= 30 ? 'text-green-600' : 'text-gray-600')}`}>{score}</p>
                    </div>

                    {/* ä¸Šå‚³ç‹€æ…‹é¡¯ç¤ºå€å¡Š */}
                    <div className="mb-8 h-16 flex items-center justify-center">
                        {uploadStatus === 'idle' && !GOOGLE_SCRIPT_URL && (
                            <div className="text-gray-400 text-sm">
                                (æœªè¨­å®šé›²ç«¯ç¶²å€ï¼Œåƒ…é¡¯ç¤ºåˆ†æ•¸)
                            </div>
                        )}
                        {uploadStatus === 'uploading' && (
                            <div className="text-blue-600 font-bold text-lg flex items-center justify-center animate-pulse">
                                <span className="spinner"></span> æ­£åœ¨è‡ªå‹•ä¸Šå‚³æˆç¸¾ä¸­...
                            </div>
                        )}
                        {uploadStatus === 'success' && (
                            <div className="text-green-600 font-bold text-lg bg-green-50 px-6 py-3 rounded-full border border-green-200 shadow-sm flex items-center">
                                <span className="mr-2 text-xl">âœ…</span> æˆç¸¾å·²è‡ªå‹•ä¸Šå‚³æˆåŠŸï¼
                            </div>
                        )}
                        {uploadStatus === 'error' && (
                            <div className="flex flex-col items-center">
                                <div className="text-red-600 font-bold text-lg mb-2 flex items-center">
                                    <span className="mr-2">âŒ</span> ä¸Šå‚³å¤±æ•— (ç¶²è·¯ä¸ç©©)
                                </div>
                                <button 
                                    onClick={handleUpload}
                                    className="text-sm bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-full transition font-bold"
                                >
                                    ğŸ”„ é»æ­¤é‡æ–°å˜—è©¦ä¸Šå‚³
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="text-left bg-white border rounded-lg overflow-hidden mb-8">
                        <table className="w-full">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-3 text-gray-600 font-bold">é¡Œè™Ÿ</th>
                                    <th className="p-3 text-gray-600 font-bold">é¡Œç›®</th>
                                    <th className="p-3 text-gray-600 font-bold text-right">å¾—åˆ†</th>
                                </tr>
                            </thead>
                            <tbody>
                                {history.map((h, idx) => (
                                    <tr key={idx} className="border-t hover:bg-gray-50">
                                        <td className="p-3 text-gray-500">{idx + 1}</td>
                                        <td className="p-3 font-bold text-gray-800">{h.element}</td>
                                        <td className={`p-3 text-right font-bold ${h.score >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {h.score > 0 ? '+' : ''}{h.score}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <button onClick={onRestart} className="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-10 rounded-full text-lg shadow-lg transition transform hover:scale-105">
                        ä¸‹ä¸€çµ„æŒ‘æˆ°
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>