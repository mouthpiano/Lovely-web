<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>縮小燈大冒險：原子分子的微觀派對</title>
    <!-- 引入 Tailwind CSS (用於樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 Babel (用於在瀏覽器中執行 React 程式碼) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 避免在手機上長按選取文字 */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-50 no-select">
    <div id="root"></div>

    <script type="text/babel">
        // ============================================================================
        // 【教師設定區】
        // 請將您的 Google Apps Script 網頁應用程式網址貼在下方的引號 "" 中間
        // 例如：const TEACHER_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx.../exec";
        
        const TEACHER_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDicmyKMtDU2-MZXzVD6K1qnb4_PI9rhB6If8ANcMpN-gkN0NUCjsE1tVwjN4nPUVh/exec"; 
        
        // ============================================================================

        const { useState, useEffect } = React;

        // --- 圖示組件 (SVG Icons) ---
        const School = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4"/><path d="M18 5v17"/><path d="M6 5v17"/><circle cx="12" cy="9" r="2"/></svg>
        );
        const Play = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
        );
        const MousePointerClick = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 9 5 12 1.8-5.2L21 14 9 9z"/><path d="M12 12v6"/><path d="m13 13 4 4"/></svg>
        );
        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const ChevronRight = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>
        );
        const BarChart = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        );
        const Send = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        );
        const RefreshCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
        );
        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const Search = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        );
        const XCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        );

        // --- 資料結構與題庫 ---

        // 定義原子類型與顏色
        const ATOM_TYPES = {
            H: { color: 'bg-gray-100 border-gray-400 text-gray-500', label: '氫' }, // 白/灰
            O: { color: 'bg-red-500 border-red-700 text-white', label: '氧' }, // 紅
            C: { color: 'bg-gray-900 border-gray-700 text-white', label: '碳' }, // 黑
        };

        // 定義所有可能的模型選項
        const MODEL_OPTIONS = [
            { id: 'opt_2H', type: '2H', description: '兩顆分開的氫原子' },
            { id: 'opt_2H2', type: '2H₂', description: '兩個氫分子' },
            { id: 'opt_CO2', type: 'CO₂', description: '二氧化碳分子' },
            { id: 'opt_H2O', type: 'H₂O', description: '水分子' },
            { id: 'opt_O', type: 'O', description: '氧原子' },
            { id: 'opt_O2', type: 'O₂', description: '氧分子' },
            { id: 'opt_2H2O', type: '2H₂O', description: '兩個水分子' },
            { id: 'opt_Mix', type: 'H₂+CO₂', description: '氫氣與二氧化碳混合' }
        ];

        // 題目資料 (共8題)
        const QUESTIONS = [
            {
                id: 'q1',
                symbol: '2H',
                correctModelId: 'opt_2H',
                correct: {
                    count: 2,
                    name: '氫原子',
                    category: '元素',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 2, 
                        atomTypes: 1, 
                        moleculeCount: 0, 
                        moleculeTypes: 0 
                    }
                }
            },
            {
                id: 'q2',
                symbol: '2H₂',
                correctModelId: 'opt_2H2',
                correct: {
                    count: 2,
                    name: '氫分子',
                    category: '元素',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 4, 
                        atomTypes: 1, 
                        moleculeCount: 2, 
                        moleculeTypes: 1 
                    }
                }
            },
            {
                id: 'q3',
                symbol: 'CO₂',
                correctModelId: 'opt_CO2',
                correct: {
                    count: 1,
                    name: '二氧化碳分子',
                    category: '化合物',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 3, 
                        atomTypes: 2, 
                        moleculeCount: 1, 
                        moleculeTypes: 1 
                    }
                }
            },
            {
                id: 'q4',
                symbol: 'H₂O',
                correctModelId: 'opt_H2O',
                correct: {
                    count: 1,
                    name: '水分子',
                    category: '化合物',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 3, 
                        atomTypes: 2, 
                        moleculeCount: 1, 
                        moleculeTypes: 1 
                    }
                }
            },
            {
                id: 'q5',
                symbol: 'O',
                correctModelId: 'opt_O',
                correct: {
                    count: 1,
                    name: '氧原子',
                    category: '元素',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 1, 
                        atomTypes: 1, 
                        moleculeCount: 0, 
                        moleculeTypes: 0 
                    }
                }
            },
            {
                id: 'q6',
                symbol: 'O₂',
                correctModelId: 'opt_O2',
                correct: {
                    count: 1,
                    name: '氧分子',
                    category: '元素',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 2, 
                        atomTypes: 1, 
                        moleculeCount: 1, 
                        moleculeTypes: 1 
                    }
                }
            },
            {
                id: 'q7',
                symbol: '2H₂O',
                correctModelId: 'opt_2H2O',
                correct: {
                    count: 2,
                    name: '水分子',
                    category: '化合物',
                    purity: '純物質',
                    composition: { 
                        totalAtoms: 6, 
                        atomTypes: 2, 
                        moleculeCount: 2, 
                        moleculeTypes: 1 
                    }
                }
            },
            {
                id: 'q8',
                symbol: 'H₂ + CO₂',
                correctModelId: 'opt_Mix',
                correct: {
                    count: 2,
                    name: '混合物(有幾個物質)',
                    category: '不適用',
                    purity: '混合物',
                    composition: { 
                        totalAtoms: 5,
                        atomTypes: 3,
                        moleculeCount: 2,
                        moleculeTypes: 2
                    }
                }
            }
        ];

        // --- 組件 ---

        const AtomCircle = ({ type, size }) => {
            const styles = ATOM_TYPES[type];
            
            let finalSize = size;
            if (!finalSize) {
                finalSize = type === 'H' ? 'sm' : 'lg';
            }

            const sizeClass = finalSize === 'lg' ? 'w-10 h-10' : 'w-7 h-7';
            const textSize = finalSize === 'lg' ? 'text-[10px]' : 'text-[8px]';
            
            return (
                <div className={`${sizeClass} ${styles.color} rounded-full border-2 flex items-center justify-center shadow-md z-10 ${textSize} font-bold shrink-0`}>
                </div>
            );
        };

        const ModelRenderer = ({ type, scale = 1 }) => {
            const scaleClass = scale === 0.5 ? 'transform scale-50 origin-center' : '';

            const renderContent = () => {
                if (type === '2H') {
                    return (
                        <div className="flex gap-4 items-center justify-center">
                            <AtomCircle type="H" />
                            <AtomCircle type="H" />
                        </div>
                    );
                }
                if (type === '2H₂') {
                    return (
                        <div className="flex gap-4 items-center justify-center">
                            <div className="flex -space-x-2">
                                <AtomCircle type="H" />
                                <AtomCircle type="H" />
                            </div>
                            <div className="flex -space-x-2">
                                <AtomCircle type="H" />
                                <AtomCircle type="H" />
                            </div>
                        </div>
                    );
                }
                if (type === 'CO₂') {
                    return (
                        <div className="flex items-center -space-x-2">
                            <AtomCircle type="O" />
                            <AtomCircle type="C" />
                            <AtomCircle type="O" />
                        </div>
                    );
                }
                if (type === 'H₂O') {
                    return (
                        <div className="relative w-12 h-12 flex justify-center items-center">
                            <div className="absolute top-0"><AtomCircle type="O"/></div>
                            <div className="absolute bottom-0 left-0 transform -translate-x-1"><AtomCircle type="H"/></div>
                            <div className="absolute bottom-0 right-0 transform translate-x-1"><AtomCircle type="H"/></div>
                        </div>
                    );
                }
                if (type === 'O') {
                    return (
                        <div className="flex justify-center">
                            <AtomCircle type="O" />
                        </div>
                    );
                }
                if (type === 'O₂') {
                    return (
                        <div className="flex justify-center -space-x-2">
                            <AtomCircle type="O" />
                            <AtomCircle type="O" />
                        </div>
                    );
                }
                if (type === '2H₂O') {
                    return (
                        <div className="flex gap-2 justify-center">
                            <div className="relative w-12 h-12 flex justify-center items-center">
                                <div className="absolute top-0"><AtomCircle type="O"/></div>
                                <div className="absolute bottom-0 left-0 transform -translate-x-1"><AtomCircle type="H"/></div>
                                <div className="absolute bottom-0 right-0 transform translate-x-1"><AtomCircle type="H"/></div>
                            </div>
                            <div className="relative w-12 h-12 flex justify-center items-center">
                                <div className="absolute top-0"><AtomCircle type="O"/></div>
                                <div className="absolute bottom-0 left-0 transform -translate-x-1"><AtomCircle type="H"/></div>
                                <div className="absolute bottom-0 right-0 transform translate-x-1"><AtomCircle type="H"/></div>
                            </div>
                        </div>
                    );
                }
                if (type === 'H₂+CO₂') {
                    return (
                        <div className="flex gap-3 items-center justify-center">
                            <div className="flex -space-x-2">
                                <AtomCircle type="H" />
                                <AtomCircle type="H" />
                            </div>
                            <div className="flex items-center -space-x-2">
                                <AtomCircle type="O" />
                                <AtomCircle type="C" />
                                <AtomCircle type="O" />
                            </div>
                        </div>
                    );
                }
                return null;
            };

            return <div className={scaleClass}>{renderContent()}</div>;
        };

        const ReviewRow = ({ label, user, correct }) => {
            const isCorrect = String(user).trim() === String(correct).trim();
            return (
                <tr>
                    <td className="py-2 text-gray-600 font-medium">{label}</td>
                    <td className={`py-2 font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>{user}</td>
                    <td className="py-2 text-gray-500">{correct}</td>
                </tr>
            );
        };

        // --- 主應用程式 ---
        function App() {
            const [step, setStep] = useState('login'); 
            const [studentInfo, setStudentInfo] = useState({ className: '', name: '', number: '' });
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [answers, setAnswers] = useState({}); 
            const [uploadStatus, setUploadStatus] = useState('idle');

            const [currentInput, setCurrentInput] = useState({
                selectedModelId: '',
                count: '',
                name: '',
                category: '',
                purity: '',
                totalAtoms: '',
                atomTypes: '',
                moleculeCount: '',
                moleculeTypes: ''
            });

            useEffect(() => {
                setCurrentInput({
                    selectedModelId: '',
                    count: '',
                    name: '',
                    category: '',
                    purity: '',
                    totalAtoms: '',
                    atomTypes: '',
                    moleculeCount: '',
                    moleculeTypes: ''
                });
            }, [currentQIndex]);

            const handleStart = () => {
                if (studentInfo.className && studentInfo.name && studentInfo.number) {
                    setStep('game');
                } else {
                    alert('請填寫班級、姓名和座號');
                }
            };

            const handleNext = () => {
                const q = QUESTIONS[currentQIndex];
                let correctPoints = 0;
                
                // 計分權重配置 (總分 > 100)
                // 模型選擇: 5分
                if (currentInput.selectedModelId === q.correctModelId) correctPoints += 5;
                
                // 填空欄位: 8個欄位，每格1分
                if (parseInt(currentInput.count) === q.correct.count) correctPoints += 1;
                if (currentInput.name === q.correct.name) correctPoints += 1;
                if (currentInput.category === q.correct.category) correctPoints += 1;
                if (currentInput.purity === q.correct.purity) correctPoints += 1;
                if (parseInt(currentInput.totalAtoms) === q.correct.composition.totalAtoms) correctPoints += 1;
                if (parseInt(currentInput.atomTypes) === q.correct.composition.atomTypes) correctPoints += 1;
                if (parseInt(currentInput.moleculeCount) === q.correct.composition.moleculeCount) correctPoints += 1;
                if (parseInt(currentInput.moleculeTypes) === q.correct.composition.moleculeTypes) correctPoints += 1;

                setAnswers(prev => ({
                    ...prev,
                    [q.id]: {
                        symbol: q.symbol,
                        user: currentInput,
                        correctModel: q.correctModelId,
                        correctData: q.correct,
                        points: correctPoints,
                        maxPoints: 13
                    }
                }));

                if (currentQIndex < QUESTIONS.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                } else {
                    calculateFinalScore();
                }
            };

            const calculateFinalScore = () => {
                setTimeout(() => {
                    setStep('result');
                }, 500);
            };

            const totalUserPoints = Object.values(answers).reduce((acc, curr) => acc + curr.points, 0);
            const finalScore = totalUserPoints; // 滿分 104

            const handleUpload = async () => {
                // 使用教師設定的 URL
                const targetUrl = TEACHER_SCRIPT_URL.trim();

                if (!targetUrl) {
                    alert('老師尚未在程式碼中設定上傳網址，無法上傳！請通知老師。');
                    return;
                }
                
                setUploadStatus('uploading');
                try {
                    const formData = new FormData();
                    formData.append('timestamp', new Date().toISOString());
                    formData.append('class', studentInfo.className);
                    formData.append('number', studentInfo.number);
                    formData.append('name', studentInfo.name);
                    formData.append('score', finalScore);
                    formData.append('detail', JSON.stringify(answers));

                    await fetch(targetUrl, { method: 'POST', body: formData, mode: 'no-cors' });
                    setUploadStatus('success');
                } catch (error) {
                    console.error(error);
                    setUploadStatus('error');
                }
            };

            // --- 畫面渲染 ---

            if (step === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <h1 className="text-3xl font-bold text-center text-indigo-800 mb-6">縮小燈大冒險<br/><span className="text-xl text-indigo-600">原子分子的微觀派對</span></h1>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">班級</label>
                                    <div className="relative">
                                        <School className="absolute left-3 top-3 text-gray-400" size={18} />
                                        <input
                                            type="text"
                                            className="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                            placeholder="例如：801"
                                            value={studentInfo.className}
                                            onChange={e => setStudentInfo({ ...studentInfo, className: e.target.value })}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">座號</label>
                                    <input
                                        type="number"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="例如：15"
                                        value={studentInfo.number}
                                        onChange={e => setStudentInfo({ ...studentInfo, number: e.target.value })}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                                    <input
                                        type="text"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                        placeholder="請輸入真實姓名"
                                        value={studentInfo.name}
                                        onChange={e => setStudentInfo({ ...studentInfo, name: e.target.value })}
                                    />
                                </div>
                                <button
                                    onClick={handleStart}
                                    className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2 mt-4"
                                >
                                    開始大冒險 <Play size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'game') {
                const q = QUESTIONS[currentQIndex];
                return (
                    <div className="min-h-screen bg-gray-50 p-4 pb-20">
                        <div className="max-w-4xl mx-auto">
                            {/* Header Info */}
                            <div className="flex justify-between items-center mb-6">
                                <span className="font-bold text-gray-600">
                                    第 {currentQIndex + 1} / {QUESTIONS.length} 題
                                </span>
                                <span className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-medium">
                                    {studentInfo.className}班 {studentInfo.number}號 {studentInfo.name}
                                </span>
                            </div>

                            {/* 題目區 */}
                            <div className="w-full bg-blue-600 text-white rounded-xl p-6 mb-6 shadow-lg text-center">
                                <h2 className="text-3xl font-bold tracking-wider">題目：{q.symbol}</h2>
                                <p className="text-blue-100 mt-2 text-sm">請依照題目化學式，選出正確的模型圖並完成分析</p>
                            </div>

                            {/* 模型選擇區 */}
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-l-4 border-blue-500">
                                <div className="flex flex-wrap items-center justify-between mb-4 gap-2">
                                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                        <MousePointerClick size={20} className="text-blue-600"/> 
                                        選擇正確的原子模型
                                    </h3>
                                    
                                    <div className="flex gap-3 text-sm font-normal bg-gray-50 px-3 py-1 rounded-lg border border-gray-100">
                                        <div className="flex items-center gap-1">
                                            <div className="w-4 h-4 rounded-full bg-gray-100 border border-gray-400"></div>
                                            <span className="text-gray-600">H</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <div className="w-4 h-4 rounded-full bg-gray-900 border border-gray-700"></div>
                                            <span className="text-gray-600">C</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <div className="w-4 h-4 rounded-full bg-red-500 border border-red-700"></div>
                                            <span className="text-gray-600">O</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {MODEL_OPTIONS.map((option) => (
                                        <button
                                            key={option.id}
                                            onClick={() => setCurrentInput({ ...currentInput, selectedModelId: option.id })}
                                            className={`
                                                relative p-3 rounded-xl border-2 transition-all duration-200 flex flex-col items-center gap-2 h-24 justify-center
                                                ${currentInput.selectedModelId === option.id 
                                                ? 'border-blue-500 bg-blue-50 shadow-md scale-105' 
                                                : 'border-gray-200 hover:border-blue-200 hover:bg-gray-50'}
                                            `}
                                        >
                                            <div className="flex items-center justify-center w-full">
                                                <ModelRenderer type={option.type} />
                                            </div>
                                            {currentInput.selectedModelId === option.id && (
                                                <div className="absolute top-1 right-1 text-blue-600">
                                                    <CheckCircle size={14} />
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>
                                <div className="text-center mt-4 h-6">
                                    {currentInput.selectedModelId ? (
                                        <span className="text-blue-600 font-medium text-sm">
                                            已選擇模型
                                        </span>
                                    ) : (
                                        <span className="text-gray-400 text-sm">請點擊上方其中一個選項</span>
                                    )}
                                </div>
                            </div>

                            {/* Form Area - 填空區 */}
                            <div className="bg-white rounded-xl shadow-lg p-6 space-y-6">
                                
                                {/* 1. 名稱與數量 */}
                                <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <h3 className="font-bold text-yellow-800 mb-3 flex items-center gap-2">
                                        ➊ 名稱識別
                                    </h3>
                                    <div className="flex flex-wrap items-center gap-2 text-lg">
                                        <span>圖中有</span>
                                        <input
                                            type="number"
                                            className="w-16 p-2 border-b-2 border-indigo-300 bg-transparent text-center focus:border-indigo-600 outline-none font-bold"
                                            value={currentInput.count}
                                            onChange={e => setCurrentInput({ ...currentInput, count: e.target.value })}
                                        />
                                        <span>個</span>
                                        <select
                                            className="p-2 border rounded bg-white min-w-[10rem]"
                                            value={currentInput.name}
                                            onChange={e => setCurrentInput({ ...currentInput, name: e.target.value })}
                                        >
                                            <option value="">請選擇</option>
                                            <option value="氫原子">氫原子</option>
                                            <option value="氫分子">氫分子</option>
                                            <option value="氧原子">氧原子</option>
                                            <option value="氧分子">氧分子</option>
                                            <option value="水分子">水分子</option>
                                            <option value="二氧化碳分子">二氧化碳分子</option>
                                            <option value="混合物(有幾個物質)">混合物(有幾個物質)</option>
                                        </select>
                                    </div>
                                </div>

                                {/* 2. 分類 */}
                                <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                                    <h3 className="font-bold text-green-800 mb-3">➋ 物質分類</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">化學分類</label>
                                            <div className="flex gap-1">
                                                {['元素', '化合物', '不適用'].map(opt => (
                                                    <button
                                                        key={opt}
                                                        onClick={() => setCurrentInput({ ...currentInput, category: opt })}
                                                        className={`flex-1 py-2 text-sm rounded border transition-colors ${
                                                            currentInput.category === opt 
                                                            ? 'bg-green-600 text-white border-green-600' 
                                                            : 'bg-white text-gray-600 border-gray-300 hover:bg-green-50'
                                                        }`}
                                                    >
                                                        {opt}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm text-gray-600 mb-1">純度分類</label>
                                            <div className="flex gap-2">
                                                {['純物質', '混合物'].map(opt => (
                                                    <button
                                                        key={opt}
                                                        onClick={() => setCurrentInput({ ...currentInput, purity: opt })}
                                                        className={`flex-1 py-2 rounded border transition-colors ${
                                                            currentInput.purity === opt 
                                                            ? 'bg-green-600 text-white border-green-600' 
                                                            : 'bg-white text-gray-600 border-gray-300 hover:bg-green-50'
                                                        }`}
                                                    >
                                                        {opt}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* 3. 組成統計 */}
                                <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                                    <h3 className="font-bold text-purple-800 mb-3">➌ 組成分析</h3>
                                    <div className="space-y-3">
                                        <div className="flex justify-between items-center border-b border-purple-100 pb-2">
                                            <span className="text-gray-700">總共有幾個原子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none"
                                                value={currentInput.totalAtoms}
                                                onChange={e => setCurrentInput({ ...currentInput, totalAtoms: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex justify-between items-center border-b border-purple-100 pb-2">
                                            <span className="text-gray-700">有幾「種」原子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none"
                                                value={currentInput.atomTypes}
                                                onChange={e => setCurrentInput({ ...currentInput, atomTypes: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex justify-between items-center border-b border-purple-100 pb-2 bg-purple-100/50 px-2 rounded">
                                            <span className="text-purple-900 font-bold">有幾個分子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none font-bold"
                                                value={currentInput.moleculeCount}
                                                onChange={e => setCurrentInput({ ...currentInput, moleculeCount: e.target.value })}
                                            />
                                        </div>
                                        <div className="flex justify-between items-center px-2">
                                            <span className="text-gray-700">有幾「種」分子？</span>
                                            <input
                                                type="number"
                                                className="w-20 p-2 border rounded text-center focus:ring-2 focus:ring-purple-300 outline-none"
                                                value={currentInput.moleculeTypes}
                                                onChange={e => setCurrentInput({ ...currentInput, moleculeTypes: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <button
                                onClick={handleNext}
                                className="w-full mt-6 bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-2"
                            >
                                {currentQIndex === QUESTIONS.length - 1 ? '提交答案' : '下一題'} <ChevronRight />
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'result') {
                return (
                    <div className="min-h-screen bg-gray-100 p-4">
                        <div className="max-w-3xl mx-auto space-y-6">
                            
                            {/* Result Header */}
                            <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                                <div className="inline-flex items-center justify-center w-20 h-20 bg-yellow-100 rounded-full mb-4">
                                    <BarChart size={40} className="text-yellow-600" />
                                </div>
                                <h2 className="text-3xl font-bold text-gray-800">測驗完成！</h2>
                                <p className="text-gray-500 mt-2">{studentInfo.className}班 {studentInfo.number}號 {studentInfo.name}</p>
                                <div className="mt-6 text-6xl font-extrabold text-indigo-700">{finalScore} <span className="text-2xl text-gray-500">分</span></div>
                                <p className="text-sm text-gray-400 mt-2">滿分 104 分</p>
                            </div>

                            {/* Upload Section (Modified for Teacher Hardcoded URL) */}
                            <div className="bg-white rounded-2xl shadow-lg p-6">
                                <h3 className="font-bold text-gray-700 border-b pb-2 mb-4">步驟一：上傳成績</h3>
                                <div className="space-y-3">
                                    <div className="p-3 bg-blue-50 text-blue-800 text-sm rounded-lg mb-2">
                                        請點擊下方按鈕將成績上傳至老師的雲端硬碟。
                                    </div>
                                    
                                    {uploadStatus === 'idle' && (
                                        <button
                                            onClick={handleUpload}
                                            className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2"
                                        >
                                            <Send size={18} /> 上傳至雲端
                                        </button>
                                    )}
                                    {uploadStatus === 'uploading' && (
                                        <button disabled className="w-full bg-gray-400 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                            <RefreshCw className="animate-spin" size={18} /> 上傳中...
                                        </button>
                                    )}
                                    {uploadStatus === 'success' && (
                                        <div className="w-full bg-green-100 text-green-700 py-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-green-300">
                                            <CheckCircle size={18} /> 上傳成功！
                                        </div>
                                    )}
                                    {uploadStatus === 'error' && (
                                        <div className="w-full bg-red-100 text-red-700 py-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-red-300">
                                            <AlertCircle size={18} /> 上傳失敗，請檢查網路或通知老師
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Review Section (作答檢討) */}
                            <div className="bg-white rounded-2xl shadow-lg p-6">
                                <h3 className="font-bold text-gray-700 border-b pb-2 mb-4 flex items-center gap-2">
                                    <Search size={20}/> 步驟二：作答檢討報告
                                </h3>
                                
                                <div className="space-y-8">
                                    {Object.values(answers).map((ans, idx) => {
                                        const isModelCorrect = ans.user.selectedModelId === ans.correctModel;
                                        return (
                                            <div key={idx} className="border border-gray-200 rounded-xl overflow-hidden">
                                                <div className="bg-gray-50 px-4 py-3 flex justify-between items-center border-b">
                                                    <span className="font-bold text-lg text-gray-700">題目：{ans.symbol}</span>
                                                    <span className={`px-2 py-1 rounded text-sm font-bold ${ans.points === ans.maxPoints ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                        得分：{ans.points} / {ans.maxPoints}
                                                    </span>
                                                </div>
                                                
                                                <div className="p-4 grid md:grid-cols-2 gap-6">
                                                    {/* Left: Model Comparison */}
                                                    <div>
                                                        <h4 className="text-sm font-bold text-gray-500 mb-2">模型選擇</h4>
                                                        <div className="flex gap-4 items-start">
                                                            <div className="flex flex-col items-center">
                                                                <span className="text-xs text-gray-500 mb-1">你的選擇</span>
                                                                <div className={`p-2 border-2 rounded-lg ${isModelCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}`}>
                                                                    {ans.user.selectedModelId ? (
                                                                        <ModelRenderer type={MODEL_OPTIONS.find(o => o.id === ans.user.selectedModelId)?.type} scale={0.5} />
                                                                    ) : <XCircle className="text-red-400" />}
                                                                </div>
                                                            </div>
                                                            <div className="flex flex-col items-center">
                                                                <span className="text-xs text-gray-500 mb-1">正確答案</span>
                                                                <div className="p-2 border-2 border-green-500 bg-green-50 rounded-lg">
                                                                    <ModelRenderer type={MODEL_OPTIONS.find(o => o.id === ans.correctModel)?.type} scale={0.5} />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Right: Data Comparison Table */}
                                                    <div>
                                                        <h4 className="text-sm font-bold text-gray-500 mb-2">作答詳細比對</h4>
                                                        <table className="w-full text-sm">
                                                            <thead>
                                                                <tr className="text-left text-gray-400 text-xs">
                                                                    <th className="pb-1">項目</th>
                                                                    <th className="pb-1">你的答案</th>
                                                                    <th className="pb-1">正確答案</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y">
                                                                <ReviewRow label="數量/名稱" user={`${ans.user.count}個 ${ans.user.name}`} correct={`${ans.correctData.count}個 ${ans.correctData.name}`} />
                                                                <ReviewRow label="分類" user={`${ans.user.category} / ${ans.user.purity}`} correct={`${ans.correctData.category} / ${ans.correctData.purity}`} />
                                                                <ReviewRow label="原子總數" user={ans.user.totalAtoms} correct={ans.correctData.composition.totalAtoms} />
                                                                <ReviewRow label="原子種類" user={ans.user.atomTypes} correct={ans.correctData.composition.atomTypes} />
                                                                <ReviewRow label="分子個數" user={ans.user.moleculeCount} correct={ans.correctData.composition.moleculeCount} />
                                                                <ReviewRow label="分子種類" user={ans.user.moleculeTypes} correct={ans.correctData.composition.moleculeTypes} />
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="text-center pt-8">
                                <button onClick={() => window.location.reload()} className="text-gray-400 text-sm underline hover:text-gray-600">
                                重新開始測驗
                                </button>
                            </div>

                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>