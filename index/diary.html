<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸福365</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設置字體為 標楷體 -->
    <style>
        /* 應用自訂字體 */
        body, .font-journal {
            /* 'DFKai-sb' 是標楷體 */
            font-family: 'DFKai-sb', 'BiauKaiTC', serif;
            font-size: 1.15rem; /* 調整為適合標楷體的大小 */
            line-height: 1.8; /* 調整行高 */
        }
        
        /* 內頁圖案 (圖2) - 作為背景 */
        body {
            /* 圖2：內頁圖案。請將 URL 替換為您自己的圖片連結 */
            background-image: url('圖2.jpg');
            background-repeat: repeat;
            background-color: #fefae0; /* 溫暖的底色 */
        }

        /* 編輯器樣式 */
        #editor {
            min-height: 400px;
            border: 1px solid #d4a373;
            background: #faedcd; /* 淺米黃色紙張 */
            padding: 20px;
            font-size: 1.25rem; /* 調整編輯器字體大小 */
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            line-height: 2.0; /* 調整行高 */
        }

        /* 編輯器佔位符 */
        #editor:empty:before {
            content: "在這裡開始書寫您的幸福... (請注意：目前版本專注於文字，請勿貼上圖片)";
            color: #a98467;
            cursor: text;
        }
        
        /* 列印樣式 */
        @media print {
            /* 隱藏所有不需要列印的UI元素 */
            body > :not(.print-area) {
                display: none !important;
            }
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                background: white;
            }
            .print-entry {
                page-break-after: always;
                background: white;
                font-family: 'DFKai-sb', 'BiauKaiTC', serif; /* 列印時使用更易讀的標楷體 */
                font-size: 12pt;
                line-height: 1.8;
            }
            .print-entry img {
                max-width: 100% !important; /* 確保圖片大小正確 */
            }
            .print-title {
                font-size: 16pt;
                font-weight: bold;
                margin-bottom: 5px;
            }
            .print-meta {
                font-size: 10pt;
                color: #555;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body class="bg-amber-50 text-amber-900 p-4 md:p-8 font-journal">

    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- 圖1：封面圖片 -->
        <img src="圖1.jpg" 
             alt="幸福365 封面" 
             class="w-full h-48 md:h-72 object-cover rounded-lg shadow-lg mb-8"
             onerror="this.src='https://placehold.co/1200x300/d4a373/faedcd?text=封面圖片載入失敗'">

        <h1 class="text-4xl md:text-6xl text-center text-amber-800 mb-8" style="font-family: 'DFKai-sb', 'BiauKaiTC', serif;">
            ＜幸福365＞
        </h1>

        <!-- 登入/狀態區 -->
        <div class="no-print text-center mb-4 p-3 bg-amber-100 rounded-lg shadow-sm">
            <span id="auth-status">連線中...</span>
            <span class="ml-4">使用者ID: <strong id="user-id-display"></strong></span>
        </div>

        <div class="flex flex-col md:flex-row gap-8">
            
            <!-- 左側：目錄 -->
            <aside class="w-full md:w-1/3 lg:w-1/4 no-print">
                <div class="bg-amber-100 p-4 rounded-lg shadow-md sticky top-8">
                    <h2 class="text-3xl text-amber-800 border-b-2 border-amber-300 pb-2 mb-4">
                        手札目錄
                    </h2>
                    <div id="toc-container" class="space-y-2 max-h-[70vh] overflow-y-auto">
                        <!-- 目錄內容將由 JS 動態生成 -->
                        <p class="text-amber-600">載入日記中...</p>
                    </div>
                </div>
            </aside>

            <!-- 右側：編輯區和日記顯示 -->
            <main class="w-full md:w-2/3 lg:w-3/4">
                <div class="bg-amber-100 p-6 rounded-lg shadow-lg">
                    <!-- 操作按鈕 -->
                    <div class="flex flex-wrap gap-3 mb-4 no-print">
                        <button id="new-entry-btn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            寫新日記
                        </button>
                        <button id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            儲存本篇
                        </button>
                        <button id="print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            列印本篇 (PDF)
                        </button>
                        <button id="download-all-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            打包下載全部 (PDF)
                        </button>
                    </div>

                    <!-- 日記元數據 -->
                    <div id="entry-meta-display" class="mb-4 p-3 bg-white rounded-md text-amber-800 text-xl shadow-inner">
                        <span id="entry-title">新日記</span> | <span id="entry-timestamp"></span>
                    </div>

                    <!-- 警告訊息 -->
                    <p class="text-sm text-red-600 mb-3 no-print">
                        (提醒：請專注文字書寫。若需上傳圖片，請使用下方的「上傳圖片」功能。)
                    </p>
                    
                    <!-- 編輯器 -->
                    <div id="editor-wrapper" class="print-area">
                        <!-- 'print-entry' 用於單篇列印 -->
                        <div id="editor-content" class="print-entry">
                            <h2 id="print-title-display" class="print-title hidden"></h2>
                            <p id="print-meta-display" class="print-meta hidden"></p>
                            <!-- 可編輯區域 -->
                            <div id="editor" 
                                 contenteditable="true" 
                                 class="bg-white rounded-b-lg p-6 shadow-inner focus:outline-none focus:ring-2 focus:ring-amber-500"
                                 role="textbox" 
                                 aria-multiline="true">
                            </div>
                        </div>
                    </div>

                    <!-- 圖片上傳區 -->
                    <div class="mt-6 no-print">
                        <label for="image-upload" class="block text-xl text-amber-800 mb-2">上傳一張圖片 (5MB限制)</label>
                        <input type="file" id="image-upload" accept="image/*"
                               class="block w-full text-sm text-amber-700
                                      file:mr-4 file:py-2 file:px-4
                                      file:rounded-lg file:border-0
                                      file:text-sm file:font-semibold
                                      file:bg-amber-200 file:text-amber-800
                                      hover:file:bg-amber-300
                                      file:cursor-pointer">
                        <span id="upload-status" class="text-sm text-blue-600 ml-2"></span>
                    </div>

                    <!-- 圖片顯示區 -->
                    <div id="image-display-wrapper" class="mt-4 print-area">
                        <!-- 圖片將顯示在這裡 -->
                    </div>
                </div>
            </main>
        </div>

        <!-- 圖3：封底圖片 -->
        <img src="圖3.png" 
             alt="幸福365 封底" 
             class="w-full h-24 object-cover rounded-lg shadow-lg mt-16 no-print"
             onerror="this.src='https://placehold.co/1200x100/d4a373/faedcd?text=封底圖片載入失敗'">
    </div>

    <!-- 用於「打包下載全部」的隱藏列印區域 -->
    <div id="print-all-container" class="print-area hidden"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            onSnapshot, 
            collection, 
            query,
            updateDoc,
            serverTimestamp,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase 設定 ---
        
        // 取得 Canvas 環境提供的設定
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 初始化 Firebase
        let app, auth, db, storage;
        let userId = null;
        let entriesCollection;
        let allEntries = [];
        let currentEntryId = null;
 
        // --- DOM 元素 ---
        const tocContainer = document.getElementById('toc-container');
        const editor = document.getElementById('editor');
        const entryTitle = document.getElementById('entry-title');
        const entryTimestamp = document.getElementById('entry-timestamp');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const newEntryBtn = document.getElementById('new-entry-btn');
        const saveBtn = document.getElementById('save-btn');
        const printBtn = document.getElementById('print-btn');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const imageUpload = document.getElementById('image-upload');
        const uploadStatus = document.getElementById('upload-status');
        const imageDisplayWrapper = document.getElementById('image-display-wrapper');

        // --- 核心功能 ---

        /**
         * 格式化日期時間
         * @param {Date} dateObj - 日期物件
         * @returns {string} - 格式化後的字串, e.g., "2025.10.30 11:08pm"
         */
        function formatJournalTimestamp(dateObj) {
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            
            let hours = dateObj.getHours();
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 點應為 12
            const hoursStr = hours.toString().padStart(2, '0');
            
            return `${year}.${month}.${day} ${hoursStr}:${minutes}${ampm}`;
        }

        /**
         * 登入並初始化應用
         */
        async function signInAndInit() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                // 設定登入狀態持久化
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = "已連線";
                        userIdDisplay.textContent = userId;
                        // 設定資料庫路徑
                        entriesCollection = collection(db, `artifacts/${appId}/users/${userId}/entries`);
                        // 載入日記
                        loadEntries();
                    } else {
                        authStatus.textContent = "未登入";
                        userIdDisplay.textContent = "N/A";
                    }
                });

                // 根據是否有 token 決定登入方式
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                authStatus.textContent = "連線失敗";
            }
        }

        /**
         * 載入並監聽所有日記
         */
        function loadEntries() {
            if (!entriesCollection) return;

            const q = query(entriesCollection);
            
            onSnapshot(q, (snapshot) => {
                allEntries = [];
                snapshot.forEach((doc) => {
                    allEntries.push({ id: doc.id, ...doc.data() });
                });
                
                // 排序：確保 entryNumber 是數字並正確排序
                allEntries.sort((a, b) => (a.entryNumber || 0) - (b.entryNumber || 0));
                
                // 重新渲染目錄
                renderTOC();
                
                // 如果當前沒有在編輯，就顯示最新一篇
                if (currentEntryId === null && allEntries.length > 0) {
                    displayEntry(allEntries[allEntries.length - 1].id);
                } else if (currentEntryId) {
                    // 重新整理目前顯示的
                    displayEntry(currentEntryId);
                } else {
                    // 如果一篇都沒有，就顯示新日記
                    handleNewEntry();
                }

            }, (error) => {
                console.error("載入日記失敗:", error);
            });
        }

        /**
         * 渲染目錄 (TOC)
         */
        function renderTOC() {
            tocContainer.innerHTML = ''; // 清空目錄
            if (allEntries.length === 0) {
                tocContainer.innerHTML = '<p class="text-amber-600">還沒有任何日記喔！</p>';
                return;
            }

            // 按照30篇分組
            const groups = {};
            allEntries.forEach(entry => {
                const groupIndex = Math.floor((entry.entryNumber - 1) / 30);
                const start = groupIndex * 30 + 1;
                const end = start + 29;
                const groupName = `幸福365-${start}～${end}`;
                
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(entry);
            });

            // 產生 HTML
            for (const groupName in groups) {
                const groupWrapper = document.createElement('details');
                groupWrapper.className = 'mb-2';
                groupWrapper.open = true; // 預設展開

                const summary = document.createElement('summary');
                summary.className = 'text-xl font-bold text-amber-800 cursor-pointer hover:text-amber-600';
                summary.textContent = groupName;
                groupWrapper.appendChild(summary);

                const entryList = document.createElement('ul');
                entryList.className = 'pl-4 mt-2 space-y-1';
                
                groups[groupName].forEach(entry => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = `${entry.title}`;
                    link.className = `block text-amber-700 hover:text-amber-900 hover:font-bold ${entry.id === currentEntryId ? 'font-bold text-amber-900' : ''}`;
                    link.dataset.id = entry.id;
                    link.onclick = (e) => {
                        e.preventDefault();
                        displayEntry(link.dataset.id);
                        // 更新TOC中 "active" 狀態
                        document.querySelectorAll('#toc-container a').forEach(a => a.classList.remove('font-bold', 'text-amber-900'));
                        link.classList.add('font-bold', 'text-amber-900');
                    };
                    li.appendChild(link);
                    entryList.appendChild(li);
                });
                
                groupWrapper.appendChild(entryList);
                tocContainer.appendChild(groupWrapper);
            }
        }

        /**
         * 在編輯器中顯示指定的日記
         * @param {string} entryId - 日記的 Firestore 文件 ID
         */
        function displayEntry(entryId) {
            const entry = allEntries.find(e => e.id === entryId);
            if (!entry) {
                console.warn(`找不到 ID 為 ${entryId} 的日記`);
                return;
            }
            
            currentEntryId = entry.id;
            editor.innerHTML = entry.content || '';
            entryTitle.textContent = entry.title || '讀取中...';
            entryTimestamp.textContent = entry.formattedTimestamp || '...';

            // 處理圖片顯示
            imageDisplayWrapper.innerHTML = ''; // 清空舊圖
            imageUpload.value = null; // 清空檔案選擇
            uploadStatus.textContent = ''; // 清空狀態

            if (entry.imageUrl) {
                const img = document.createElement('img');
                img.src = entry.imageUrl;
                img.className = 'w-full max-w-lg h-auto rounded-lg shadow-md mx-auto'; // 限制圖片最大寬度
                img.alt = entry.title;
                imageDisplayWrapper.appendChild(img);
            }
            
            // 更新TOC的活躍狀態
            renderTOC();
        }

        /**
         * 準備寫新日記
         */
        function handleNewEntry() {
            currentEntryId = null;
            editor.innerHTML = '';
            entryTitle.textContent = '新日記 (尚未儲存)';
            entryTimestamp.textContent = formatJournalTimestamp(new Date());
            editor.focus();

            // 清空圖片相關欄位
            imageDisplayWrapper.innerHTML = '';
            imageUpload.value = null;
            uploadStatus.textContent = '';
            
            // 更新TOC的活躍狀態
            renderTOC();
        }

        /**
         * 儲存 (新增或更新) 日記
         */
        async function handleSaveEntry() {
            if (!userId) {
                showModal("尚未登入，無法儲存");
                return;
            }
 
            const content = editor.innerHTML;
            if (content.trim().length === 0) {
                showModal("日記內容不能為空喔！");
                return;
            }
 
            saveBtn.textContent = '儲存中...';
            saveBtn.disabled = true;
            uploadStatus.textContent = '';

            let entryId = currentEntryId;
 
            try {
                if (entryId) {
                    // --- 1. 更新現有日記 (僅文字) ---
                    const entryRef = doc(db, `artifacts/${appId}/users/${userId}/entries`, entryId);
                    await updateDoc(entryRef, {
                        content: content,
                        updatedAt: serverTimestamp() // 更新修改時間
                    });
                 } else {
                    // --- 1. 新增日記 (僅文字) ---
                    const nextEntryNumber = allEntries.length > 0 ? Math.max(...allEntries.map(e => e.entryNumber)) + 1 : 1;
                    const newTitle = `幸福365-${nextEntryNumber}`;
                    const now = new Date();
                    const newFormattedTimestamp = formatJournalTimestamp(now);
                    
                    const newEntry = {
                        entryNumber: nextEntryNumber,
                        title: newTitle,
                        content: content,
                        createdAt: Timestamp.fromDate(now), // 使用 Timestamp
                        formattedTimestamp: newFormattedTimestamp
                    };

                    const docRef = await addDoc(entriesCollection, newEntry);
                    entryId = docRef.id;
                    currentEntryId = docRef.id; // 儲存後，即變為 "更新" 模式
                     
                     // 手動更新UI，等待 onSnapshot 自動刷新
                    entryTitle.textContent = newTitle;
                    entryTimestamp.textContent = newFormattedTimestamp;
                }

                // --- 2. 處理圖片上傳 (如果有的話) ---
                const file = imageUpload.files[0];
                if (file) {
                    // 檢查檔案大小 (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showModal("圖片檔案過大！請上傳 5MB 以下的圖片。 (文字已儲存)");
                        return; // finally 區塊會執行
                    }

                    uploadStatus.textContent = '圖片上傳中...';
                    // 建立儲存路徑
                    const imageRef = ref(storage, `artifacts/${appId}/users/${userId}/${entryId}/${file.name}`);
                    
                    // 上傳檔案
                    await uploadBytes(imageRef, file);
                    
                    // 取得下載 URL
                    const downloadURL = await getDownloadURL(imageRef);

                    // --- 3. 將圖片 URL 更新回 Firestore 文件 ---
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/entries`, entryId), {
                        imageUrl: downloadURL
                    });

                    uploadStatus.textContent = '圖片上傳成功！';
                    imageUpload.value = null; // 清除已上傳的檔案
                    
                    // (onSnapshot 會自動更新UI，但為求即時，手動觸發一次)
                    const entry = allEntries.find(e => e.id === entryId);
                    if (entry) entry.imageUrl = downloadURL;
                    displayEntry(entryId);
                }

                showModal("幸福+1！日記已儲存！");

            } catch (error) {
                console.error("儲存日記失敗:", error);
                showModal("儲存失敗！可能是日記內容過大或網路問題。");
            } finally {
                saveBtn.textContent = '儲存本篇';
                saveBtn.disabled = false;
                // 延遲一點時間清除狀態
                setTimeout(() => {
                    if (uploadStatus.textContent.includes('成功')) {
                        uploadStatus.textContent = '';
                    }
                }, 3000);
            }
        }

        /**
         * 列印當前日記 (存為 PDF)
         */
        function handlePrintEntry() {
            if (!currentEntryId) {
                showModal("請先儲存這篇新日記，才能列印喔！");
                return;
            }
            
            const entry = allEntries.find(e => e.id === currentEntryId);
            if (!entry) return;

            // 準備列印內容
            const printContent = document.getElementById('editor-content');
            
            // 填充標題和元數據 (僅供列印)
            document.getElementById('print-title-display').textContent = entry.title;
            document.getElementById('print-title-display').classList.remove('hidden');
            
            document.getElementById('print-meta-display').textContent = entry.formattedTimestamp;
            document.getElementById('print-meta-display').classList.remove('hidden');

            // 填充日記內容
            editor.innerHTML = entry.content; // 確保是儲存的文字內容

            // 處理圖片 (確保列印時圖片也顯示)
            imageDisplayWrapper.innerHTML = ''; // 清空
            if (entry.imageUrl) {
                const img = document.createElement('img');
                img.src = entry.imageUrl;
                img.className = 'w-full max-w-lg h-auto rounded-lg shadow-md mx-auto';
                img.alt = entry.title;
                imageDisplayWrapper.appendChild(img);
            }
            
            // 隱藏可編輯的 editor, 顯示靜態內容 (如果需要)
            // 在這裡，我們直接列印 #editor-content 和 #image-display-wrapper 區域

            // 觸發瀏覽器列印
            window.print();
            
            // 列印後還原 (恢復到目前編輯的狀態)
            document.getElementById('print-title-display').classList.add('hidden');
            document.getElementById('print-meta-display').classList.add('hidden');
            displayEntry(currentEntryId); // 重新載入當前日記
        }

        /**
         * 打包下載所有日記 (存為 PDF)
         */
        function handleDownloadAll() {
            if (allEntries.length === 0) {
                showModal("還沒有日記可以下載喔！");
                return;
            }

            const printContainer = document.getElementById('print-all-container');
            printContainer.innerHTML = ''; // 清空舊內容
            printContainer.classList.remove('hidden'); // 顯示

            // 建立一個包含所有日記的 HTML
            allEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'print-entry';
                
                const title = document.createElement('h2');
                title.className = 'print-title';
                title.textContent = entry.title;
                
                const meta = document.createElement('p');
                meta.className = 'print-meta';
                meta.textContent = entry.formattedTimestamp;
                
                const content = document.createElement('div');
                content.innerHTML = entry.content;
                
                // 加入圖片
                let imageHtml = '';
                if (entry.imageUrl) {
                    imageHtml = `<img src="${entry.imageUrl}" style="max-width: 90%; height: auto; margin: 10px auto; display: block; border-radius: 8px;" alt="${entry.title}">`;
                }

                entryDiv.appendChild(title);
                entryDiv.appendChild(meta);
                entryDiv.appendChild(content);
                if (entry.imageUrl) {
                    const imgContainer = document.createElement('div');
                    imgContainer.innerHTML = imageHtml;
                    entryDiv.appendChild(imgContainer);
                }
                printContainer.appendChild(entryDiv);
            });

            window.print(); // 觸發列印
            
            // 列印後再次隱藏
            printContainer.classList.add('hidden');
        }

        // --- 事件監聽 ---
        newEntryBtn.addEventListener('click', handleNewEntry);
        saveBtn.addEventListener('click', handleSaveEntry);
        printBtn.addEventListener('click', handlePrintEntry);
        downloadAllBtn.addEventListener('click', handleDownloadAll);

        // --- 啟動 ---
        signInAndInit();

        // --- 輔助功能：自訂提示框 ---
        // (因為 alert() 和 confirm() 在 iframe 中可能被阻擋)
        function showModal(message) {
            // 暫時使用 alert, 因為建立自訂 modal 需要更多 HTML 和 CSS
            // TODO: 建立一個真正的 HTML 彈窗
            alert(message);
        }
    </script>
</body>
</html>

