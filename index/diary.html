<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸福365 (本機離線版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設置字體為 標楷體 -->
    <style>
        /* 應用自訂字體 */
        body, .font-journal {
            font-family: 'DFKai-sb', 'BiauKaiTC', serif;
            font-size: 1.15rem; /* 調整為適合標楷體的大小 */
            line-height: 1.8; /* 調整行高 */
        }
        
        /* 內頁圖案 (圖2) - 作為背景 */
        body {
            background-image: url('圖2.jpg');
            background-repeat: repeat;
            background-color: #fefae0;
        }

        /* 編輯器樣式 */
        #editor {
            min-height: 400px;
            border: 1px solid #d4a373;
            background: #faedcd;
            padding: 20px;
            font-size: 1.25rem;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            line-height: 2.0;
        }

        /* 編輯器佔位符 */
        #editor:empty:before {
            content: "在這裡開始書寫您的幸福 (本機儲存版，僅支援文字)...";
            color: #a98467;
            cursor: text;
        }
        
        /* 列印樣式 */
        @media print {
            /* 強制瀏覽器列印背景圖案和顏色 */
            body, .print-entry {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* 讓 body 的背景在列印時可見 */
            body {
                background-image: url('圖2.jpg'); /* 再次指定以確保 */
                background-repeat: repeat;
                background-color: #fefae0;
            }

            body > :not(.print-area) { display: none !important; }
            .no-print { display: none !important; }
            .print-area { 
                display: block !important; 
                margin: 0; 
                padding: 0; 
                box-shadow: none; 
                border: none; 
                background: transparent; /* 移除白色背景，使其透明以顯示 body 背景 */
            }
            .print-entry { 
                page-break-after: always; 
                background: transparent; /* 移除白色背景 */
                font-family: 'DFKai-sb', 'BiauKaiTC', serif; 
                font-size: 16pt; 
                line-height: 1.8; 
                color: #FFFFFF; /* 依要求改為白色 */
            }
            .print-entry img { display: none; } /* 本機版不支援圖片 */
            .print-title { 
                font-size: 18pt; 
                font-weight: bold; 
                margin-bottom: 5px; 
                color: #FFFFE0; /* 依要求改為米黃色 */
            }
            .print-meta { 
                font-size: 12pt; 
                color: #00FFFF; /* 依要求改為亮藍色 */
                margin-bottom: 20px; 
            }
        }
    </style>
</head>
<body class="bg-amber-50 text-amber-900 p-4 md:p-8 font-journal">

    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- 圖1：封面圖片 -->
        <img src="圖1.jpg" 
             alt="幸福365 封面" 
             class="w-full h-48 md:h-72 object-cover rounded-lg shadow-lg mb-8"
             onerror="this.src='https://placehold.co/1200x300/d4a373/faedcd?text=封面圖片載入失敗'">

        <h1 class="text-4xl md:text-6xl text-center text-white mb-8" style="font-family: 'DFKai-sb', 'BiauKaiTC', serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
            ＜幸福365＞
        </h1>

        <!-- 狀態區 -->
        <div class="no-print text-center mb-4 p-3 bg-amber-100 rounded-lg shadow-sm">
            <span id="auth-status" class="font-bold text-green-700">✔️ 本機離線模式 (資料儲存在此瀏覽器)</span>
        </div>

        <div class="flex flex-col md:flex-row gap-8">
            
            <!-- 左側：目錄 -->
            <aside class="w-full md:w-1/3 lg:w-1/4 no-print">
                <div class="bg-amber-100 p-4 rounded-lg shadow-md sticky top-8">
                    <h2 class="text-3xl text-amber-800 border-b-2 border-amber-300 pb-2 mb-4">
                        手札目錄
                    </h2>
                    <div id="toc-container" class="space-y-2 max-h-[70vh] overflow-y-auto">
                        <p class="text-amber-600">載入日記中...</p>
                    </div>
                </div>
            </aside>

            <!-- 右側：編輯區和日記顯示 -->
            <main class="w-full md:w-2/3 lg:w-3/4">
                <div class="bg-amber-100 p-6 rounded-lg shadow-lg">
                    <!-- 操作按鈕 -->
                    <div class="flex flex-wrap gap-3 mb-4 no-print">
                        <button id="new-entry-btn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            寫新日記
                        </button>
                        <button id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            儲存本篇
                        </button>
                        <button id="print-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            列印本篇 (PDF)
                        </button>
                        <button id="download-all-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            打包下載全部 (PDF)
                        </button>
                        <button id="delete-btn" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            刪除本篇
                        </button>
                    </div>

                    <!-- 日記元數據 -->
                    <div id="entry-meta-display" class="mb-4 p-3 bg-white rounded-md text-amber-800 text-xl shadow-inner">
                        <span id="entry-title">新日記</span> | <span id="entry-timestamp"></span>
                    </div>

                    <!-- 警告訊息 -->
                    <p class="text-sm text-red-600 mb-3 no-print">
                        (提醒：本機版手札僅支援文字內容。)
                    </p>
                    
                    <!-- 編輯器 -->
                    <div id="editor-wrapper" class="print-area">
                        <!-- 'print-entry' 用於單篇列印 -->
                        <div id="editor-content" class="print-entry">
                            <h2 id="print-title-display" class="print-title hidden"></h2>
                            <p id="print-meta-display" class="print-meta hidden"></p>
                            <!-- 可編輯區域 -->
                            <div id="editor" 
                                 contenteditable="true" 
                                 class="bg-white rounded-b-lg p-6 shadow-inner focus:outline-none focus:ring-2 focus:ring-amber-500"
                                 role="textbox" 
                                 aria-multiline="true">
                            </div>
                        </div>
                    </div>

                    <!-- 圖片上傳區 (已移除) -->
                    <!-- 圖片顯示區 (已移除) -->
                </div>
            </main>
        </div>

        <!-- 圖3：封底圖片 -->
        <img src="圖3.png" 
             alt="幸福365 封底" 
             class="w-full h-24 object-cover rounded-lg shadow-lg mt-16 no-print"
             onerror="this.src='https://placehold.co/1200x100/d4a373/faedcd?text=封底圖片載入失敗'">
    </div>

    <!-- 用於「打包下載全部」的隱藏列印區域 -->
    <div id="print-all-container" class="print-area hidden"></div>

    <!-- 本機儲存 (LocalStorage) 邏輯 -->
    <script>
        // --- 設定 ---
        const STORAGE_KEY = 'happiness365_entries';

        // --- 狀態 ---
        let allEntries = []; // 存放所有日記的陣列
        let currentEntryId = null; // 當前正在編輯的日記 ID

        // --- DOM 元素 ---
        const tocContainer = document.getElementById('toc-container');
        const editor = document.getElementById('editor');
        const entryTitle = document.getElementById('entry-title');
        const entryTimestamp = document.getElementById('entry-timestamp');
        const newEntryBtn = document.getElementById('new-entry-btn');
        const saveBtn = document.getElementById('save-btn');
        const printBtn = document.getElementById('print-btn');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const deleteBtn = document.getElementById('delete-btn'); // 新增刪除按鈕

        // --- 核心功能 ---

        /**
         * 格式化日期時間
         * @param {Date} dateObj - 日期物件
         * @returns {string} - e.g., "2025.10.30 11:08pm"
         */
        function formatJournalTimestamp(dateObj) {
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            let hours = dateObj.getHours();
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const hoursStr = hours.toString().padStart(2, '0');
            return `${year}.${month}.${day} ${hoursStr}:${minutes}${ampm}`;
        }

        /**
         * 顯示提示訊息 (使用自訂的簡易彈窗)
         */
        function showModal(message) {
            // 由於 alert() 在 iframe 中可能被阻擋，我們建立一個簡易的提示
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '20px';
            modal.style.left = '50%';
            modal.style.transform = 'translateX(-50%)';
            modal.style.padding = '16px 24px';
            modal.style.background = '#28a745'; // 綠色背景
            modal.style.color = 'white';
            modal.style.borderRadius = '8px';
            modal.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            modal.style.zIndex = '1000';
            modal.style.fontFamily = 'DFKai-sb, BiauKaiTC, serif'; // 確保字體
            modal.style.fontSize = '1.2rem';
            modal.textContent = message;
            document.body.appendChild(modal);

            setTimeout(() => {
                modal.remove();
            }, 2500);
        }

        /**
         * 從 LocalStorage 載入所有日記
         */
        function loadEntries() {
            const entriesJson = localStorage.getItem(STORAGE_KEY);
            if (entriesJson) {
                allEntries = JSON.parse(entriesJson);
            } else {
                allEntries = [];
            }
            
            // 排序 (確保是數字)
            allEntries.sort((a, b) => (a.entryNumber || 0) - (b.entryNumber || 0));
            
            renderTOC();
            
            // 顯示最新一篇或新日記
            if (allEntries.length > 0) {
                displayEntry(allEntries[allEntries.length - 1].id);
            } else {
                handleNewEntry();
            }
        }

        /**
         * 將所有日記儲存到 LocalStorage
         */
        function saveEntriesToLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allEntries));
        }

        /**
         * 渲染目錄 (TOC)
         */
        function renderTOC() {
            tocContainer.innerHTML = ''; // 清空
            if (allEntries.length === 0) {
                tocContainer.innerHTML = '<p class="text-amber-600">還沒有任何日記喔！</p>';
                return;
            }

            // 按照30篇分組
            const groups = {};
            allEntries.forEach(entry => {
                const entryNum = Number(entry.entryNumber);
                if (isNaN(entryNum) || entryNum < 1) return;

                const groupIndex = Math.floor((entryNum - 1) / 30);
                const start = groupIndex * 30 + 1;
                const end = start + 29;
                const groupName = `幸福365-${start}～${end}`;
                
                if (!groups[groupName]) {
                    groups[groupName] = [];
                }
                groups[groupName].push(entry);
            });

            Object.keys(groups).sort((a, b) => {
                const aStart = parseInt(a.split('-')[1]);
                const bStart = parseInt(b.split('-')[1]);
                return aStart - bStart;
            }).forEach(groupName => {
                const groupWrapper = document.createElement('details');
                groupWrapper.className = 'mb-2';
                groupWrapper.open = true;

                const summary = document.createElement('summary');
                summary.className = 'text-xl font-bold text-amber-800 cursor-pointer hover:text-amber-600';
                summary.textContent = groupName;
                groupWrapper.appendChild(summary);

                const entryList = document.createElement('ul');
                entryList.className = 'pl-4 mt-2 space-y-1';
                
                groups[groupName].sort((a, b) => (a.entryNumber || 0) - (b.entryNumber || 0));

                groups[groupName].forEach(entry => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = `${entry.title}`;
                    link.className = `block text-amber-700 hover:text-amber-900 hover:font-bold ${entry.id === currentEntryId ? 'font-bold text-amber-900' : ''}`;
                    link.dataset.id = entry.id;
                    link.onclick = (e) => {
                        e.preventDefault();
                        displayEntry(link.dataset.id);
                    };
                    li.appendChild(link);
                    entryList.appendChild(li);
                });
                
                // --- 錯誤修正 ---
                // 原本錯誤的程式碼是: groupWrapper.appendChild(groupWrapper);
                // 修正為:
                groupWrapper.appendChild(entryList);
                tocContainer.appendChild(groupWrapper);
            });
        }

        /**
         * 在編輯器中顯示指定的日記
         * @param {string} entryId - 日記的 ID
         */
        function displayEntry(entryId) {
            const entry = allEntries.find(e => e.id === entryId);
            if (!entry) {
                console.warn(`找不到 ID 為 ${entryId} 的日記`);
                return;
            }
            
            currentEntryId = entry.id;
            editor.innerHTML = entry.content || '';
            entryTitle.textContent = entry.title || '讀取中...';
            entryTimestamp.textContent = entry.formattedTimestamp || '...';
            
            // 更新TOC的活躍狀態
            document.querySelectorAll('#toc-container a').forEach(a => {
                if (a.dataset.id === entryId) {
                    a.classList.add('font-bold', 'text-amber-900');
                } else {
                    a.classList.remove('font-bold', 'text-amber-900');
                }
            });
        }

        /**
         * 準備寫新日記
         */
        function handleNewEntry() {
            currentEntryId = null;
            editor.innerHTML = '';
            entryTitle.textContent = '新日記 (尚未儲存)';
            entryTimestamp.textContent = formatJournalTimestamp(new Date());
            editor.focus();
            
            // 更新TOC的活躍狀態
            document.querySelectorAll('#toc-container a').forEach(a => {
                a.classList.remove('font-bold', 'text-amber-900');
            });
        }

        /**
         * 儲存 (新增或更新) 日記
         */
        function handleSaveEntry() {
            const content = editor.innerHTML;
            if (content.trim().length === 0) {
                alert("日記內容不能為空喔！"); // 簡易提示
                return;
            }
 
            saveBtn.textContent = '儲存中...';
            saveBtn.disabled = true;

            try {
                let entryToSave;
                let isNewEntry = false;

                if (currentEntryId) {
                    // --- 更新現有日記 ---
                    entryToSave = allEntries.find(e => e.id === currentEntryId);
                    if (entryToSave) {
                        entryToSave.content = content;
                        entryToSave.updatedAt = new Date().toISOString();
                    } else {
                        // 找不到，強制轉為新增
                        currentEntryId = null;
                    }
                } 
                
                if (currentEntryId === null) {
                    // --- 新增日記 ---
                    isNewEntry = true;
                    const nextEntryNumber = allEntries.length > 0 ? Math.max(...allEntries.map(e => e.entryNumber)) + 1 : 1;
                    const newTitle = `幸福365-${nextEntryNumber}`;
                    const now = new Date();
                    
                    entryToSave = {
                        id: Date.now().toString(), // 使用時間戳作為簡單的唯一ID
                        entryNumber: nextEntryNumber,
                        title: newTitle,
                        content: content,
                        createdAt: now.toISOString(),
                        formattedTimestamp: formatJournalTimestamp(now),
                    };
                    allEntries.push(entryToSave);
                }

                // 重新排序
                allEntries.sort((a, b) => a.entryNumber - b.entryNumber);
                // 儲存到 LocalStorage
                saveEntriesToLocal();
                
                // 更新 UI
                if (isNewEntry) {
                    currentEntryId = entryToSave.id;
                    renderTOC(); // 只有新增時才需要重繪TOC
                    displayEntry(currentEntryId); // 顯示新儲存的
                } else {
                    // 只需更新標題 (如果需要)
                    displayEntry(currentEntryId);
                }

                showModal("幸福+1！日記已儲存！");

            } catch (error) {
                console.error("儲存日記失敗:", error);
                alert("儲存失敗！可能是儲存空間已滿。");
            } finally {
                saveBtn.textContent = '儲存本篇';
                saveBtn.disabled = false;
            }
        }

        /**
         * 刪除當前日記
         */
        function handleDeleteEntry() {
            if (!currentEntryId) {
                alert("這是一篇新日記，還沒儲存，無法刪除。");
                return;
            }

            // 使用瀏覽器內建的 confirm
            const confirmed = confirm(`您確定要刪除這篇「${entryTitle.textContent}」嗎？\n這個動作無法復原！`);

            if (confirmed) {
                // 從 allEntries 陣列中移除
                allEntries = allEntries.filter(e => e.id !== currentEntryId);
                
                // 儲存變更
                saveEntriesToLocal();
                
                // 重新載入
                loadEntries(); // 載入後會自動顯示最新一篇或新日記
            }
        }

        /**
         * 列印當前日記 (存為 PDF)
         */
        function handlePrintEntry() {
            if (!currentEntryId) {
                alert("請先儲存這篇新日記，才能列印喔！");
                return;
            }
            
            const entry = allEntries.find(e => e.id === currentEntryId);
            if (!entry) return;

            document.getElementById('print-title-display').textContent = entry.title;
            document.getElementById('print-title-display').classList.remove('hidden');
            
            document.getElementById('print-meta-display').textContent = entry.formattedTimestamp;
            document.getElementById('print-meta-display').classList.remove('hidden');

            const printEditor = document.getElementById('editor');
            printEditor.innerHTML = entry.content; // 確保是儲存的內容

            window.print();
            
            document.getElementById('print-title-display').classList.add('hidden');
            document.getElementById('print-meta-display').classList.add('hidden');
            
            displayEntry(currentEntryId); // 恢復目前編輯的狀態
        }

        /**
         * 打包下載所有日記 (存為 PDF)
         */
        function handleDownloadAll() {
            if (allEntries.length === 0) {
                alert("還沒有日記可以下載喔！");
                return;
            }

            const printContainer = document.getElementById('print-all-container');
            printContainer.innerHTML = '';
            printContainer.classList.remove('hidden');

            allEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'print-entry';
                
                const title = document.createElement('h2');
                title.className = 'print-title';
                title.textContent = entry.title;
                
                const meta = document.createElement('p');
                meta.className = 'print-meta';
                meta.textContent = entry.formattedTimestamp;
                
                const content = document.createElement('div');
                content.innerHTML = entry.content;
                
                entryDiv.appendChild(title);
                entryDiv.appendChild(meta);
                entryDiv.appendChild(content);
                printContainer.appendChild(entryDiv);
            });

            window.print(); // 觸發列印
            
            printContainer.classList.add('hidden');
        }

        // --- 事件監聽 ---
        newEntryBtn.addEventListener('click', handleNewEntry);
        saveBtn.addEventListener('click', handleSaveEntry);
        printBtn.addEventListener('click', handlePrintEntry);
        downloadAllBtn.addEventListener('click', handleDownloadAll);
        deleteBtn.addEventListener('click', handleDeleteEntry); // 綁定刪除事件

        // --- 啟動 ---
        // 網頁載入後，立即從 LocalStorage 載入日記
        window.addEventListener('load', () => {
            loadEntries();
        });

    </script>
</body>
</html>



