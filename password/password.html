<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>達文西密碼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            overscroll-behavior: none;
        }

        .screen {
            transition: opacity 0.7s ease-in-out;
        }

        .hidden-screen {
            opacity: 0;
            pointer-events: none;
        }
        
        .fade-in-text {
            animation: fadeIn 2s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .password-input {
            width: 3rem;
            height: 4rem;
            text-align: center;
            font-size: 2rem;
            border: 2px solid #a1a1aa;
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            background-color: #f4f4f5;
            color: #18181b;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5);
        }
        
        .final-password-input {
            width: 3.5rem;
            height: 4.5rem;
            text-align: center;
            font-size: 2.5rem;
            text-transform: uppercase;
            border: 2px solid #a1a1aa;
            border-radius: 0.5rem;
            margin: 0 0.25rem;
            background-color: #f4f4f5;
            color: #18181b;
        }

        #flashlight-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 50% 50%, transparent 100px, black 250px);
            pointer-events: none;
            z-index: 40;
        }
        
        .flashlight-cursor {
            cursor: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJVSURBVHgB7ZfRddswEIZfSgWlAlICpQKyAlICpQKyAlICtIOkgvQDpYOkgpQApwR2Z8xYjh3fw8DA8PbOEsl3v+TSwy4xxiWXXHJJ5Uq9P4F8fX0d2WyW4XCIfr9PFEW4XC4pl8tUKBTCWlpa0v2jUCi4XC6Px2OkUqmsoih4PJ6uNlsulzEajRCJRIiPj49L+Pn5xfVzOBxSLBb9fj/S6fR4PCasvLy8bLfbRaPRYDabLJfLqNVqVCqV0Ol0kMlkxONx+v0+CoXC9W0mk4lEIoFer4e7uzv6/f54PD6sra0tX5WIRETsBDs7O1xZWREMBgEAmM1mms0mAOD29jYxMTHk5+fXbDaTTCbz+Xwul0ssFkvbTqdDuVwWjUYtLS0FAAgEAuxtbW21tbUplUpBcHBAaWnpdDq9vLwcDocDAFBbW5vc3FxEIpFAoVAsFovNZhOLxTQaDTabzefz4XA4aDQajUZDNBo9fPgwzc3N4HA4ZDIZ0Wg0mUwmk8nkcDh0Oh0qlQqHw2Gz2SqVKrFYrFarBQCwWq3a7fbRaDQSiQQAQCaTIZfL4XA4VCrVYrEQj8fxeDwdHR3IZDI6nU4ikYhGo0GlUqFQKGQyGd1ul8lkSqVSJpMpFAqtVhsA4Ha7zWazMAxDX18fgiAQRVEAgNfrpVKp6PV6kUgkwWCAy+UqlUplMpmGhga8vLwAALS3t8vlclEUxev1AgBsNhsAzOfzQRDk8/kqlQoAwOl0UqlUrFYrEokkEAhwenoaDocDAFgsFsVi8bM+n88Xh8MhFotdXV2xtLQEAFAqlcRiMXq9XiwWAwBcX18DADabzWazeDweDocDAH7jXxwOh3q9vtlsBgD4/f6P/81Lbrnkkssv/wul/W/+B/0pMAAAAABJRU5ErkJggg==), auto;
        }

        .interactive-item {
            transition: transform 0.2s, filter 0.2s;
        }

        .interactive-item:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.7));
            cursor: pointer;
        }

        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        
        .quiz-option {
            border: 2px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
        }
        .quiz-option:hover {
            border-color: #a3bffa;
            background-color: #ebf4ff;
        }
        .quiz-option.selected {
            border-color: #4f46e5;
            background-color: #c7d2fe;
            font-weight: bold;
        }

        .zoomable-image {
            cursor: zoom-in;
        }
        
        @keyframes door-appear {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .door-animation {
            animation: door-appear 1s ease-out forwards;
        }

    </style>
</head>
<body class="bg-black text-white overflow-hidden">

    <!-- Container for all screens -->
    <div id="game-container" class="relative w-full h-screen">

        <!-- Login Screen (Page 1) -->
        <div id="login-screen" class="screen absolute inset-0 bg-black flex items-center justify-center">
            <div class="bg-gray-900 rounded-xl shadow-2xl p-8 text-center max-w-sm w-full">
                <h2 class="text-3xl font-bold mb-4 text-amber-400">登入</h2>
                <p class="text-gray-400 mb-6">請輸入你的資料</p>
                <form id="student-form" class="space-y-4">
                    <input type="text" id="student-class" placeholder="班級 (例如: 701)" class="w-full rounded-md border-gray-600 bg-gray-800 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                    <input type="text" id="student-seat" placeholder="座號 (例如: 01)" class="w-full rounded-md border-gray-600 bg-gray-800 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                    <input type="text" id="student-name" placeholder="姓名" class="w-full rounded-md border-gray-600 bg-gray-800 text-white shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                    <button type="submit" class="w-full bg-amber-500 text-black font-bold py-3 px-4 rounded-lg hover:bg-amber-400 transition-colors">開始</button>
                </form>
            </div>
        </div>

        <!-- Title Screen (Page 2) -->
        <div id="title-screen" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen">
            <h1 class="text-6xl font-bold fade-in-text">達文西密碼</h1>
        </div>

        <!-- Intro Screen 1 (Page 3) -->
        <div id="intro-screen-1" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen">
            <p class="text-2xl text-center max-w-2xl leading-loose fade-in-text">
                你從黑暗中醒來，記憶被時間抹去。<br>眼前只有一個鎖上的寶箱，與無邊的靜默。
            </p>
        </div>

        <!-- Intro Screen 2 (Page 4) -->
        <div id="intro-screen-2" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen">
            <p class="text-2xl text-center max-w-2xl leading-loose fade-in-text">
                光，藏在黑暗之中。<br>謎，埋在寶箱之下。<br>只有最敏銳的頭腦，能看見真相的輪廓。
            </p>
        </div>

        <!-- Intro Screen 3 (Page 5) -->
        <div id="intro-screen-3" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen">
            <p class="text-2xl text-center max-w-2xl leading-loose fade-in-text">
                解開密碼，照亮真相<br>你唯一的出口，是那道金光閃閃的門。
            </p>
        </div>
        
        <!-- Intro Screen 4 (Page 6) -->
        <div id="intro-screen-4" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen">
            <h2 class="text-4xl font-bold fade-in-text">智者，歡迎來到〈達文西密碼〉</h2>
        </div>

        <!-- Game Screen (Page 7) -->
        <div id="game-screen" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen">
            <!-- Flashlight Effect -->
            <div id="flashlight-overlay" class="hidden"></div>
            
            <!-- Items in the room -->
            <div id="room-items" class="relative w-[1000px] h-[600px] hidden">
                 <div id="item-red-bag" class="interactive-item absolute" style="top: 10%; left: 15%;"><img src="圖21.jpg" alt="紅色錦囊" class="w-24 h-24 object-contain"></div>
                 <div id="item-yellow-bag" class="interactive-item absolute" style="top: 70%; left: 5%;"><img src="圖23.jpg" alt="黃色錦囊" class="w-24 h-24 object-contain"></div>
                 <div id="item-green-bag" class="interactive-item absolute" style="top: 20%; left: 80%;"><img src="圖25.jpg" alt="綠色錦囊" class="w-24 h-24 object-contain"></div>
                 <div id="item-red-chest" class="interactive-item absolute" style="top: 80%; left: 75%;"><img src="圖20.jpg" alt="紅色寶箱" class="w-32 h-32 object-contain"></div>
                 <div id="item-yellow-chest" class="interactive-item absolute" style="top: 50%; left: 40%;"><img src="圖22.jpg" alt="黃色寶箱" class="w-32 h-32 object-contain"></div>
                 <div id="item-green-chest" class="interactive-item absolute" style="top: 5%; left: 45%;"><img src="圖24.jpg" alt="綠色寶箱" class="w-32 h-32 object-contain"></div>
            </div>

            <!-- Main Treasure Chest -->
            <div id="main-chest-area" class="text-center">
                <img src="圖18.jpg" alt="寶箱" id="main-chest-img" class="mx-auto mb-6 w-[500px] h-[500px] object-contain cursor-pointer transition-transform hover:scale-105">
                <p id="main-chest-text" class="text-gray-400 mb-4">一個巨大的寶箱矗立在房間中央。</p>
            </div>
        </div>
        
        <!-- Final Door Screen -->
        <div id="final-door-screen" class="screen absolute inset-0 bg-black flex items-center justify-center hidden-screen p-4">
             <div id="golden-door-container" class="relative cursor-pointer" style="opacity: 0;">
                 <img src="圖26.jpg" alt="金色大門" class="w-auto h-[90vh] max-w-none object-contain">
                 <div class="absolute top-[28%] left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-50 p-4 rounded-lg">
                     <h3 class="text-2xl font-bold text-amber-300">最後的挑戰</h3>
                 </div>
             </div>
        </div>
        
        <!-- End Screen -->
        <div id="end-screen" class="screen absolute inset-0 bg-black flex flex-col items-center justify-center hidden-screen">
            <img src="圖27.jpg" alt="科學超人" class="w-full max-w-2xl rounded-lg shadow-2xl mb-8">
            <div class="text-center">
                <p class="text-3xl">總分</p>
                <p id="final-score" class="text-7xl font-bold text-green-400">0</p>
                <p id="submission-status" class="text-sm text-gray-400 mt-4"></p>
            </div>
        </div>

    </div>

    <!-- Modals for puzzles -->
    <div id="puzzle-modal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <!-- Modal content will be injected here -->
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer" class="modal hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60] p-4 cursor-zoom-out">
        <img id="viewer-img" src="" class="max-w-full max-h-full object-contain">
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Google Sheet URL ---
            // TODO: 請將此處的 URL 換成你自己的 Google Apps Script 網址
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbze9u4mgRApFW-kLT4sPorx-qnx0ws0qjnsiQbY8O42gNmAb-lCheLhaZkOonK_qNj0/exec';

            // --- State Management ---
            let currentScreen = 0;
            let studentInfo = {};
            let totalScore = 0;
            let puzzleScores = {
                mainChest: 0,
                redChest: 0,
                yellowChest: 0,
                greenChest: 0,
                finalQuiz: 0
            };
            let inventory = {
                flashlight: false,
                amethyst: false,
                goldenApple: false,
                goldenRod: false,
            };
            let puzzlesSolved = {
                red: false,
                yellow: false,
                green: false
            };

            const screens = [
                'login-screen', 'title-screen', 'intro-screen-1', 'intro-screen-2', 'intro-screen-3', 'intro-screen-4'
            ];

            // --- DOM Elements ---
            const studentForm = document.getElementById('student-form');
            const mainChestImg = document.getElementById('main-chest-img');
            const puzzleModal = document.getElementById('puzzle-modal');
            const modalContent = document.getElementById('modal-content');
            const finalDoorScreen = document.getElementById('final-door-screen');
            const endScreen = document.getElementById('end-screen');
            const imageViewer = document.getElementById('image-viewer');
            const viewerImg = document.getElementById('viewer-img');
            const gameScreen = document.getElementById('game-screen');
            const goldenDoorContainer = document.getElementById('golden-door-container');
            const submissionStatus = document.getElementById('submission-status');

            // --- Functions ---
            function switchScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden-screen'));
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden-screen');
                }
            }

            function nextIntroScreen() {
                currentScreen++;
                if (currentScreen < screens.length) {
                    switchScreen(screens[currentScreen]);
                    setTimeout(nextIntroScreen, 6000);
                } else {
                     switchScreen('game-screen');
                }
            }
            
            function createPasswordInput(container, count, isFinal = false) {
                let inputClass = isFinal ? 'final-password-input' : 'password-input';
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const input = document.createElement('input');
                    input.type = isFinal ? 'text' : 'number';
                    input.maxLength = 1;
                    input.className = inputClass;
                    container.appendChild(input);

                    input.addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                        if (e.target.value && e.target.nextElementSibling) {
                            e.target.nextElementSibling.focus();
                        }
                    });
                    input.addEventListener('keydown', (e) => {
                         if (e.key === 'Backspace' && !e.target.value && e.target.previousElementSibling) {
                             e.target.previousElementSibling.focus();
                         }
                    });
                }
            }

            function getPassword(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return '';
                const inputs = container.querySelectorAll('.password-input, .final-password-input');
                return Array.from(inputs).map(input => input.value).join('');
            }
            
            function showModal(content) {
                modalContent.innerHTML = content;
                puzzleModal.classList.remove('hidden');
            }

            function closeModal() {
                puzzleModal.classList.add('hidden');
                modalContent.innerHTML = '';
            }
            
            function updateScore(puzzleKey, points) {
                if (puzzleScores.hasOwnProperty(puzzleKey)) {
                    puzzleScores[puzzleKey] = points;
                }
                totalScore = Object.values(puzzleScores).reduce((sum, current) => sum + current, 0);
                console.log('Scores updated:', puzzleScores);
                console.log(`New Total Score: ${totalScore}`);
            }

            function checkAllTreasuresFound() {
                if (inventory.amethyst && inventory.goldenApple && inventory.goldenRod) {
                    gameScreen.classList.remove('flashlight-cursor');
                    document.getElementById('flashlight-overlay').classList.add('hidden');
                    switchScreen('final-door-screen');
                    setTimeout(() => {
                        goldenDoorContainer.classList.add('door-animation');
                        goldenDoorContainer.style.opacity = 1;
                    }, 100);
                }
            }

            function submitScore() {
                submissionStatus.textContent = '成績上傳中...';
                
                if (SCRIPT_URL === '在此貼上你的 Google Apps Script 網址') {
                    console.error('Google Apps Script URL is not set.');
                    submissionStatus.textContent = '上傳失敗：未設定 URL。';
                    return;
                }

                const formData = new FormData();
                formData.append('class', studentInfo.class);
                formData.append('seat', studentInfo.seat);
                formData.append('name', studentInfo.name);
                formData.append('mainChestScore', puzzleScores.mainChest);
                formData.append('redChestScore', puzzleScores.redChest);
                formData.append('yellowChestScore', puzzleScores.yellowChest);
                formData.append('greenChestScore', puzzleScores.greenChest);
                formData.append('finalQuizScore', puzzleScores.finalQuiz);
                formData.append('totalScore', totalScore);
                
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        console.log('Score submitted successfully.');
                        submissionStatus.textContent = '成績已成功上傳！';
                    } else {
                        console.error('Submission failed:', data);
                        submissionStatus.textContent = '上傳失敗，請稍後再試。';
                    }
                })
                .catch(error => {
                    console.error('Error submitting score:', error);
                    submissionStatus.textContent = '上傳失敗，請檢查網路連線。';
                });
            }
            
            function showEndScreen() {
                 document.getElementById('final-score').textContent = totalScore;
                 switchScreen('end-screen');
                 submitScore();
            }

            // --- Puzzle Logic ---
            function showMainChestPuzzle() {
                const puzzleHTML = `
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">寶箱密碼鎖</h3>
                        <p class="text-gray-400 mb-6">解開下方的謎題以獲得6位數密碼。</p>
                        <img src="圖1.jpg" alt="解鎖圖卡1" class="mx-auto rounded-lg mb-6 max-w-full md:max-w-2xl">
                        <div id="main-password-container" class="flex justify-center mb-6"></div>
                        <div class="flex justify-center gap-4">
                            <button id="submit-main-password" class="bg-amber-500 text-black font-bold py-2 px-6 rounded-lg hover:bg-amber-400">解鎖</button>
                            <button id="close-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                        </div>
                    </div>
                `;
                showModal(puzzleHTML);
                createPasswordInput(document.getElementById('main-password-container'), 6);
                
                document.getElementById('submit-main-password').addEventListener('click', () => {
                    const password = getPassword('main-password-container');
                    if (password === '534628') {
                        updateScore('mainChest', 20);
                        inventory.flashlight = true;
                        closeModal();
                        showModal(`
                            <div class="text-center p-4">
                                <h3 class="text-2xl font-bold text-green-400 mb-4">解鎖成功！</h3>
                                <img src="圖19.png" alt="手電筒" class="mx-auto w-48 h-48 object-contain mb-4">
                                <p class="text-lg">你找到了一個手電筒！黑暗的房間亮了起來。</p>
                                <button id="close-congrats-btn" class="mt-6 bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-500">繼續探索</button>
                            </div>
                        `);
                        document.getElementById('close-congrats-btn').addEventListener('click', () => {
                            document.getElementById('main-chest-area').classList.add('hidden');
                            document.getElementById('flashlight-overlay').classList.remove('hidden');
                            document.getElementById('room-items').classList.remove('hidden');
                            gameScreen.classList.add('flashlight-cursor');
                            closeModal();
                        });
                    } else {
                        alert('密碼錯誤！');
                    }
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }
            
            function showRedBagPuzzle() {
                showModal(`
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">紅色錦囊：震震有茲</h3>
                        <p class="text-gray-400 mb-6">裡面有兩張圖卡，似乎是紅色寶箱的線索。(點擊圖片可放大)</p>
                        <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                            <img src="圖5.jpg" alt="圖卡5" class="max-w-xs md:max-w-sm rounded-lg zoomable-image">
                            <img src="圖6.png" alt="圖卡6" class="max-w-xs md:max-w-sm rounded-lg zoomable-image">
                        </div>
                        <button id="close-modal-btn" class="mt-6 bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                    </div>
                `);
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }
            
            function showYellowBagPuzzle() {
                 showModal(`
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">黃色錦囊：牛不牛</h3>
                        <p class="text-gray-400 mb-6">裡面有兩張圖卡，似乎是黃色寶箱的線索。(點擊圖片可放大)</p>
                        <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                            <img src="圖12.png" alt="圖卡12" class="max-w-xs md:max-w-sm rounded-lg zoomable-image">
                            <img src="圖13.png" alt="圖卡13" class="max-w-xs md:max-w-sm rounded-lg zoomable-image">
                        </div>
                        <button id="close-modal-btn" class="mt-6 bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                    </div>
                `);
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }
            
            function showGreenBagPuzzle() {
                 showModal(`
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">綠色錦囊：能源高手</h3>
                        <p class="text-gray-400 mb-6">裡面有三張圖卡，似乎是綠色寶箱的線索。(點擊圖片可放大)</p>
                        <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                             <img src="圖8.jpg" alt="圖卡8" class="max-w-xs md:max-w-[200px] rounded-lg zoomable-image">
                             <img src="圖9.jpg" alt="圖卡9" class="max-w-xs md:max-w-[200px] rounded-lg zoomable-image">
                             <img src="圖10.jpg" alt="圖卡10" class="max-w-xs md:max-w-[200px] rounded-lg zoomable-image">
                        </div>
                        <button id="close-modal-btn" class="mt-6 bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                    </div>
                `);
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }

            function showRedChestPuzzle() {
                showModal(`
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">紅色寶箱：震震有茲</h3>
                        <p class="text-gray-400 mb-6">輸入3位數密碼來解鎖。</p>
                        <div id="red-password-container" class="flex justify-center mb-6"></div>
                        <div class="flex justify-center gap-4">
                            <button id="submit-red-password" class="bg-amber-500 text-black font-bold py-2 px-6 rounded-lg hover:bg-amber-400">解鎖</button>
                            <button id="close-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                        </div>
                    </div>
                `);
                createPasswordInput(document.getElementById('red-password-container'), 3, false, 'password-input');
                document.getElementById('submit-red-password').addEventListener('click', () => {
                    if (getPassword('red-password-container') === '321') {
                        updateScore('redChest', 50);
                        inventory.amethyst = true;
                        puzzlesSolved.red = true;
                        document.getElementById('item-red-chest').style.opacity = '0.3';
                        closeModal();
                        showModal(`
                            <div class="text-center p-4">
                                <h3 class="text-2xl font-bold text-green-400 mb-4">解鎖成功！</h3>
                                <img src="圖7.jpg" alt="紫水晶" class="mx-auto w-48 h-48 rounded-lg mb-4">
                                <p class="text-lg">恭喜你們成功打開了「震震有茲」寶箱！<br>寶箱裡有三顆從岩層挖出的紫水晶，請妥善保管，要和其他寶箱中的寶藏一起用喔!</p>
                                <button id="close-congrats-btn" class="mt-6 bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-500">繼續探索</button>
                            </div>
                        `);
                        document.getElementById('close-congrats-btn').addEventListener('click', () => {
                            closeModal();
                            checkAllTreasuresFound();
                        });
                    } else {
                        alert('密碼錯誤！');
                    }
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }
            
            function showYellowChestPuzzle() {
                 showModal(`
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">黃色寶箱：牛不牛</h3>
                        <p class="text-gray-400 mb-6">輸入3位數密碼來解鎖。</p>
                        <div id="yellow-password-container" class="flex justify-center mb-6"></div>
                        <div class="flex justify-center gap-4">
                            <button id="submit-yellow-password" class="bg-amber-500 text-black font-bold py-2 px-6 rounded-lg hover:bg-amber-400">解鎖</button>
                            <button id="close-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                        </div>
                    </div>
                `);
                createPasswordInput(document.getElementById('yellow-password-container'), 3, false, 'password-input');
                document.getElementById('submit-yellow-password').addEventListener('click', () => {
                    if (getPassword('yellow-password-container') === '667') {
                        updateScore('yellowChest', 50);
                        inventory.goldenApple = true;
                        puzzlesSolved.yellow = true;
                        document.getElementById('item-yellow-chest').style.opacity = '0.3';
                        closeModal();
                        showModal(`
                            <div class="text-center p-4">
                                <h3 class="text-2xl font-bold text-green-400 mb-4">解鎖成功！</h3>
                                <img src="圖14.png" alt="金蘋果" class="mx-auto w-48 h-48 rounded-lg mb-4">
                                <p class="text-lg">恭喜你們成功打開了「牛不牛」寶箱！<br>寶箱裡有一顆黃金蘋果，請記得這顆黃金蘋果上的數值，要和其他寶箱中的寶藏一起用喔!</p>
                                <button id="close-congrats-btn" class="mt-6 bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-500">繼續探索</button>
                            </div>
                        `);
                        document.getElementById('close-congrats-btn').addEventListener('click', () => {
                            closeModal();
                            checkAllTreasuresFound();
                        });
                    } else {
                        alert('密碼錯誤！');
                    }
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }
            
            function showGreenChestPuzzle() {
                showModal(`
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">綠色寶箱：能源高手</h3>
                        <p class="text-gray-400 mb-6">解開三道鎖來打開寶箱。</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2">第一道鎖 (非再生能源)</label>
                                <div id="green-password-1" class="flex justify-center"></div>
                            </div>
                             <div>
                                <label class="block mb-2">第二道鎖 (再生能源)</label>
                                <div id="green-password-2" class="flex justify-center"></div>
                            </div>
                             <div>
                                <label class="block mb-2">第三道鎖 (水流與電流比較)</label>
                                <div id="green-password-3" class="flex justify-center"></div>
                            </div>
                        </div>
                        <div class="flex justify-center gap-4 mt-6">
                            <button id="submit-green-password" class="bg-amber-500 text-black font-bold py-2 px-6 rounded-lg hover:bg-amber-400">解鎖</button>
                            <button id="close-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                        </div>
                    </div>
                `);
                createPasswordInput(document.getElementById('green-password-1'), 2, false, 'password-input');
                createPasswordInput(document.getElementById('green-password-2'), 2, false, 'password-input');
                createPasswordInput(document.getElementById('green-password-3'), 3, false, 'password-input');

                document.getElementById('submit-green-password').addEventListener('click', () => {
                    const p1 = getPassword('green-password-1') === '17';
                    const p2 = getPassword('green-password-2') === '38';
                    const p3 = getPassword('green-password-3') === '425';
                    if (p1 && p2 && p3) {
                         updateScore('greenChest', 30);
                        inventory.goldenRod = true;
                        puzzlesSolved.green = true;
                        document.getElementById('item-green-chest').style.opacity = '0.3';
                        closeModal();
                        showModal(`
                            <div class="text-center p-4">
                                <h3 class="text-2xl font-bold text-green-400 mb-4">解鎖成功！</h3>
                                <img src="圖11.png" alt="金箍棒" class="mx-auto w-48 h-48 rounded-lg mb-4">
                                <p class="text-lg">恭喜你們成功打開了「能源高手」寶箱！<br>寶箱裡有一根金箍棒，請記得這根金箍棒上的數值，要和其他寶箱中的寶藏一起用喔!</p>
                                <button id="close-congrats-btn" class="mt-6 bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-500">繼續探索</button>
                            </div>
                        `);
                        document.getElementById('close-congrats-btn').addEventListener('click', () => {
                            closeModal();
                            checkAllTreasuresFound();
                        });
                    } else {
                        alert('密碼錯誤！');
                    }
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }

            function showFinalPuzzle() {
                const puzzleHTML = `
                    <div class="text-left max-w-2xl w-full text-black space-y-4 bg-gray-200 p-6 rounded-lg">
                        <!-- Q1 -->
                        <div>
                            <p class="font-bold mb-2">1. 請問結晶顆粒超大的紫水晶比較容易在什麼樣的地殼中發現？</p>
                            <div class="space-y-1"><label><input type="radio" name="final-q1" value="A" class="mr-2">A. 海洋地殼</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q1" value="B" class="mr-2">B. 大陸地殼</label></div>
                        </div>
                        <!-- Q2 -->
                        <div>
                            <p class="font-bold mb-2">2. 請將紫水晶平放在桌面上作為支點，將金箍棒放在紫水晶上，並將金蘋果放在金箍棒距離紫水晶1.5m的右端最尾端，呈現靜力平衡狀態，請問此狀態應為下列哪種情形？</p>
                            <div class="flex justify-around items-center">
                                <label class="flex flex-col items-center"><span class="font-bold text-gray-800">C.</span><img src="圖15.png" class="w-24 h-auto zoomable-image"><input type="radio" name="final-q2" value="C"></label>
                                <label class="flex flex-col items-center"><span class="font-bold text-gray-800">D.</span><img src="圖16.png" class="w-24 h-auto zoomable-image"><input type="radio" name="final-q2" value="D"></label>
                                <label class="flex flex-col items-center"><span class="font-bold text-gray-800">E.</span><img src="圖17.png" class="w-24 h-auto zoomable-image"><input type="radio" name="final-q2" value="E"></label>
                            </div>
                        </div>
                        <!-- Q3 -->
                         <div>
                            <p class="font-bold mb-2">3. 承上題，請問紫水晶的支撐力為多少kgw？</p>
                            <div class="space-y-1"><label><input type="radio" name="final-q3" value="F" class="mr-2"> F. 5/3</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q3" value="G" class="mr-2"> G. 4/3</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q3" value="H" class="mr-2"> H. 1</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q3" value="I" class="mr-2"> I. 2/3</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q3" value="J" class="mr-2"> J. 1/3</label></div>
                        </div>
                        <!-- Q4 -->
                        <div>
                            <p class="font-bold mb-2">4. 承上題，如果用力瞬間按壓金箍棒最左端，只見金蘋果被向上拋出，最後掉落到地面上。當金蘋果飛至最高點(離地面1.5公尺)時，若不計任何阻力作用，請問一開始的瞬間按壓金箍棒的作用力對金蘋果做了多少焦耳的功？(g=10m/s^2)<br><span class="text-sm text-gray-600">※提示1️⃣：作功在增加金蘋果的重力位能</span><br><span class="text-sm text-gray-600">※提示2️⃣：重力位能=mgh</span></p>
                            <div class="space-y-1"><label><input type="radio" name="final-q4" value="K" class="mr-2"> K. 75</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q4" value="L" class="mr-2"> L. 50</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q4" value="M" class="mr-2"> M. 25</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q4" value="N" class="mr-2"> N. 15</label></div>
                            <div class="space-y-1"><label><input type="radio" name="final-q4" value="O" class="mr-2"> O. 5</label></div>
                        </div>
                        <hr class="border-gray-400 my-4"/>
                        <div>
                            <p class="font-bold text-center mb-4 text-amber-800">解開最終密碼鎖</p>
                            <div id="final-password-container" class="flex justify-center"></div>
                        </div>
                         <div class="flex justify-center gap-4 mt-6">
                            <button id="submit-final-password" class="bg-amber-500 text-black font-bold py-2 px-6 rounded-lg hover:bg-amber-400">逃脫</button>
                            <button id="close-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500">關閉</button>
                        </div>
                    </div>
                `;
                showModal(puzzleHTML);
                createPasswordInput(document.getElementById('final-password-container'), 4, true);
                
                document.getElementById('submit-final-password').addEventListener('click', () => {
                    const answer1 = document.querySelector('input[name="final-q1"]:checked')?.value;
                    const answer2 = document.querySelector('input[name="final-q2"]:checked')?.value;
                    const answer3 = document.querySelector('input[name="final-q3"]:checked')?.value;
                    const answer4 = document.querySelector('input[name="final-q4"]:checked')?.value;

                    if (!answer1 || !answer2 || !answer3 || !answer4) {
                        alert('請回答所有問題！');
                        return;
                    }
                    
                    let correctCount = 0;
                    if(answer1 === 'B') correctCount++;
                    if(answer2 === 'D') correctCount++;
                    if(answer3 === 'G') correctCount++;
                    if(answer4 === 'N') correctCount++;
                    
                    updateScore('finalQuiz', correctCount * 10);
                    
                    const finalPassword = getPassword('final-password-container');
                    if (finalPassword === "BDGN") {
                        closeModal();
                        showEndScreen();
                    } else {
                        alert('最終密碼錯誤！');
                    }
                });
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            }

            // --- Event Listeners ---
            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                studentInfo = {
                    class: document.getElementById('student-class').value,
                    seat: document.getElementById('student-seat').value,
                    name: document.getElementById('student-name').value,
                };
                nextIntroScreen();
            });

            mainChestImg.addEventListener('click', showMainChestPuzzle);

            document.getElementById('item-red-bag').addEventListener('click', showRedBagPuzzle);
            document.getElementById('item-yellow-bag').addEventListener('click', showYellowBagPuzzle);
            document.getElementById('item-green-bag').addEventListener('click', showGreenBagPuzzle);

            document.getElementById('item-red-chest').addEventListener('click', () => {
                if (!puzzlesSolved.red) showRedChestPuzzle();
            });
            document.getElementById('item-yellow-chest').addEventListener('click', () => {
                if (!puzzlesSolved.yellow) showYellowChestPuzzle();
            });
             document.getElementById('item-green-chest').addEventListener('click', () => {
                if (!puzzlesSolved.green) showGreenChestPuzzle();
            });

            goldenDoorContainer.addEventListener('click', showFinalPuzzle);

            // Flashlight effect
            gameScreen.addEventListener('mousemove', (e) => {
                if (inventory.flashlight) {
                    const overlay = document.getElementById('flashlight-overlay');
                    const rect = gameScreen.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    overlay.style.background = `radial-gradient(circle at ${x}px ${y}px, transparent 100px, black 250px)`;
                }
            });

            // Image viewer
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('zoomable-image')) {
                    viewerImg.src = e.target.src;
                    imageViewer.classList.remove('hidden');
                }
            });
            imageViewer.addEventListener('click', () => {
                imageViewer.classList.add('hidden');
            });
            
            // --- Initialisation ---
            switchScreen('login-screen');
        });
    </script>
</body>
</html>