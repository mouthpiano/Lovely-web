<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>單擺與力學能守恆</title>
    
    

<script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 'Inter' 字體 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* 能量條的平滑過渡效果 */
        .energy-bar-fill {
            transition: width 0.1s linear;
        }
        /* 確保畫布高度能正確計算 (修改為 16:9) */
        .canvas-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
        }
        .canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* (移除) 不再需要 .mode-btn-active 和 .mode-btn-inactive */
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 md:p-8">

    

<div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl p-6 md:p-8">
        
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">
            單擺與力學能守恆
        </h1>

        

<div class="grid grid-cols-1 md:grid-cols-10 gap-6">

            

<div class="md:col-span-2 p-4 bg-gray-50 rounded-lg order-2 md:order-1">
                
                

<div class="mb-4">
                    <h2 class="text-lg font-semibold text-center mb-4">模式選擇</h2>
                    <div class="flex flex-col gap-2">
                        <button id="btn-mode-angle" class="text-sm py-2 px-4 rounded-lg transition bg-gray-300 text-gray-700 hover:bg-indigo-200 opacity-70">
                            7點角度模式
                        </button>
                        <button id="btn-mode-height" class="text-sm py-2 px-4 rounded-lg transition bg-gray-300 text-gray-700 hover:bg-indigo-200 opacity-70">
                            11點高度模式
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                

<h2 id="position-title" class="text-lg font-semibold text-center mb-4">設定起始位置</h2>
                
                

<div id="angle-buttons" class="flex-col gap-2 hidden">
                    <button id="btn-a-l-85" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 85°</button>
                    <button id="btn-a-l-60" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 60°</button>
                    <button id="btn-a-l-30" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 30°</button>
                    <button id="btn-a-c-0" class="w-full text-sm bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition">最低點 0°</button>
                    <button id="btn-a-r-30" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 30°</button>
                    <button id="btn-a-r-60" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 60°</button>
                    <button id="btn-a-r-85" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 85°</button>
                </div>

                

<div id="height-buttons" class="flex-col gap-2 hidden">
                    <button id="btn-h-l-10" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 h=10m</button>
                    <button id="btn-h-l-7" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 h=7m</button>
                    <button id="btn-h-l-5" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 h=5m</button>
                    <button id="btn-h-l-3" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 h=3m</button>
                    <button id="btn-h-l-1" class="w-full text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition">左 h=1m</button>
                    <button id="btn-h-c-0" class="w-full text-sm bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition">中 h=0m</button>
                    <button id="btn-h-r-2" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 h=2m</button>
                    <button id="btn-h-r-4" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 h=4m</button>
                    <button id="btn-h-r-6" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 h=6m</button>
                    <button id="btn-h-r-8" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 h=8m</button>
                    <button id="btn-h-r-10" class="w-full text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition">右 h=10m</button>
                </div>
            </div>

            

<div class="md:col-span-6 order-1 md:order-2">
                <div class="canvas-container bg-gray-50 rounded-lg overflow-hidden border border-gray-200">
                    <canvas id="pendulumCanvas"></canvas>
                </div>
                
                

<div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <div class="space-y-5">
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-medium text-blue-600">重力位能 (PE)</span>
                                    <span id="peValue" class="font-mono text-blue-600">0.00 J</span>
                                </div>
                                <div class="w-full bg-blue-100 rounded-full h-3">
                                    <div id="peBar" class="energy-bar-fill bg-blue-500 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-medium text-green-600">動能 (KE)</span>
                                    <span id="keValue" class="font-mono text-green-600">0.00 J</span>
                                </div>
                                <div class="w-full bg-green-100 rounded-full h-3">
                                    <div id="keBar" class="energy-bar-fill bg-green-500 h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-bold text-gray-700">總力學能 (E)</span>
                                    <span id="totalValue" class="font-mono font-bold text-gray-700">0.00 J</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gray-700 h-3 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-sm text-gray-500">目前高度</div>
                                <div id="heightValue" class="text-2xl font-bold font-mono text-gray-800">0.00 m</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">目前速度</div>
                                <div id="velocityValue" class="text-2xl font-bold font-mono text-gray-800">0.00 m/s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            

<div class="md:col-span-2 p-4 bg-gray-50 rounded-lg order-3 md:order-3">
                <div class="flex flex-col gap-4">
                    
                    

<div>
                        <h2 class="text-lg font-semibold text-center mb-4">播放控制</h2>
                        <div class="flex flex-col gap-2 mb-4">
                            <button id="btn-play" class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path fill-rule="evenodd" d="M2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm6.39-2.908a.75.75 0 0 1 .766.027l3.5 2.25a.75.75 0 0 1 0 1.262l-3.5 2.25A.75.75 0 0 1 8 12.25v-4.5a.75.75 0 0 1 .39-.658Z" clip-rule="evenodd" /></svg>
                                <span id="play-text">開始</span>
                            </button>
                            <button id="btn-pause" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path fill-rule="evenodd" d="M2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm5-2.25A.75.75 0 0 1 7.75 7h.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1-.75-.75v-4.5Zm4 0A.75.75 0 0 1 11.75 7h.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1-.75-.75v-4.5Z" clip-rule="evenodd" /></svg>
                                <span>暫停</span>
                            </button>
                            <button id="btn-stop" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path fill-rule="evenodd" d="M2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0Zm5.25-1.75A.75.75 0 0 1 8 7.5h4a.75.75 0 0 1 .75.75v4a.75.75 0 0 1-.75.75H8a.75.75 0 0 1-.75-.75v-4Z" clip-rule="evenodd" /></svg>
                                <span>停止 (歸零)</span>
                            </button>
                        </div>
                    </div>
            
                    

<div>
                        <h2 class="text-lg font-semibold text-center mb-4">播放模式</h2>
                        <div class="flex flex-col gap-2 mb-4">
                            <button id="btn-mode-continuous" class="text-sm py-2 px-4 rounded-lg transition bg-indigo-600 text-white shadow-md opacity-100">
                                連續擺動
                            </button>
                            <button id="btn-mode-step" class="text-sm py-2 px-4 rounded-lg transition bg-gray-300 text-gray-700 hover:bg-indigo-200 opacity-70">
                                分段移動
                            </button>
                        </div>
                    </div>

                    

</div>
            </div>

        </div>

    </div>

    <script>
        // --- DOM 元素 ---
        const canvas = document.getElementById('pendulumCanvas');
        const ctx = canvas.getContext('2d');

        const peValueEl = document.getElementById('peValue');
        const keValueEl = document.getElementById('keValue');
        const totalValueEl = document.getElementById('totalValue');
        const peBarEl = document.getElementById('peBar');
        const keBarEl = document.getElementById('keBar');
        const heightValueEl = document.getElementById('heightValue');
        const velocityValueEl = document.getElementById('velocityValue');

        // --- 播放控制元素 ---
        const btnPlay = document.getElementById('btn-play');
        const playText = document.getElementById('play-text');
        const btnPause = document.getElementById('btn-pause');
        const btnStop = document.getElementById('btn-stop');
        const btnModeContinuous = document.getElementById('btn-mode-continuous');
        const btnModeStep = document.getElementById('btn-mode-step');

        // --- (新增) 模式切換元素 ---
        const btnModeAngle = document.getElementById('btn-mode-angle');
        const btnModeHeight = document.getElementById('btn-mode-height');
        const angleButtonsDiv = document.getElementById('angle-buttons');
        const heightButtonsDiv = document.getElementById('height-buttons');
        const positionTitle = document.getElementById('position-title');

        // --- 物理常數與設定 ---
        const m = 1;      // 質量 (kg) - 方便計算，設為 1
        const g = 10;     // 重力加速度 (m/s^2) - 設為 10 讓數字更乾淨
        const L_meters = 11; // 擺長 (公尺) - 設為 11 搭配 g=10
        const angularFrequency = Math.sqrt(g / L_meters); // 角頻率
        const degToRad = (deg) => (deg * Math.PI) / 180; // 角度轉弧度
        const slowMotionFactor = 0.5; // 減慢速度 (0.5 = 50% 速度)
        
        const heightToRad = (h) => {
            if (h >= L_meters * 2) return Math.PI; // 防止 h 過大導致 acos 錯誤
            if (h <= 0) return 0;
            return Math.acos(1 - h / L_meters);
        }

        // --- (新增) 兩種關鍵點模式 ---
        const keyframesAngle = [
            { id: 'l-85', deg: -85, angleSign: -1 }, // 0
            { id: 'l-60', deg: -60, angleSign: -1 }, // 1
            { id: 'l-30', deg: -30, angleSign: -1 }, // 2
            { id: 'c-0',  deg: 0,   angleSign: 1 },  // 3
            { id: 'r-30', deg: 30,  angleSign: 1 },  // 4
            { id: 'r-60', deg: 60,  angleSign: 1 },  // 5
            { id: 'r-85', deg: 85,  angleSign: 1 }   // 6
        ];
        
        const keyframesHeight = [
            { id: 'l-10', h: 10, angleSign: -1 }, // 0
            { id: 'l-7',  h: 7,  angleSign: -1 }, // 1
            { id: 'l-5',  h: 5,  angleSign: -1 }, // 2
            { id: 'l-3',  h: 3,  angleSign: -1 }, // 3
            { id: 'l-1',  h: 1,  angleSign: -1 }, // 4
            { id: 'c-0',  h: 0,  angleSign: 1 },  // 5 
            { id: 'r-2',  h: 2,  angleSign: 1 },  // 6
            { id: 'r-4',  h: 4,  angleSign: 1 },  // 7
            { id: 'r-6',  h: 6,  angleSign: 1 },  // 8
            { id: 'r-8',  h: 8,  angleSign: 1 },  // 9
            { id: 'r-10', h: 10, angleSign: 1 }  // 10
        ];
        
        // --- 動畫狀態變數 ---
        let currentMode = 'height'; // (新增) 'angle' 或 'height'
        let animationFrameId = null; 
        let initialAngle = 0;        // 擺動的「最大」角度 (幅度)
        let E_total = 0;             
        let lastTickTime = 0;        
        let simulationState = 'stopped'; 
        let isStepping = false;          
        let currentKeyframeIndex = 5;  // 預設 (高度 0m)
        let stepDirection = 1;         
        let startTime = 0;           
        let animationSign = 1;       
        
        let maxKeyframeIndex = 5; 
        let minKeyframeIndex = 5; 

        // --- (新增) 樣式切換輔助函數 ---
        const activeClasses = ['bg-indigo-600', 'text-white', 'shadow-md', 'opacity-100'];
        const inactiveClasses = ['bg-gray-300', 'text-gray-700', 'hover:bg-indigo-200', 'opacity-70'];

        function setButtonActive(btn) {
            btn.classList.remove(...inactiveClasses);
            btn.classList.add(...activeClasses);
        }

        function setButtonInactive(btn) {
            btn.classList.remove(...activeClasses);
            btn.classList.add(...inactiveClasses);
        }

        // --- 畫布設定 ---
        let canvasWidth, canvasHeight;
        let L_pixels, pivotX, pivotY;
        const bobRadius = 15;                

        // 更新 UI 顯示 (格式化數字)
        function updateUI(h, v, pe, ke, E_total) {
            heightValueEl.textContent = `${h.toFixed(1)} m`;
            velocityValueEl.textContent = `${v.toFixed(1)} m/s`;
            
            peValueEl.textContent = `${pe.toFixed(1)} J`;
            keValueEl.textContent = `${ke.toFixed(1)} J`;
            totalValueEl.textContent = `${E_total.toFixed(1)} J (守恆!)`;

            // 更新能量條 (百分比)
            const pePercent = E_total > 0 ? (pe / E_total) * 100 : 0;
            const kePercent = E_total > 0 ? (ke / E_total) * 100 : 0;
            
            peBarEl.style.width = `${pePercent}%`;
            keBarEl.style.width = `${kePercent}%`;
        }

        // --- (修改) 繪製軌跡點和標籤 (整合版) ---
        function drawLabelsAndArc() {
            // 1. 繪製當前擺動的最大弧線 (虛線)
            const maxAngleRad = initialAngle; // initialAngle 現在就是最大幅度
            if (maxAngleRad > 0.01) { 
                ctx.beginPath();
                ctx.arc(pivotX, pivotY, L_pixels, Math.PI / 2 - maxAngleRad, Math.PI / 2 + maxAngleRad);
                ctx.strokeStyle = '#e5e7eb'; // 淺灰色 (gray-200)
                ctx.lineWidth = 2;
                ctx.setLineDash([4, 4]); // 虛線
                ctx.stroke();
                ctx.setLineDash([]); // 重置
            }

            // 2. 根據模式選擇要繪製的點
            const frames = (currentMode === 'height') ? keyframesHeight : keyframesAngle;
            ctx.font = 'bold 15px "Inter", "Noto Sans TC", sans-serif'; 
            ctx.textAlign = 'center';
            ctx.fillStyle = '#1f2937'; // 深灰色 (gray-900)

            for (const keyframe of frames) {
                let h_point, theta_point;

                if (currentMode === 'height') {
                    h_point = keyframe.h;
                    theta_point = heightToRad(h_point) * keyframe.angleSign;
                } else { // 'angle'
                    theta_point = degToRad(keyframe.deg);
                    h_point = L_meters * (1 - Math.cos(theta_point));
                }
                
                // (x, y) 座標
                const x_point = pivotX + L_pixels * Math.sin(theta_point);
                const y_point = pivotY + L_pixels * Math.cos(theta_point);

                // 畫點
                ctx.beginPath();
                ctx.arc(x_point, y_point, 3, 0, 2 * Math.PI);
                ctx.fillStyle = '#9ca3af'; // 灰色 (gray-400)
                ctx.fill();

                // 計算該點的速度
                const pe_point = m * g * h_point;
                let ke_point = E_total - pe_point;
                if (ke_point < 0.05) ke_point = 0; // 修正浮點數誤差
                
                const v_point = Math.sqrt(ke_point * 2 / m);
                
                // 調整文字位置
                let textX = x_point;
                let textY_h = y_point;
                let textY_v = y_point;
                let offsetDistance = 25; 
                const verticalOffset = 15; 

                if (theta_point < -0.01) { // 左側
                    offsetDistance = 18; 
                    textX = x_point - offsetDistance;
                    textY_h = y_point - verticalOffset / 2;
                    textY_v = y_point + verticalOffset / 2;
                    ctx.textAlign = 'right'; 
                } else if (theta_point > 0.01) { // 右側
                    offsetDistance = 18;
                    textX = x_point + offsetDistance;
                    textY_h = y_point - verticalOffset / 2;
                    textY_v = y_point + verticalOffset / 2;
                    ctx.textAlign = 'left'; 
                } else { // 0度 (最低點)
                    offsetDistance = 30; 
                    textX = x_point;
                    textY_h = y_point + offsetDistance; // 顯示在下方
                    textY_v = y_point + offsetDistance + verticalOffset;
                    ctx.textAlign = 'center';
                }

                // 顯示文字
                ctx.fillStyle = '#1f2937'; 
                ctx.fillText(`h: ${h_point.toFixed(1)}m`, textX, textY_h);
                ctx.fillText(`v: ${v_point.toFixed(1)}m/s`, textX, textY_v);
            }
        }


        // 繪製單擺
        function drawPendulum(theta) {
            // ... (此函數不需修改) ...
            const x = pivotX + L_pixels * Math.sin(theta);
            const y = pivotY + L_pixels * Math.cos(theta);
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            drawLabelsAndArc();
            ctx.beginPath();
            ctx.arc(pivotX, pivotY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#333';
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(pivotX, pivotY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(x, y, bobRadius, 0, 2 * Math.PI);
            ctx.fillStyle = 'royalblue';
            ctx.fill();
            ctx.strokeStyle = 'darkblue';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // 處理畫布響應式
        function resizeCanvas() {
             const container = canvas.parentElement;
             canvasWidth = container.clientWidth;
             canvasHeight = container.clientHeight;
             canvas.width = canvasWidth;
             canvas.height = canvasHeight;
             
             L_pixels = canvasHeight * 0.6; // 擺長 (像素)
             pivotX = canvasWidth / 2;    // 支點 X 座標
             pivotY = canvasHeight * 0.2; // 支點 Y 座標

             if (simulationState === 'preview' || simulationState === 'stopped' || simulationState === 'paused' || simulationState === 'stepping') {
                 let currentAngle;
                 let keyframe;
                 if(simulationState === 'paused') {
                    const t = lastTickTime;
                    currentAngle = animationSign * initialAngle * Math.cos(angularFrequency * t);
                 } else if (simulationState === 'stepping') {
                    keyframe = (currentMode === 'height') ? keyframesHeight[currentKeyframeIndex] : keyframesAngle[currentKeyframeIndex];
                    if (currentMode === 'height') {
                        currentAngle = heightToRad(keyframe.h) * keyframe.angleSign;
                    } else {
                        currentAngle = degToRad(keyframe.deg);
                    }
                 } else { // preview or stopped
                    keyframe = (currentMode === 'height') ? keyframesHeight[currentKeyframeIndex] : keyframesAngle[currentKeyframeIndex];
                    if (currentMode === 'height') {
                        currentAngle = heightToRad(keyframe.h) * keyframe.angleSign;
                    } else {
                        currentAngle = degToRad(keyframe.deg);
                    }
                 }
                 
                 drawPendulum(currentAngle);
                 
                 const h = L_meters * (1 - Math.cos(currentAngle));
                 const pe = m * g * h;
                 let ke = E_total - pe;
                 if (ke < 0.05) ke = 0;
                 const v = Math.sqrt(Math.max(0, ke * 2 / m));
                 updateUI(h, v, pe, ke, E_total);
             }
        }
        window.addEventListener('resize', resizeCanvas);
        

        // --- (新增) 兩種設定預覽狀態的函數 ---
        
        // 角度模式
        function setPreviewStateAngle(startDeg, startKeyframeIndex) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            simulationState = 'preview';

            const startAngleRad = degToRad(startDeg);
            initialAngle = Math.abs(startAngleRad); // 幅度
            E_total = m * g * L_meters * (1 - Math.cos(initialAngle));
            
            currentKeyframeIndex = startKeyframeIndex;
            animationSign = (startAngleRad >= 0) ? 1 : -1;
            if (startDeg === 0) animationSign = 1;

            // 7點模式的 min/max (index 3 是 0)
            if (startKeyframeIndex <= 3) { 
                minKeyframeIndex = startKeyframeIndex;
                maxKeyframeIndex = 6 - startKeyframeIndex; 
            } else { 
                maxKeyframeIndex = startKeyframeIndex;
                minKeyframeIndex = 6 - startKeyframeIndex; 
            }
            if (startKeyframeIndex === 3 && startAngleRad === 0) {
                 minKeyframeIndex = 3; maxKeyframeIndex = 3;
            }

            // 7點模式的方向 (index 3 是 0)
            if (startKeyframeIndex < 3) stepDirection = 1; 
            else if (startKeyframeIndex > 3) stepDirection = -1; 
            else stepDirection = 1; 
            
            lastTickTime = 0;
            drawPendulum(startAngleRad);
            updateUI(L_meters * (1 - Math.cos(startAngleRad)), 0, E_total, 0, E_total);

            playText.textContent = "開始";
            btnPlay.classList.remove('bg-green-600');
        }

        // 高度模式
        function setPreviewStateHeight(startHeight, startKeyframeIndex) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            simulationState = 'preview';

            const h_max = startHeight;
            E_total = m * g * h_max; 
            
            initialAngle = heightToRad(h_max); // 幅度
            const startAngleRad = heightToRad(startHeight) * keyframesHeight[startKeyframeIndex].angleSign;
            
            currentKeyframeIndex = startKeyframeIndex;
            animationSign = keyframesHeight[startKeyframeIndex].angleSign;
            if (startHeight === 0) animationSign = 1;
            
            // 11點模式的 min/max
            const validIndices = keyframesHeight
                .map((k, i) => (k.h <= h_max) ? i : -1)
                .filter(i => i !== -1);
            minKeyframeIndex = Math.min(...validIndices);
            maxKeyframeIndex = Math.max(...validIndices);
            
            // 11點模式的方向 (index 5 是 0)
            if (startKeyframeIndex < 5) stepDirection = 1; 
            else if (startKeyframeIndex > 5) stepDirection = -1; 
            else stepDirection = 1; 
            
            lastTickTime = 0; 
            drawPendulum(startAngleRad);
            updateUI(h_max, 0, E_total, 0, E_total);

            playText.textContent = "開始";
            btnPlay.classList.remove('bg-green-600');
        }


        // --- 動畫循環 (不需修改) ---
        function animate() {
            if (simulationState !== 'running') return; 

            const t = (Date.now() - startTime) / 1000 * slowMotionFactor;
            lastTickTime = t; 
            
            const theta = animationSign * initialAngle * Math.cos(angularFrequency * t);
            const omega = -animationSign * initialAngle * angularFrequency * Math.sin(angularFrequency * t);

            const h = L_meters * (1 - Math.cos(theta)); 
            const v = Math.abs(L_meters * omega);       
            const PE = m * g * h;                      
            let KE = E_total - PE;                   
            if (KE < 0.05) KE = 0; 
            
            drawPendulum(theta);
            updateUI(h, v, PE, KE, E_total);

            animationFrameId = requestAnimationFrame(animate);
        }

        // --- 播放控制功能 ---
        function playContinuous() {
            if (simulationState === 'running') return; 
            if (E_total === 0 && initialAngle === 0) return; 

            simulationState = 'running';
            startTime = Date.now() - (lastTickTime * 1000 / slowMotionFactor);
            playText.textContent = "播放";
            btnPlay.classList.add('bg-green-600');
            animate();
        }

        function pauseContinuous() {
            if (simulationState !== 'running') return; 
            simulationState = 'paused';
            cancelAnimationFrame(animationFrameId);
            playText.textContent = "繼續";
            btnPlay.classList.remove('bg-green-600');
        }

        // (修改) 停止函數
        function stopSimulation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            simulationState = 'stopped';
            // 根據模式重置
            if (currentMode === 'height') {
                setPreviewStateHeight(0, 5); // 重置到 0m (index 5)
            } else {
                setPreviewStateAngle(0, 3); // 重置到 0deg (index 3)
            }
            btnPlay.classList.remove('bg-green-600');
        }

        // (修改) 分步前進 (整合版)
        function stepForward() {
            if (simulationState === 'running') {
                 pauseContinuous(); 
            }
            
            // 根據模式檢查是否在 0 點
            const zeroIndex = (currentMode === 'height') ? 5 : 3;
            if (E_total === 0 && currentKeyframeIndex === zeroIndex) {
                return;
            }

            simulationState = 'stepping'; 
            playText.textContent = "下一步";
            btnPlay.classList.remove('bg-green-600');

            // 檢查是否碰到邊界
            if (currentKeyframeIndex <= minKeyframeIndex && stepDirection === -1) { 
                 stepDirection = 1; // 碰到左邊界，反彈往右
            } else if (currentKeyframeIndex >= maxKeyframeIndex && stepDirection === 1) { 
                 stepDirection = -1; // 碰到右邊界，反彈往左
            }

            currentKeyframeIndex += stepDirection;
            
            // 取得目標點
            const frames = (currentMode === 'height') ? keyframesHeight : keyframesAngle;
            const targetKeyframe = frames[currentKeyframeIndex];
            
            let targetRad, h;
            if (currentMode === 'height') {
                h = targetKeyframe.h;
                targetRad = heightToRad(h) * targetKeyframe.angleSign;
            } else {
                targetRad = degToRad(targetKeyframe.deg);
                h = L_meters * (1 - Math.cos(targetRad));
            }
            
            // 繪製並更新 UI
            drawPendulum(targetRad);
            
            const pe = m * g * h;
            let ke = E_total - pe;
            if (ke < 0.05) ke = 0; 
            let v = (ke > 0) ? Math.sqrt(ke * 2 / m) : 0;
            
            updateUI(h, v, pe, ke, E_total);
        }

        // --- (新增) 綁定 7 個角度按鈕事件 ---
        document.getElementById('btn-a-l-85').addEventListener('click', () => setPreviewStateAngle(-85, 0));
        document.getElementById('btn-a-l-60').addEventListener('click', () => setPreviewStateAngle(-60, 1));
        document.getElementById('btn-a-l-30').addEventListener('click', () => setPreviewStateAngle(-30, 2));
        document.getElementById('btn-a-c-0').addEventListener('click', () => setPreviewStateAngle(0, 3));
        document.getElementById('btn-a-r-30').addEventListener('click', () => setPreviewStateAngle(30, 4));
        document.getElementById('btn-a-r-60').addEventListener('click', () => setPreviewStateAngle(60, 5));
        document.getElementById('btn-a-r-85').addEventListener('click', () => setPreviewStateAngle(85, 6));

        // --- (新增) 綁定 11 個高度按鈕事件 ---
        document.getElementById('btn-h-l-10').addEventListener('click', () => setPreviewStateHeight(10, 0));
        document.getElementById('btn-h-l-7').addEventListener('click', () => setPreviewStateHeight(7, 1));
        document.getElementById('btn-h-l-5').addEventListener('click', () => setPreviewStateHeight(5, 2));
        document.getElementById('btn-h-l-3').addEventListener('click', () => setPreviewStateHeight(3, 3));
        document.getElementById('btn-h-l-1').addEventListener('click', () => setPreviewStateHeight(1, 4));
        document.getElementById('btn-h-c-0').addEventListener('click', () => setPreviewStateHeight(0, 5));
        document.getElementById('btn-h-r-2').addEventListener('click', () => setPreviewStateHeight(2, 6));
        document.getElementById('btn-h-r-4').addEventListener('click', () => setPreviewStateHeight(4, 7));
        document.getElementById('btn-h-r-6').addEventListener('click', () => setPreviewStateHeight(6, 8));
        document.getElementById('btn-h-r-8').addEventListener('click', () => setPreviewStateHeight(8, 9));
        document.getElementById('btn-h-r-10').addEventListener('click', () => setPreviewStateHeight(10, 10));


        // --- 綁定播放控制事件 ---
        btnPlay.addEventListener('click', () => {
            if (isStepping) {
                stepForward();
            } else {
                playContinuous();
            }
        });

        btnPause.addEventListener('click', pauseContinuous);
        btnStop.addEventListener('click', stopSimulation);

        // (修改) 使用輔助函數來切換樣式
        btnModeContinuous.addEventListener('click', () => {
            isStepping = false;
            setButtonActive(btnModeContinuous);
            setButtonInactive(btnModeStep);
            
            if (simulationState === 'paused') playText.textContent = "繼續";
            else if (simulationState === 'running') playText.textContent = "播放";
            else playText.textContent = "開始";
        });

        // (修改) 使用輔助函數來切換樣式
        btnModeStep.addEventListener('click', () => {
            isStepping = true;
            setButtonActive(btnModeStep);
            setButtonInactive(btnModeContinuous);

            playText.textContent = "下一步";
            if (simulationState === 'running') pauseContinuous();
        });

        // --- (新增) 綁定模式切換事件 ---
        // (修改) 使用輔助函數來切換樣式
        btnModeAngle.addEventListener('click', () => {
            currentMode = 'angle';
            setButtonActive(btnModeAngle);
            setButtonInactive(btnModeHeight);

            angleButtonsDiv.classList.remove('hidden');
            angleButtonsDiv.classList.add('flex');
            heightButtonsDiv.classList.add('hidden');
            heightButtonsDiv.classList.remove('flex');

            positionTitle.textContent = "設定起始位置 (角度)";
            stopSimulation(); // 重置
        });

        // (修改) 使用輔助函數來切換樣式
        btnModeHeight.addEventListener('click', () => {
            currentMode = 'height';
            setButtonActive(btnModeHeight);
            setButtonInactive(btnModeAngle);

            heightButtonsDiv.classList.remove('hidden');
            heightButtonsDiv.classList.add('flex');
            angleButtonsDiv.classList.add('hidden');
            angleButtonsDiv.classList.remove('flex');

            positionTitle.textContent = "設定起始位置 (高度)";
            stopSimulation(); // 重置
        });


        // 延遲執行，確保畫布尺寸正確
        setTimeout(() => {
            resizeCanvas(); // 初始設定
            // 預設啟動高度模式
            btnModeHeight.click();
            // 預設啟動連續擺動模式 (不再需要，因為 HTML 已有預設)
            // btnModeContinuous.click(); 
        }, 0);
    </script>
</body>
</html>

