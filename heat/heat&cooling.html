<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©è³ªä¸‰æ…‹è®ŠåŒ–è™›æ“¬å¯¦é©—å®¤</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; height: 100vh; overflow-y: auto; }
        
        /* ç°½åæ¨£å¼ - æ›´æ–°ç‰ˆ */
        .designer-signature {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 0.85rem; /* ç¨å¾®ç¸®å°å­—é«”ä»¥é˜²é®æ“‹ */
            color: #7f8c8d;
            font-weight: bold;
            font-style: italic;
            z-index: 1000;
            font-family: 'Georgia', serif;
            pointer-events: none; /* é¿å…æ“‹ä½é»æ“Š */
            text-align: right;    /* æ–‡å­—é å³å°é½Š */
            line-height: 1.4;     /* èª¿æ•´è¡Œè· */
        }
        
        .container { position: relative; max-width: 1200px; margin: 20px auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; /* Hidden by default */ }
        .container.active { display: block; animation: fadeIn 0.5s; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        
        /* Menu Styles */
        #menu-screen { 
            position: relative; /* For absolute positioning of signature */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 80vh; 
            text-align: center;
        }
        .menu-title { font-size: 3em; margin-bottom: 10px; color: #2c3e50; }
        .menu-subtitle { font-size: 1.2em; color: #7f8c8d; margin-bottom: 50px; }
        .card-container { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }
        
        .menu-card {
            background: white;
            width: 300px;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }
        .menu-card:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        
        .card-heat { border-bottom: 5px solid #e74c3c; }
        .card-heat:hover { border-color: #e74c3c; }
        .card-cool { border-bottom: 5px solid #3498db; }
        .card-cool:hover { border-color: #3498db; }

        .icon { font-size: 5em; margin-bottom: 20px; display: block; }
        .card-title { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; display: block; }
        .card-desc { color: #666; font-size: 0.95em; }

        /* Simulation Layout */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .back-btn { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { background: #7f8c8d; }

        .main-display { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: flex-start; }
        .canvas-box { position: relative; border: 2px solid #ddd; border-radius: 10px; overflow: hidden; background: #fafafa; width: 350px; height: 350px; }
        canvas { display: block; width: 100%; height: 100%; }
        .label { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 5px; font-weight: bold; border: 1px solid #ccc; font-size: 14px; z-index: 10;}

        /* Controls */
        .controls { margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 10px; text-align: center; }
        .control-row { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
        
        input[type=range] { flex-grow: 1; max-width: 600px; cursor: pointer; height: 8px; border-radius: 5px; background: #d3d3d3; outline: none; -webkit-appearance: none; }
        
        /* Heating Theme */
        .heating-theme input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: #e74c3c; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .heating-theme .btn-play { background-color: #27ae60; color: white; }
        .heating-theme .btn-play:hover { background-color: #219150; }
        .heating-theme .highlight { color: #e74c3c; }
        .heating-theme .info-box { border-left-color: #e74c3c; }

        /* Cooling Theme */
        .cooling-theme input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: #3498db; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .cooling-theme .btn-play { background-color: #3498db; color: white; }
        .cooling-theme .btn-play:hover { background-color: #2980b9; }
        .cooling-theme .highlight { color: #3498db; }
        .cooling-theme .info-box { border-left-color: #3498db; }

        button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        .btn-pause { background-color: #e67e22 !important; color: white; }
        .btn-reset { background-color: #95a5a6; color: white; }

        .status-panel { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; }
        .info-box { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .highlight { font-weight: bold; font-size: 1.1em; }
        .rope-status { color: #8e44ad; font-weight: bold; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .phase-changing { animation: pulse 2s infinite; border-left-color: #f1c40f !important; }
    </style>
</head>
<body>

<!-- Menu Screen -->
<div id="menu-screen">
    <!-- ç°½åæ¨™è¨» (æ›´æ–°) -->
    <div class="designer-signature">&lt;Designed by é»ƒéˆºå¿ƒ,<br>Gemini Canvasè¼”åŠ©ç”Ÿæˆ&gt;</div>

    <div class="menu-title">ç‰©è³ªä¸‰æ…‹è®ŠåŒ–è™›æ“¬å¯¦é©—å®¤</div>
    <div class="menu-subtitle">è«‹é¸æ“‡æ‚¨æƒ³é€²è¡Œçš„å¯¦é©—æ¨¡å¼</div>
    
    <div class="card-container">
        <div class="menu-card card-heat" onclick="App.startHeating()">
            <span class="icon">ğŸ”¥</span>
            <span class="card-title">åŠ ç†±æ¨¡å¼</span>
            <span class="card-desc">è§€å¯Ÿç‰©è³ªå—ç†±å¾Œçš„è®ŠåŒ–<br>å›ºé«” â¡ æ¶²é«” â¡ æ°£é«”</span>
        </div>
        
        <div class="menu-card card-cool" onclick="App.startCooling()">
            <span class="icon">â„ï¸</span>
            <span class="card-title">å†·å»æ¨¡å¼</span>
            <span class="card-desc">è§€å¯Ÿç‰©è³ªæ”¾ç†±å¾Œçš„è®ŠåŒ–<br>æ°£é«” â¡ æ¶²é«” â¡ å›ºé«”</span>
        </div>
    </div>
</div>

<!-- Heating Simulation Container -->
<div id="heating-app" class="container heating-theme">
    <!-- ç°½åæ¨™è¨» (æ›´æ–°) -->
    <div class="designer-signature">&lt;Designed by é»ƒéˆºå¿ƒ,<br>Gemini Canvasè¼”åŠ©ç”Ÿæˆ&gt;</div>

    <div class="top-bar">
        <button class="back-btn" onclick="App.goHome()">ğŸ  è¿”å›ä¸»é¸å–®</button>
        <h2>ğŸ”¥ ç‰©è³ªå—ç†±ï¼šå¾å›ºé«”åˆ°æ°£é«”çš„æ—…ç¨‹</h2>
        <div style="width: 100px;"></div> <!-- Spacer -->
    </div>

    <div class="main-display">
        <div class="canvas-box">
            <canvas id="h-particleCanvas" width="350" height="350"></canvas>
            <div class="label">å¾®è§€ï¼šç²’å­é‹å‹•</div>
        </div>
        <div class="canvas-box">
            <canvas id="h-macroCanvas" width="350" height="350"></canvas>
            <div class="label">å·¨è§€ï¼šç‰©è³ªç‹€æ…‹</div>
        </div>
        <div class="canvas-box">
            <canvas id="h-graphCanvas" width="350" height="350"></canvas>
            <div class="label">åŠ ç†±æ›²ç·šåœ–</div>
        </div>
    </div>

    <div class="controls">
        <div class="control-row">
            <button id="h-playBtn" class="btn-play">â–¶ é–‹å§‹è‡ªå‹•åŠ ç†±</button>
            <button id="h-resetBtn" class="btn-reset">â†º é‡ç½®</button>
        </div>
        <div class="control-row">
            <span>ä½æº« (-20Â°C)</span>
            <input type="range" id="h-heatSlider" min="0" max="1000" value="0">
            <span>é«˜æº« (>200Â°C)</span>
        </div>
        <div class="status-panel">
            <div class="info-box">
                <p>ç›®å‰æº«åº¦ï¼š<span id="h-tempValue" class="highlight">-20</span> Â°C</p>
                <p>ç‰©è³ªç‹€æ…‹ï¼š<span id="h-stateValue">å›ºé«”</span></p>
                <p>åŠ ç†±é€²åº¦ï¼š<span id="h-progressValue">0</span> / 1000</p>
            </div>
            <div class="info-box" id="h-descBox">
                <p>ç²’å­è¡Œç‚ºï¼š<span id="h-behaviorValue">...</span></p>
                <p>ç¹©å­ç‹€æ…‹ï¼š<span id="h-ropeValue" class="rope-status">...</span></p>
            </div>
        </div>
    </div>
</div>

<!-- Cooling Simulation Container -->
<div id="cooling-app" class="container cooling-theme">
    <!-- ç°½åæ¨™è¨» (æ›´æ–°) -->
    <div class="designer-signature">&lt;Designed by é»ƒéˆºå¿ƒ,<br>Gemini Canvasè¼”åŠ©ç”Ÿæˆ&gt;</div>

    <div class="top-bar">
        <button class="back-btn" onclick="App.goHome()">ğŸ  è¿”å›ä¸»é¸å–®</button>
        <h2>â„ï¸ ç‰©è³ªå†·å»ï¼šå¾æ°£é«”åˆ°å›ºé«”çš„æ—…ç¨‹</h2>
        <div style="width: 100px;"></div>
    </div>

    <div class="main-display">
        <div class="canvas-box">
            <canvas id="c-particleCanvas" width="350" height="350"></canvas>
            <div class="label">å¾®è§€ï¼šç²’å­é‹å‹•</div>
        </div>
        <div class="canvas-box">
            <canvas id="c-macroCanvas" width="350" height="350"></canvas>
            <div class="label">å·¨è§€ï¼šç‰©è³ªç‹€æ…‹</div>
        </div>
        <div class="canvas-box">
            <canvas id="c-graphCanvas" width="350" height="350"></canvas>
            <div class="label">å†·å»æ›²ç·šåœ–</div>
        </div>
    </div>

    <div class="controls">
        <div class="control-row">
            <button id="c-playBtn" class="btn-play">â–¶ é–‹å§‹è‡ªå‹•å†·å»</button>
            <button id="c-resetBtn" class="btn-reset">â†º é‡ç½®</button>
        </div>
        <div class="control-row">
            <span>é«˜æº« (>200Â°C)</span>
            <input type="range" id="c-heatSlider" min="0" max="1000" value="0">
            <span>ä½æº« (-20Â°C)</span>
        </div>
        <div class="status-panel">
            <div class="info-box">
                <p>ç›®å‰æº«åº¦ï¼š<span id="c-tempValue" class="highlight">250</span> Â°C</p>
                <p>ç‰©è³ªç‹€æ…‹ï¼š<span id="c-stateValue">æ°£é«”</span></p>
                <p>å†·å»é€²åº¦ï¼š<span id="c-progressValue">0</span> / 1000</p>
            </div>
            <div class="info-box" id="c-descBox">
                <p>ç²’å­è¡Œç‚ºï¼š<span id="c-behaviorValue">...</span></p>
                <p>ç¹©å­ç‹€æ…‹ï¼š<span id="c-ropeValue" class="rope-status">...</span></p>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Main Application Logic
 */
const App = {
    currentAnim: null,

    startHeating: function() {
        this.stopAll();
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('heating-app').classList.add('active');
        HeatingLab.init();
    },

    startCooling: function() {
        this.stopAll();
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('cooling-app').classList.add('active');
        CoolingLab.init();
    },

    goHome: function() {
        this.stopAll();
        document.getElementById('heating-app').classList.remove('active');
        document.getElementById('cooling-app').classList.remove('active');
        document.getElementById('menu-screen').style.display = 'flex';
    },

    stopAll: function() {
        if (this.currentAnim) cancelAnimationFrame(this.currentAnim);
        HeatingLab.isPlaying = false;
        CoolingLab.isPlaying = false;
    }
};

/**
 * HEATING LAB LOGIC
 */
const HeatingLab = {
    canvas: null, ctx: null, gCanvas: null, gCtx: null, mCanvas: null, mCtx: null,
    slider: null, playBtn: null, resetBtn: null, ui: {},
    time: 0, temperature: -20, particles: [], isPlaying: false, frameCount: 0,
    NUM_PARTICLES: 64, COLS: 8, P_RADIUS: 5,

    init: function() {
        this.canvas = document.getElementById('h-particleCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.gCanvas = document.getElementById('h-graphCanvas');
        this.gCtx = this.gCanvas.getContext('2d');
        this.mCanvas = document.getElementById('h-macroCanvas');
        this.mCtx = this.mCanvas.getContext('2d');
        
        this.slider = document.getElementById('h-heatSlider');
        this.playBtn = document.getElementById('h-playBtn');
        this.resetBtn = document.getElementById('h-resetBtn');
        
        this.ui = {
            temp: document.getElementById('h-tempValue'),
            state: document.getElementById('h-stateValue'),
            behavior: document.getElementById('h-behaviorValue'),
            rope: document.getElementById('h-ropeValue'),
            progress: document.getElementById('h-progressValue'),
            descBox: document.getElementById('h-descBox')
        };

        this.playBtn.onclick = () => this.togglePlay();
        this.resetBtn.onclick = () => this.reset();
        this.slider.oninput = () => { if(this.isPlaying) this.togglePlay(); };

        this.reset();
        this.animate();
    },

    reset: function() {
        this.isPlaying = false;
        this.playBtn.textContent = "â–¶ é–‹å§‹è‡ªå‹•åŠ ç†±";
        this.playBtn.className = "btn-play";
        this.slider.value = 0;
        this.time = 0;
        this.frameCount = 0;
        this.initParticles();
    },

    togglePlay: function() {
        this.isPlaying = !this.isPlaying;
        if (this.isPlaying) {
            this.playBtn.textContent = "â¸ æš«åœåŠ ç†±";
            this.playBtn.className = "btn-pause";
        } else {
            this.playBtn.textContent = "â–¶ ç¹¼çºŒè‡ªå‹•åŠ ç†±";
            this.playBtn.className = "btn-play";
        }
    },

    initParticles: function() {
        this.particles = [];
        let offsetX = (350 - (this.COLS * 20)) / 2; 
        let offsetY = (350 - (this.COLS * 20)) / 2;

        for(let i=0; i<this.NUM_PARTICLES; i++) {
            let r = Math.floor(i / this.COLS);
            let c = i % this.COLS;
            this.particles.push({
                x: offsetX + c * 20, y: offsetY + r * 20,
                baseX: offsetX + c * 20, baseY: offsetY + r * 20,
                vx: 0, vy: 0,
                phaseOffset: Math.random() * Math.PI * 2,
                meltStartAt: 200 + Math.random() * 200
            });
        }
    },

    updatePhysics: function(t) {
        let state = "", ropeStatus = "", behavior = "";
        let isPhaseChange = false;

        if (t <= 200) {
            state = "å›ºé«”";
            this.temperature = -20 + (t / 200) * 50; 
            ropeStatus = "ç¹©å­å¾ˆçŸ­ä¸”ç·Šç¹ƒï¼Œç¶ä½æ‰€æœ‰ç²’å­ã€‚";
            behavior = "ç²’å­åœ¨æ™¶æ ¼å…§éœ‡å‹•ï¼Œå‹•èƒ½å¢åŠ ã€‚";
        } else if (t <= 400) {
            state = "å›ºæ¶²å…±å­˜ (ç†”åŒ–ä¸­)";
            this.temperature = 30;
            isPhaseChange = true;
            ropeStatus = "éƒ¨åˆ†ç¹©å­è¢«æ‹‰é•·ï¼Œéƒ¨åˆ†ç²’å­é–‹å§‹è„«é›¢æŸç¸›ã€‚";
            behavior = "å›ºé«”çµæ§‹é€æ¼¸å´©è§£ï¼Œç²’å­ä¸€é¡†ä¸€é¡†è®Šè‡ªç”±ã€‚";
        } else if (t <= 700) {
            state = "æ¶²é«”";
            this.temperature = 30 + ((t - 400) / 300) * 170; 
            ropeStatus = "ç¹©å­å¾ˆé¬†ï¼Œç²’å­é–“æœ‰å¼±é€£çµï¼Œå½¢æˆæµé«”ã€‚";
            behavior = "ç²’å­è‡ªç”±æ»‘å‹•ã€æµè½‰ï¼Œå‘ˆç¾æ¶²æ…‹ã€‚";
        } else if (t <= 900) {
            state = "æ¶²æ°£å…±å­˜ (æ±½åŒ–ä¸­)";
            this.temperature = 200;
            isPhaseChange = true;
            ropeStatus = "èƒ½é‡æ­£åœ¨å‰ªæ–·ç¹©å­ï¼ç²’å­é£›å‡ºï¼";
            behavior = "åŠ‡çƒˆæ²¸é¨°ï¼Œç²’å­è„«é›¢æ¶²é«”è¡¨é¢é£›å‘ç©ºé–“ã€‚";
        } else {
            state = "æ°£é«”";
            this.temperature = 200 + ((t - 900) / 100) * 50; 
            ropeStatus = "ç¹©å­å…¨æ–·äº†ï¼ç„¡æŸç¸›ã€‚";
            behavior = "ç²’å­é«˜é€Ÿè‡ªç”±é£›æ•£ï¼Œå……æ»¿æ•´å€‹ç©ºé–“ã€‚";
        }

        this.ui.temp.innerText = Math.round(this.temperature);
        this.ui.state.innerText = state;
        this.ui.rope.innerText = ropeStatus;
        this.ui.behavior.innerText = behavior;
        this.ui.progress.innerText = t;
        
        if(isPhaseChange) this.ui.descBox.classList.add('phase-changing');
        else this.ui.descBox.classList.remove('phase-changing');

        return state;
    },

    drawParticles: function(stateVal) {
        this.ctx.clearRect(0, 0, 350, 350);
        let speedFactor = (this.temperature + 40) / 50; 
        const centerX = 175, centerY = 175;

        this.particles.forEach((p, index) => {
            let isMeltingPhase = (this.time >= 200 && this.time <= 400);
            let isParticleLiquid = (this.time > 400) || (isMeltingPhase && this.time >= p.meltStartAt);
            
            if (!isParticleLiquid) {
                let tempForVib = isMeltingPhase ? 30 : this.temperature;
                let vibration = (tempForVib + 30) / 50 * 1.5; 
                p.x = p.baseX + Math.sin(Date.now()/50 + p.phaseOffset) * vibration;
                p.y = p.baseY + Math.cos(Date.now()/50 + p.phaseOffset) * vibration;
            } else {
                if (stateVal.includes("æ±½åŒ–") || stateVal === "æ°£é«”") {
                    let boilRatio = (this.time - 700) / 200;
                    let isGas = stateVal === "æ°£é«”";
                    let isFreeGas = isGas || (Math.random() < boilRatio * 0.05);

                    if (isFreeGas || (Math.abs(p.vx) > 1 || Math.abs(p.vy) > 1)) {
                         if (Math.abs(p.vx) < 1) { 
                             let angle = Math.random() * Math.PI * 2;
                             p.vx = Math.cos(angle) * 5;
                             p.vy = Math.sin(angle) * 5;
                         }
                         p.x += p.vx; p.y += p.vy;
                         if(p.x < 5) { p.x = 5; p.vx *= -1; }
                         if(p.x > 345) { p.x = 345; p.vx *= -1; }
                         if(p.y < 5) { p.y = 5; p.vy *= -1; }
                         if(p.y > 345) { p.y = 345; p.vy *= -1; }
                    } else {
                        this.applyLiquidMotion(p, speedFactor, centerX, centerY);
                    }
                } else {
                    this.applyLiquidMotion(p, speedFactor, centerX, centerY);
                }
            }

            this.ctx.beginPath();
            this.ctx.fillStyle = this.getParticleColor(this.temperature);
            this.ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
            this.ctx.fill();
            this.drawRopes(p, index, isParticleLiquid);
        });
    },

    applyLiquidMotion: function(p, speedFactor, centerX, centerY) {
        p.x += (Math.random() - 0.5) * speedFactor * 1.5;
        p.y += (Math.random() - 0.5) * speedFactor * 1.5;
        let dx = p.x - centerX, dy = p.y - centerY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 110) { p.x -= (dx / dist); p.y -= (dy / dist); }
    },

    drawRopes: function(p, index, isSourceLiquid) {
        if (this.time > 900) return; 
        let neighbors = [index + 1, index + 8];
        neighbors.forEach(nIdx => {
            if (nIdx >= 0 && nIdx < this.particles.length) {
                let neighbor = this.particles[nIdx];
                let isMelting = (this.time >= 200 && this.time <= 400);
                let isNeighborLiquid = (this.time > 400) || (isMelting && this.time >= neighbor.meltStartAt);
                let dist = Math.sqrt(Math.pow(p.x - neighbor.x, 2) + Math.pow(p.y - neighbor.y, 2));
                
                let type = "loose", limit = 50;
                if (!isSourceLiquid && !isNeighborLiquid) { type = "tight"; limit = 30; }
                else if (isSourceLiquid !== isNeighborLiquid) { type = "stretching"; limit = 45; }
                if (this.temperature >= 200) limit = 60;

                if (dist < limit) {
                    this.ctx.beginPath();
                    this.ctx.strokeStyle = "#8e44ad"; 
                    this.ctx.lineWidth = (type === "tight") ? 2 : 1;
                    if(type === "stretching") this.ctx.setLineDash([3, 3]); else this.ctx.setLineDash([]);
                    this.ctx.moveTo(p.x, p.y); this.ctx.lineTo(neighbor.x, neighbor.y);
                    this.ctx.stroke();
                }
            }
        });
    },

    getParticleColor: function(temp) {
        if (temp < 0) return "#3498db"; 
        if (temp < 100) return "#9b59b6"; 
        return "#e74c3c"; 
    },

    drawMacro: function() {
        this.mCtx.clearRect(0, 0, 350, 350);
        this.mCtx.strokeStyle = "#555"; this.mCtx.lineWidth = 4;
        this.mCtx.beginPath(); this.mCtx.moveTo(75, 50); this.mCtx.lineTo(75, 300); this.mCtx.lineTo(275, 300); this.mCtx.lineTo(275, 50); this.mCtx.stroke();
        
        if (this.time > 0 && this.time < 1000) {
            this.mCtx.fillStyle = "orange";
            this.mCtx.beginPath(); this.mCtx.moveTo(150, 310); this.mCtx.lineTo(200, 310); this.mCtx.lineTo(175 + Math.random()*5, 340); this.mCtx.fill();
        }

        if (this.time <= 200) {
            this.mCtx.fillStyle = "#3498db"; this.mCtx.fillRect(125, 200, 100, 100);
        } else if (this.time <= 400) {
            let meltRatio = (this.time - 200) / 200;
            this.mCtx.fillStyle = "rgba(52, 152, 219, 0.6)"; this.mCtx.fillRect(77, 300 - 30*meltRatio, 196, 30*meltRatio);
            let size = 100 * (1 - meltRatio * 0.8);
            this.mCtx.fillStyle = "#3498db"; this.mCtx.fillRect(125 + (100-size)/2, 300 - 30*meltRatio - size, size, size);
        } else if (this.time <= 700) {
            this.mCtx.fillStyle = "rgba(52, 152, 219, 0.8)"; this.mCtx.fillRect(77, 250, 196, 50);
            this.mCtx.strokeStyle = "rgba(255,255,255,0.5)"; this.mCtx.beginPath(); this.mCtx.moveTo(80, 250);
            this.mCtx.bezierCurveTo(130, 245 + Math.sin(Date.now()/200)*5, 220, 255 - Math.sin(Date.now()/200)*5, 270, 250); this.mCtx.stroke();
        } else if (this.time <= 900) {
            let boilRatio = (this.time - 700) / 200;
            let currentWaterLevel = 50*(1-boilRatio);
            this.mCtx.fillStyle = "rgba(52, 152, 219, 0.8)"; this.mCtx.fillRect(77, 300 - currentWaterLevel, 196, currentWaterLevel);
            
            for(let i=0; i<5; i++) {
                if(Math.random() > 0.5) {
                    this.mCtx.beginPath();
                    this.mCtx.arc(100 + Math.random()*150, 300 - Math.random()*currentWaterLevel, 4, 0, Math.PI*2);
                    this.mCtx.strokeStyle = "rgba(255, 255, 255, 0.8)";
                    this.mCtx.stroke();
                }
            }

            this.mCtx.fillStyle = `rgba(200, 200, 200, ${boilRatio * 0.5})`; this.mCtx.fillRect(77, 50, 196, 250);

            let particleCount = Math.floor(20 * boilRatio);
            this.mCtx.fillStyle = "rgba(255,255,255,0.5)";
            for(let i=0; i<particleCount; i++) {
                this.mCtx.beginPath();
                this.mCtx.arc(80 + Math.random()*190, 60 + Math.random()*230, 3, 0, Math.PI*2);
                this.mCtx.fill();
            }

        } else {
            this.mCtx.fillStyle = "rgba(200, 200, 200, 0.6)"; this.mCtx.fillRect(77, 50, 196, 250);
            for(let i=0; i<20; i++) {
                this.mCtx.fillStyle = "rgba(255,255,255,0.5)";
                this.mCtx.beginPath();
                this.mCtx.arc(80 + Math.random()*190, 60 + Math.random()*230, 3, 0, Math.PI*2);
                this.mCtx.fill();
            }
        }
    },

    drawGraph: function() {
        this.gCtx.clearRect(0, 0, 350, 350);
        this.gCtx.strokeStyle = "#eee"; this.gCtx.lineWidth = 1; this.gCtx.beginPath();
        for(let i=0; i<350; i+=35) { this.gCtx.moveTo(0, i); this.gCtx.lineTo(350, i); this.gCtx.moveTo(i, 0); this.gCtx.lineTo(i, 350); }
        this.gCtx.stroke();
        this.gCtx.beginPath(); this.gCtx.moveTo(40, 310); this.gCtx.lineTo(330, 310); this.gCtx.moveTo(40, 310); this.gCtx.lineTo(40, 20); this.gCtx.strokeStyle = "#333"; this.gCtx.lineWidth = 2; this.gCtx.stroke();
        
        this.gCtx.font = "12px Arial"; this.gCtx.fillStyle = "#666";
        this.gCtx.fillText("200", 10, 100); this.gCtx.fillText("30", 15, 230); this.gCtx.fillText("-20", 10, 300);

        const getY = (temp) => {
            if(temp > 200) return 100 - ((temp - 200) / 50) * 50;
            if(temp > 30) return 230 - ((temp - 30) / 170) * 130;
            return 300 - ((temp + 20) / 50) * 70;
        };
        const getX = (t) => 40 + (t / 1000) * 290;

        this.gCtx.beginPath(); this.gCtx.strokeStyle = "#e74c3c"; this.gCtx.lineWidth = 3;
        this.gCtx.moveTo(getX(0), getY(-20));
        let segments = [{end:200,s:-20,e:30},{end:400,s:30,e:30},{end:700,s:30,e:200},{end:900,s:200,e:200},{end:1000,s:200,e:250}];
        let lastT = 0;
        segments.forEach(seg => {
            if (this.time > lastT) {
                let targetT = Math.min(this.time, seg.end);
                let ratio = (targetT - lastT) / (seg.end - lastT);
                let curTemp = seg.s + (seg.e - seg.s) * ratio;
                if(targetT > lastT) this.gCtx.lineTo(getX(targetT), getY(curTemp));
                lastT = seg.end;
            }
        });
        this.gCtx.stroke();
        if (this.time >= 0) {
            this.gCtx.fillStyle = "#2c3e50"; this.gCtx.beginPath();
            this.gCtx.arc(getX(this.time), getY(this.temperature), 6, 0, Math.PI*2); this.gCtx.fill();
        }
    },

    animate: function() {
        if (this.isPlaying) {
            this.frameCount++;
            if (this.frameCount % 2 === 0) {
                let val = parseInt(this.slider.value);
                if (val < 1000) { this.slider.value = val + 1; this.time = val + 1; }
                else { this.isPlaying = false; this.playBtn.textContent = "â–¶ é‡æ–°é–‹å§‹"; this.playBtn.className = "btn-play"; }
            }
        } else {
            this.time = parseInt(this.slider.value);
        }
        let state = this.updatePhysics(this.time);
        this.drawParticles(state);
        this.drawMacro();
        this.drawGraph();
        App.currentAnim = requestAnimationFrame(() => this.animate());
    }
};

/**
 * COOLING LAB LOGIC
 */
const CoolingLab = {
    canvas: null, ctx: null, gCanvas: null, gCtx: null, mCanvas: null, mCtx: null,
    slider: null, playBtn: null, resetBtn: null, ui: {},
    time: 0, temperature: 250, particles: [], isPlaying: false, frameCount: 0,
    NUM_PARTICLES: 64, COLS: 8, P_RADIUS: 5,

    init: function() {
        this.canvas = document.getElementById('c-particleCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.gCanvas = document.getElementById('c-graphCanvas');
        this.gCtx = this.gCanvas.getContext('2d');
        this.mCanvas = document.getElementById('c-macroCanvas');
        this.mCtx = this.mCanvas.getContext('2d');
        
        this.slider = document.getElementById('c-heatSlider');
        this.playBtn = document.getElementById('c-playBtn');
        this.resetBtn = document.getElementById('c-resetBtn');
        
        this.ui = {
            temp: document.getElementById('c-tempValue'),
            state: document.getElementById('c-stateValue'),
            behavior: document.getElementById('c-behaviorValue'),
            rope: document.getElementById('c-ropeValue'),
            progress: document.getElementById('c-progressValue'),
            descBox: document.getElementById('c-descBox')
        };

        this.playBtn.onclick = () => this.togglePlay();
        this.resetBtn.onclick = () => this.reset();
        this.slider.oninput = () => { if(this.isPlaying) this.togglePlay(); };

        this.reset();
        this.animate();
    },

    reset: function() {
        this.isPlaying = false;
        this.playBtn.textContent = "â–¶ é–‹å§‹è‡ªå‹•å†·å»";
        this.playBtn.className = "btn-play";
        this.slider.value = 0;
        this.time = 0;
        this.frameCount = 0;
        this.initParticles();
    },

    togglePlay: function() {
        this.isPlaying = !this.isPlaying;
        if (this.isPlaying) {
            this.playBtn.textContent = "â¸ æš«åœå†·å»";
            this.playBtn.className = "btn-pause";
        } else {
            this.playBtn.textContent = "â–¶ ç¹¼çºŒè‡ªå‹•å†·å»";
            this.playBtn.className = "btn-play";
        }
    },

    initParticles: function() {
        this.particles = [];
        let offsetX = (350 - (this.COLS * 20)) / 2; 
        let offsetY = (350 - (this.COLS * 20)) / 2;

        for(let i=0; i<this.NUM_PARTICLES; i++) {
            let r = Math.floor(i / this.COLS);
            let c = i % this.COLS;
            
            let startX = Math.random() * 330 + 10;
            let startY = Math.random() * 330 + 10;
            
            this.particles.push({
                x: startX, y: startY,
                vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10,
                targetX: offsetX + c * 20, targetY: offsetY + r * 20,
                phaseOffset: Math.random() * Math.PI * 2,
                freezeStartAt: 600 + Math.random() * 200
            });
        }
    },

    updatePhysics: function(t) {
        let state = "", ropeStatus = "", behavior = "";
        let isPhaseChange = false;

        if (t <= 100) {
            state = "æ°£é«”";
            this.temperature = 250 - (t / 100) * 50; 
            ropeStatus = "å®Œå…¨æ²’æœ‰ç¹©å­ï¼Œç²’å­é–“ç„¡é€£çµã€‚";
            behavior = "ç²’å­é«˜é€Ÿè‡ªç”±é£›è¡Œï¼Œäº’ç›¸ç¢°æ’ã€‚";
        } else if (t <= 300) {
            state = "æ¶²æ°£å…±å­˜ (å‡çµä¸­)";
            this.temperature = 200;
            isPhaseChange = true;
            ropeStatus = "ç²’å­è®Šæ…¢ï¼Œç¹©å­é–‹å§‹é‡æ–°é€£çµï¼";
            behavior = "æ°£é«”ç²’å­å¤±å»å‹•èƒ½ï¼Œèšé›†æˆæ¶²æ»´ã€‚";
        } else if (t <= 600) {
            state = "æ¶²é«”";
            this.temperature = 200 - ((t - 300) / 300) * 170; 
            ropeStatus = "ç¹©å­é›–ç„¶é¬†ï¼Œä½†å°‡ç²’å­æ‹‰åœ¨ä¸€èµ·ã€‚";
            behavior = "ç²’å­èšåœ¨ä¸€èµ·æµå‹•ï¼Œä½†ä¸å›ºå®šä½ç½®ã€‚";
        } else if (t <= 800) {
            state = "å›ºæ¶²å…±å­˜ (å‡å›ºä¸­)";
            this.temperature = 30;
            isPhaseChange = true;
            ropeStatus = "ç¹©å­è®Šç·Šï¼å°‡ç²’å­æ‹‰å›å›ºå®šä½ç½®ã€‚";
            behavior = "ç²’å­é€æ¼¸æ­¸éšŠï¼Œæ’åˆ—æˆæ•´é½Šæ–¹é™£ã€‚";
        } else {
            state = "å›ºé«”";
            this.temperature = 30 - ((t - 800) / 200) * 50; 
            ropeStatus = "ç¹©å­å¾ˆçŸ­ä¸”ç·Šç¹ƒï¼Œç¶ä½æ‰€æœ‰ç²’å­ã€‚";
            behavior = "ç²’å­æ•´é½Šæ’åˆ—ï¼Œåƒ…åœ¨åŸåœ°éœ‡å‹•ã€‚";
        }

        this.ui.temp.innerText = Math.round(this.temperature);
        this.ui.state.innerText = state;
        this.ui.rope.innerText = ropeStatus;
        this.ui.behavior.innerText = behavior;
        this.ui.progress.innerText = t;
        
        if(isPhaseChange) this.ui.descBox.classList.add('phase-changing');
        else this.ui.descBox.classList.remove('phase-changing');

        return state;
    },

    drawParticles: function(stateVal) {
        this.ctx.clearRect(0, 0, 350, 350);
        let speedFactor = (this.temperature + 40) / 50; 
        const centerX = 175, centerY = 175;

        this.particles.forEach((p, index) => {
            let isFreezing = (this.time >= 600 && this.time <= 800);
            let isSolid = (this.time > 800) || (isFreezing && this.time >= p.freezeStartAt);
            
            if (isSolid) {
                let snapSpeed = 0.1;
                p.x += (p.targetX - p.x) * snapSpeed;
                p.y += (p.targetY - p.y) * snapSpeed;
                let vibration = (this.temperature + 30) / 50 * 1.5; 
                let drawX = p.x + Math.sin(Date.now()/50 + p.phaseOffset) * vibration;
                let drawY = p.y + Math.cos(Date.now()/50 + p.phaseOffset) * vibration;
                this.drawDot(drawX, drawY);
            } else {
                if (stateVal === "æ°£é«”" || (stateVal.includes("å‡çµ") && Math.random() > (this.time-100)/200)) {
                    if (Math.abs(p.vx) < 1) { 
                         let angle = Math.random() * Math.PI * 2;
                         p.vx = Math.cos(angle) * 5; p.vy = Math.sin(angle) * 5;
                    }
                    p.x += p.vx; p.y += p.vy;
                    if(p.x < 5) { p.x = 5; p.vx *= -1; }
                    if(p.x > 345) { p.x = 345; p.vx *= -1; }
                    if(p.y < 5) { p.y = 5; p.vy *= -1; }
                    if(p.y > 345) { p.y = 345; p.vy *= -1; }
                    this.drawDot(p.x, p.y);
                } else {
                    p.x += (Math.random() - 0.5) * speedFactor * 1.5;
                    p.y += (Math.random() - 0.5) * speedFactor * 1.5;
                    let dx = p.x - centerX, dy = p.y - centerY;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist > 110) { p.x -= (dx / dist) * 1.5; p.y -= (dy / dist) * 1.5; }
                    this.drawDot(p.x, p.y);
                }
            }
        });
        this.drawRopes();
    },
    
    drawDot: function(x, y) {
        this.ctx.beginPath();
        this.ctx.fillStyle = this.getParticleColor(this.temperature);
        this.ctx.arc(x, y, 5, 0, Math.PI * 2);
        this.ctx.fill();
    },

    drawRopes: function() {
        if (this.time < 100) return; 
        this.ctx.lineWidth = 1;
        for (let i = 0; i < this.particles.length; i++) {
            for (let j = i + 1; j < this.particles.length; j++) {
                let p1 = this.particles[i], p2 = this.particles[j];
                let dist = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
                
                let threshold = 0;
                if (this.time > 800) threshold = 25; 
                else if (this.time > 600) threshold = 35;
                else if (this.time > 100) threshold = 55;
                
                if (dist < threshold) {
                    this.ctx.beginPath();
                    this.ctx.strokeStyle = "#8e44ad";
                    if (this.time > 800) this.ctx.setLineDash([]); else this.ctx.setLineDash([3, 3]);
                    
                    if (this.time < 300) this.ctx.globalAlpha = (this.time - 100) / 200;
                    else this.ctx.globalAlpha = 1;

                    this.ctx.moveTo(p1.x, p1.y); this.ctx.lineTo(p2.x, p2.y);
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1; this.ctx.setLineDash([]);
                }
            }
        }
    },

    getParticleColor: function(temp) {
        if (temp > 100) return "#e74c3c"; 
        if (temp > 0) return "#9b59b6"; 
        return "#3498db"; 
    },

    drawMacro: function() {
        this.mCtx.clearRect(0, 0, 350, 350);
        this.mCtx.strokeStyle = "#555"; this.mCtx.lineWidth = 4;
        this.mCtx.beginPath(); this.mCtx.moveTo(75, 50); this.mCtx.lineTo(75, 300); this.mCtx.lineTo(275, 300); this.mCtx.lineTo(275, 50); this.mCtx.stroke();
        
        if (this.time > 0 && this.time < 1000) {
            this.mCtx.fillStyle = "#3498db"; this.mCtx.font = "14px Arial"; this.mCtx.fillText("â„ï¸ é™æº«å†·å»ä¸­...", 130, 330);
            this.mCtx.fillStyle = "#aed6f1";
            for(let i=0; i<3; i++) this.mCtx.fillText("*", 80 + Math.random() * 200, 310 + Math.random() * 30);
        }

        if (this.time <= 100) {
            this.mCtx.fillStyle = "rgba(200, 200, 200, 0.6)"; this.mCtx.fillRect(77, 50, 196, 250);
            for(let i=0; i<20; i++) {
                this.mCtx.fillStyle = "rgba(255,255,255,0.5)";
                this.mCtx.beginPath();
                this.mCtx.arc(80 + Math.random()*190, 60 + Math.random()*230, 3, 0, Math.PI*2);
                this.mCtx.fill();
            }
        } else if (this.time <= 300) {
            let condRatio = (this.time - 100) / 200;
            this.mCtx.fillStyle = `rgba(200, 200, 200, ${0.6 * (1-condRatio)})`; this.mCtx.fillRect(77, 50, 196, 250);
            this.mCtx.fillStyle = "rgba(52, 152, 219, 0.8)"; this.mCtx.fillRect(77, 300 - 50*condRatio, 196, 50*condRatio);
            
            // Gas particles decreasing (added back)
            let particleCount = Math.floor(20 * (1 - condRatio));
            this.mCtx.fillStyle = "rgba(255,255,255,0.5)";
            for(let i=0; i<particleCount; i++) {
                this.mCtx.beginPath();
                this.mCtx.arc(80 + Math.random()*190, 60 + Math.random()*230, 3, 0, Math.PI*2);
                this.mCtx.fill();
            }

        } else if (this.time <= 600) {
            this.mCtx.fillStyle = "rgba(52, 152, 219, 0.8)"; this.mCtx.fillRect(77, 250, 196, 50); 
        } else if (this.time <= 800) {
            let freezeRatio = (this.time - 600) / 200;
            this.mCtx.fillStyle = "rgba(52, 152, 219, 0.8)"; this.mCtx.fillRect(77, 300 - 50*(1-freezeRatio), 196, 50*(1-freezeRatio));
            let iceSize = 100 * freezeRatio;
            this.mCtx.fillStyle = "#3498db"; this.mCtx.fillRect(175 - iceSize/2, 300 - iceSize, iceSize, iceSize);
        } else {
            this.mCtx.fillStyle = "#3498db"; this.mCtx.fillRect(125, 200, 100, 100); 
            this.mCtx.fillStyle = "rgba(255,255,255,0.3)"; this.mCtx.fillText("â„ï¸", 130, 220);
        }
    },

    drawGraph: function() {
        this.gCtx.clearRect(0, 0, 350, 350);
        this.gCtx.strokeStyle = "#eee"; this.gCtx.lineWidth = 1; this.gCtx.beginPath();
        for(let i=0; i<350; i+=35) { this.gCtx.moveTo(0, i); this.gCtx.lineTo(350, i); this.gCtx.moveTo(i, 0); this.gCtx.lineTo(i, 350); }
        this.gCtx.stroke();
        this.gCtx.beginPath(); this.gCtx.moveTo(40, 310); this.gCtx.lineTo(330, 310); this.gCtx.moveTo(40, 310); this.gCtx.lineTo(40, 20); this.gCtx.strokeStyle = "#333"; this.gCtx.lineWidth = 2; this.gCtx.stroke();
        
        this.gCtx.font = "12px Arial"; this.gCtx.fillStyle = "#666";
        this.gCtx.fillText("250", 10, 50); this.gCtx.fillText("200", 10, 100); this.gCtx.fillText("30", 15, 230); this.gCtx.fillText("-20", 10, 300);

        const getY = (temp) => {
            if(temp > 200) return 100 - ((temp - 200) / 50) * 50;
            if(temp > 30) return 230 - ((temp - 30) / 170) * 130;
            return 300 - ((temp + 20) / 50) * 70;
        };
        const getX = (t) => 40 + (t / 1000) * 290;

        this.gCtx.beginPath(); this.gCtx.strokeStyle = "#3498db"; this.gCtx.lineWidth = 3;
        this.gCtx.moveTo(getX(0), getY(250));
        let segments = [{end:100,s:250,e:200},{end:300,s:200,e:200},{end:600,s:200,e:30},{end:800,s:30,e:30},{end:1000,s:30,e:-20}];
        let lastT = 0;
        segments.forEach(seg => {
            if (this.time > lastT) {
                let targetT = Math.min(this.time, seg.end);
                let ratio = (targetT - lastT) / (seg.end - lastT);
                let curTemp = seg.s + (seg.e - seg.s) * ratio;
                if(targetT > lastT) this.gCtx.lineTo(getX(targetT), getY(curTemp));
                lastT = seg.end;
            }
        });
        this.gCtx.stroke();
        if (this.time >= 0) {
            this.gCtx.fillStyle = "#2c3e50"; this.gCtx.beginPath();
            this.gCtx.arc(getX(this.time), getY(this.temperature), 6, 0, Math.PI*2); this.gCtx.fill();
        }
    },

    animate: function() {
        if (this.isPlaying) {
            this.frameCount++;
            if (this.frameCount % 2 === 0) {
                let val = parseInt(this.slider.value);
                if (val < 1000) { this.slider.value = val + 1; this.time = val + 1; }
                else { this.isPlaying = false; this.playBtn.textContent = "â–¶ é‡æ–°é–‹å§‹"; this.playBtn.className = "btn-play"; }
            }
        } else {
            this.time = parseInt(this.slider.value);
        }
        let state = this.updatePhysics(this.time);
        this.drawParticles(state);
        this.drawMacro();
        this.drawGraph();
        App.currentAnim = requestAnimationFrame(() => this.animate());
    }
};

</script>
</body>
</html>